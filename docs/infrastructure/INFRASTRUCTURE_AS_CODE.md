# Infrastructure as Code - Sunday School App

## Document Version: 1.0
**Creation Date:** 29 December 2025  
**Last Update:** 29 December 2025  
**Project:** Sunday School App  
**Technologies:** AWS Amplify Gen 1, AWS CloudFormation, AWS CLI

---

## 1. Overview

This document defines the **Infrastructure as Code (IaC)** principles and requirements for the Sunday School App project. All infrastructure configuration must be stored in code to ensure consistency, reproducibility, and version control.

### 1.1. Definition

**Infrastructure as Code (IaC)** is the practice of managing and provisioning infrastructure through machine-readable definition files, rather than through manual configuration or interactive configuration tools.

### 1.2. Core Principles

1. **Version Control:** All infrastructure configuration is stored in Git
2. **Reproducibility:** Infrastructure can be recreated from code in any environment
3. **Consistency:** Dev and prod environments are identical (except for environment-specific values)
4. **Traceability:** All changes are tracked through Git commits
5. **Automation:** Infrastructure changes are applied through automated processes

---

## 2. Requirements

### 2.1. Mandatory Requirements

**All infrastructure configuration MUST be stored in code:**

1. ✅ **AWS Amplify Configuration Files:**
   - `amplify/backend/auth/*/cli-inputs.json` - Cognito configuration
   - `amplify/backend/api/*/cli-inputs.json` - AppSync configuration
   - `amplify/backend/backend-config.json` - Overall backend configuration
   - `amplify/team-provider-info.json` - Environment-specific settings

2. ✅ **CloudFormation Templates:**
   - All CloudFormation templates generated by Amplify
   - Custom CloudFormation templates (if any)

3. ✅ **Configuration Files:**
   - `amplifyconfiguration.json` - Frontend configuration
   - Environment variables configuration
   - Build configuration files

### 2.2. Prohibited Practices

**The following practices are PROHIBITED:**

1. ❌ **Manual Changes via AWS Console:**
   - Changing Cognito User Pool settings directly in AWS Console
   - Modifying AppSync API settings via Console
   - Updating DynamoDB table settings manually
   - Changing IAM roles/policies via Console

2. ❌ **Environment-Specific Manual Configuration:**
   - Different settings in dev and prod without code changes
   - Manual hotfixes without updating code
   - Configuration drift between environments

3. ❌ **Undocumented Changes:**
   - Making changes without updating documentation
   - Changes not reflected in version control

### 2.3. Exception Handling

**Exceptions to IaC requirements (must be documented):**

1. **User Data:**
   - User accounts in Cognito (created through application)
   - Data in DynamoDB tables
   - Files in S3 buckets (content, not bucket configuration)

2. **Runtime Configuration:**
   - Environment variables set in Amplify Console (for CI/CD)
   - Secrets stored in AWS Secrets Manager (references in code)

3. **Temporary Changes:**
   - Emergency hotfixes (must be reverted and implemented in code within 24 hours)

---

## 3. Getting Infrastructure Information

### 3.1. Primary Method: Configuration Files

**Always check configuration files first:**

```bash
# Cognito configuration
cat amplify/backend/auth/sunsche716d941/cli-inputs.json

# Backend configuration
cat amplify/backend/backend-config.json

# Environment settings
cat amplify/team-provider-info.json

# Frontend configuration
cat src/amplifyconfiguration.json
```

### 3.2. Secondary Method: AWS CLI

**Use AWS CLI only when configuration files don't contain the information:**

```bash
# Get Cognito User Pool configuration
aws cognito-idp describe-user-pool \
  --user-pool-id <POOL_ID> \
  --region <REGION>

# Get AppSync API configuration
aws appsync get-graphql-api \
  --api-id <API_ID> \
  --region <REGION>

# Get CloudFormation stack outputs
aws cloudformation describe-stacks \
  --stack-name <STACK_NAME> \
  --region <REGION>
```

### 3.3. Documentation Requirements

**When using AWS CLI to get information:**

1. Document the command used
2. Save the output in a structured format
3. Update configuration files if discrepancies are found
4. Update documentation with findings

---

## 4. Configuration Synchronization

### 4.1. Dev and Prod Environments

**Dev and prod environments MUST have identical configuration:**

1. **Identical Settings:**
   - Password policies
   - MFA configuration
   - Email verification settings
   - Token expiration settings
   - Group configurations
   - IAM role policies

2. **Environment-Specific Values (Allowed):**
   - User Pool IDs (auto-generated)
   - AppSync API endpoints (auto-generated)
   - Region (dev: us-east-1, prod: eu-west-1)
   - Resource names (with environment suffix)

### 4.2. Synchronization Process

**When updating configuration:**

1. **Update Configuration Files:**
   ```bash
   # Edit configuration files
   # amplify/backend/auth/*/cli-inputs.json
   # amplify/backend/backend-config.json
   ```

2. **Apply to Dev:**
   ```bash
   amplify env checkout dev
   amplify push
   ```

3. **Verify in Dev:**
   ```bash
   # Check applied configuration
   aws cognito-idp describe-user-pool --user-pool-id <DEV_POOL_ID> --region us-east-1
   ```

4. **Apply to Prod:**
   ```bash
   amplify env checkout prod
   amplify push
   ```

5. **Verify Identical Configuration:**
   ```bash
   # Compare dev and prod configurations
   # Ensure all settings are identical (except auto-generated values)
   ```

### 4.3. Configuration Verification

**After applying changes, verify:**

1. ✅ Configuration files are updated
2. ✅ Changes are applied to both dev and prod
3. ✅ Settings are identical (except environment-specific values)
4. ✅ Documentation is updated
5. ✅ Git commit includes all changes

---

## 5. Cognito Groups Configuration

### 5.1. Challenge

**Amplify Gen 1 CLI does not support creating Cognito Groups directly through `cli-inputs.json`.**

### 5.2. Solution: AWS CLI Scripts

**Create groups using AWS CLI with scripts stored in code:**

```bash
# scripts/create-cognito-groups.sh
#!/bin/bash

USER_POOL_ID=$1
REGION=$2

# Create TEACHER group
aws cognito-idp create-group \
  --user-pool-id $USER_POOL_ID \
  --group-name TEACHER \
  --description "Преподаватели воскресной школы" \
  --precedence 1 \
  --region $REGION

# Create ADMIN group
aws cognito-idp create-group \
  --user-pool-id $USER_POOL_ID \
  --group-name ADMIN \
  --description "Администраторы воскресной школы" \
  --precedence 2 \
  --region $REGION

# Create SUPERADMIN group
aws cognito-idp create-group \
  --user-pool-id $USER_POOL_ID \
  --group-name SUPERADMIN \
  --description "Главные администраторы" \
  --precedence 3 \
  --region $REGION
```

### 5.3. Documentation Requirement

**Document groups configuration:**

1. See [AWS_CLI_SCRIPTS.md](./AWS_CLI_SCRIPTS.md) for:
   - Complete scripts for creating groups (bash and PowerShell)
   - Detailed execution instructions
   - Verification commands
   - Troubleshooting guide
   - List of groups and their precedence

2. Update `amplify/backend/auth/*/cli-inputs.json` with:
   - Comments documenting groups configuration
   - Reference to AWS_CLI_SCRIPTS.md for group creation

---

## 6. Token Configuration

### 6.1. Current Limitations

**Amplify Gen 1 CLI has limited support for token expiration configuration:**

- ✅ Refresh Token expiration: Supported in `cli-inputs.json`
- ❌ ID Token expiration: Not directly supported (uses default: 1 hour)
- ❌ Access Token expiration: Not directly supported (uses default: 1 hour)

### 6.2. Workaround

**For token expiration configuration:**

1. **Document Default Values:**
   - ID Token: 1 hour (default)
   - Access Token: 1 hour (default)
   - Refresh Token: 30 days (configurable)

2. **Use CloudFormation Custom Resources (if needed):**
   - Create custom Lambda function
   - Update token expiration via CloudFormation
   - Document in `docs/infrastructure/COGNITO_TOKENS.md`

3. **Accept Defaults for MVP:**
   - Use default token expiration for MVP
   - Document in configuration files
   - Plan enhancement for post-MVP

---

## 7. Deployment Process

### 7.1. Pre-Deployment Checklist

**Before deploying infrastructure changes:**

- [ ] Configuration files updated
- [ ] Changes tested locally (if possible)
- [ ] Documentation updated
- [ ] Git commit created
- [ ] Code reviewed (if applicable)

### 7.2. Deployment Steps

**Standard deployment process:**

1. **Check Current Environment:**
   ```bash
   amplify env list
   amplify status
   ```

2. **Apply to Dev:**
   ```bash
   amplify env checkout dev
   amplify push
   ```

3. **Verify Dev:**
   ```bash
   # Verify configuration
   aws cognito-idp describe-user-pool --user-pool-id <DEV_POOL_ID> --region us-east-1
   ```

4. **Apply to Prod:**
   ```bash
   amplify env checkout prod
   amplify push
   ```

5. **Verify Prod:**
   ```bash
   # Verify configuration matches dev
   aws cognito-idp describe-user-pool --user-pool-id <PROD_POOL_ID> --region eu-west-1
   ```

### 7.3. Post-Deployment Verification

**After deployment:**

- [ ] Configuration applied successfully
- [ ] Dev and prod settings are identical
- [ ] No errors in CloudFormation stacks
- [ ] Application works correctly
- [ ] Documentation updated

---

## 8. Troubleshooting

### 8.1. Configuration Drift

**If configuration differs between code and AWS:**

1. **Identify Differences:**
   ```bash
   # Get current AWS configuration
   aws cognito-idp describe-user-pool --user-pool-id <POOL_ID> --region <REGION> > current_config.json
   
   # Compare with code
   diff current_config.json expected_config.json
   ```

2. **Update Code:**
   - Update configuration files to match AWS (if AWS is correct)
   - Or update AWS to match code (if code is correct)

3. **Document:**
   - Document the drift and resolution
   - Update this document if process needs improvement

### 8.2. Manual Changes Required

**If manual changes are unavoidable:**

1. **Document:**
   - Create issue/ticket documenting the change
   - Explain why manual change was necessary

2. **Update Code:**
   - Update configuration files to reflect manual change
   - Create script to automate the change in future

3. **Verify:**
   - Verify change is reflected in code
   - Test that change can be reproduced

---

## 9. Best Practices

### 9.1. Configuration Management

1. **Single Source of Truth:**
   - Configuration files are the single source of truth
   - AWS Console is for viewing only (not editing)

2. **Version Control:**
   - All configuration changes go through Git
   - Use meaningful commit messages
   - Tag releases with infrastructure versions

3. **Documentation:**
   - Document all configuration decisions
   - Keep documentation in sync with code
   - Update this document when processes change

### 9.2. Environment Management

1. **Environment Parity:**
   - Keep dev and prod as similar as possible
   - Document any necessary differences
   - Test in dev before applying to prod

2. **Environment-Specific Values:**
   - Store in `amplify/team-provider-info.json`
   - Use environment variables for runtime configuration
   - Document all environment-specific settings

### 9.3. Change Management

1. **Change Process:**
   - Update configuration files
   - Test in dev environment
   - Apply to prod environment
   - Verify and document

2. **Rollback Plan:**
   - Keep previous configuration in Git history
   - Document rollback procedure
   - Test rollback process

---

## 10. References

### 10.1. Related Documentation

- [AWS_AMPLIFY.md](./AWS_AMPLIFY.md) - AWS Amplify configuration guide
- [SECURITY.md](./SECURITY.md) - Security requirements and Cognito setup
- [AWS_CLI_SCRIPTS.md](./AWS_CLI_SCRIPTS.md) - AWS CLI scripts for infrastructure configuration
- [ARCHITECTURE.md](../architecture/ARCHITECTURE.md) - Overall architecture

### 10.2. AWS Documentation

- [AWS Cognito User Pools](https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html)
- [AWS Amplify Gen 1 CLI](https://docs.amplify.aws/cli/)
- [AWS CloudFormation](https://docs.aws.amazon.com/cloudformation/)

### 10.3. Tools

- **AWS CLI:** For querying current infrastructure state
- **Amplify CLI:** For managing Amplify resources
- **Git:** For version control of configuration files

---

## 11. Compliance Checklist

**Before considering infrastructure setup complete:**

- [ ] All configuration stored in code
- [ ] Dev and prod environments identical (except allowed differences)
- [ ] All changes documented
- [ ] Configuration files in version control
- [ ] Documentation up to date
- [ ] No manual changes in AWS Console (except documented exceptions)
- [ ] Verification scripts created (if needed)
- [ ] Rollback procedure documented

---

**Version:** 1.0  
**Last Update:** 29 December 2025  
**Maintainer:** DevOps Team

