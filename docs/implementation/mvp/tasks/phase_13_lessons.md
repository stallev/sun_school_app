# Phase 13: Управление уроками (Lessons)

## Описание фазы
Реализация управления уроками: создание, редактирование, просмотр, удаление. Интеграция с BlockNote редактором для описания урока, выбор золотых стихов.

## Зависимости
Phase 12: Управление учебными годами (Academic Years)

## Оценка времени
8-10 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Rich text editors (BlockNote)
- Интеграция сторонних библиотек с Next.js
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI, BlockNote
Ограничения: MVP подход, интеграция BlockNote критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x, BlockNote (последняя стабильная)
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления уроками. Правильная интеграция BlockNote и реализация всех функций определит качество работы с уроками.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Используй Context7 для получения актуальной документации BlockNote
3. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
4. Изучи все связанные документы из раздела "Документация" перед выполнением задач
5. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
6. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Интеграция BlockNote обязательна для описания уроков. Контент должен сохраняться в формате JSON и корректно загружаться для редактирования.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 13.01: Создание Server Actions для уроков

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для уроков являются основой всего функционала управления уроками. Правильная реализация с проверкой прав доступа, активного учебного года и валидацией определит безопасность и корректность системы.
</context>

<task>
Создай Server Actions для управления уроками в файле `actions/lessons.ts`. Реализуй все CRUD операции с проверкой прав доступа, активного учебного года и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа
- Teacher может создавать/редактировать уроки только для своих групп
- Admin может создавать/редактировать уроки для всех групп
- Проверка наличия активного учебного года обязательна перед созданием урока
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Lessons для понимания требований к API
2. Изучи VALIDATION.md раздел Lesson Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа и активного года
5. Продумай логику работы с BlockNote контентом (JSON формат)
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/lessons.ts` с директивой `'use server'`
- [ ] Реализовать `createLesson(input)` - создание урока с проверкой активного года
- [ ] Реализовать `updateLesson(input)` - обновление урока
- [ ] Реализовать `deleteLesson(id)` - удаление урока с каскадным удалением проверок ДЗ
- [ ] Реализовать `getLesson(id)` - получение урока с проверкой доступа
- [ ] Реализовать `listLessons(gradeId, academicYearId)` - список уроков
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito
- [ ] Добавить проверку наличия активного учебного года в `createLesson`
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Lessons и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (золотые стихи, проверки ДЗ) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Lesson Schemas</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3 Управление уроками</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/lessons.ts](../../../../src/lib/validation/lessons.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getLesson, listLessons)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createLesson, updateLesson, deleteLesson)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для уроков
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно
- Проверка активного года работает
- Валидация работает корректно
- Каскадное удаление работает

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления уроками. Все функции должны иметь проверку прав доступа, активного учебного года и валидацию через Zod схемы. Код должен быть готов к использованию в компонентах.
</output_format>

---

### Task 13.02: Интеграция BlockNote редактора

<context>
<CRITICAL>Это критически важная задача для работы с описанием уроков!</CRITICAL> Интеграция BlockNote редактора необходима для создания и редактирования описания уроков. Правильная настройка сохранения и загрузки контента в формате JSON критически важна для корректной работы редактора.
</context>

<task>
Создай Client Component для интеграции BlockNote редактора. Настрой сохранение контента в формате JSON и загрузку контента из JSON для редактирования. Протестируй работу редактора.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- BlockNote должен быть установлен (из Phase 01)
- Контент должен сохраняться в формате JSON
- Контент должен загружаться из JSON для редактирования
- Редактор должен быть интегрирован с React Hook Form
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Убедись, что BlockNote установлен (из Phase 01)
2. Изучи MVP_SCOPE.md раздел 2.3.1 для понимания требований
3. Изучи DESIGN_SYSTEM.md раздел BlockNote для понимания дизайна
4. Используй Context7 для получения актуальной документации BlockNote
5. Определи структуру компонента и интеграцию с React Hook Form
6. Продумай логику сохранения и загрузки JSON контента
7. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Убедиться, что BlockNote установлен (из Phase 01)
- [ ] Создать Client Component `components/teacher/lessons/lesson-editor.tsx` (или `components/admin/lessons/lesson-editor.tsx`)
- [ ] Интегрировать BlockNote редактор с использованием `@blocknote/react`
- [ ] Настроить сохранение контента в формате JSON через `editor.blocksToJSON()`
- [ ] Настроить загрузку контента из JSON через `editor.replaceBlocks(editor.topLevelBlocks, blocksFromJSON)`
- [ ] Интегрировать редактор с React Hook Form через Controller
- [ ] Протестировать работу редактора (создание, редактирование, сохранение, загрузка)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3.1</CRITICAL>
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел BlockNote
- <CRITICAL>BlockNote официальная документация (через Context7)</CRITICAL>
- Context7: React Hook Form Controller документация

**Критерии приемки:**
- BlockNote интегрирован и работает корректно
- Редактор работает в режиме создания и редактирования
- Контент сохраняется в формате JSON
- Контент загружается из JSON для редактирования
- Интеграция с React Hook Form работает

<output_format>
После выполнения задачи должен быть создан компонент BlockNote редактора. Редактор должен работать корректно, сохраняя и загружая контент в формате JSON. Компонент должен быть готов к использованию в форме создания и редактирования урока.
</output_format>

---

### Task 13.03: Создание формы создания урока

<context>
Форма создания урока является ключевым компонентом для работы с уроками. Правильная реализация с интеграцией BlockNote редактора, выбором золотых стихов и автоматическим определением активного года критически важна для удобства работы пользователей.
</context>

<task>
Создай Client Component формы для создания урока. Реализуй форму с полями: тема урока, дата урока, описание урока (BlockNote редактор), выбор золотых стихов. Интегрируй с React Hook Form и Zod валидацией. Автоматически определяй активный учебный год.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Все поля должны быть валидированы через Zod схемы
- Тема урока и дата урока обязательны
- Описание урока должно использовать BlockNote редактор
- Выбор золотых стихов должен быть множественным с минимумом 1 выбранного стиха
- Активный учебный год должен определяться автоматически при загрузке формы
- Добавь обработку ошибок и loading state
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел New Lesson Form для понимания дизайна
2. Изучи VALIDATION.md раздел Lesson Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Определи структуру формы и интеграцию с BlockNote редактором
5. Продумай логику автоматического определения активного года
6. Только после этого создавай компонент формы
</thinking>

**Действия:**
- [ ] Создать Client Component `components/teacher/lessons/lesson-form.tsx` (или `components/admin/lessons/lesson-form.tsx`)
- [ ] Реализовать форму с полями:
  - Тема урока (обязательно, Input)
  - Дата урока (обязательно, DatePicker или Input type="date")
  - Описание урока (BlockNote редактор из Task 13.02)
  - Выбор золотых стихов (множественный выбор, минимум 1)
- [ ] Интегрировать с React Hook Form
- [ ] Добавить Zod валидацию через @hookform/resolvers
- [ ] Автоматически определять активный учебный год при загрузке формы через Server Action
- [ ] Добавить обработку ошибок с отображением сообщений
- [ ] Добавить loading state во время отправки формы
- [ ] Использовать компоненты Shadcn UI (Form, Input, Button, Dialog, Calendar)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел New Lesson Form</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Lesson Schemas</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Create Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.1 Создание нового урока
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 7.1 Создание уроков для любой группы
- Context7: React Hook Form документация
- Context7: Zod документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных
  - [src/lib/validation/lessons.ts](../../../../src/lib/validation/lessons.ts) - для валидации форм

**Критерии приемки:**
- Форма создана и работает
- Все поля работают корректно
- Валидация работает для всех полей
- BlockNote редактор интегрирован и работает
- Активный год определяется автоматически
- Обработка ошибок работает
- Loading state отображается корректно

<output_format>
После выполнения задачи должна быть создана форма создания урока. Форма должна быть полностью функциональной с валидацией, интеграцией BlockNote редактора, выбором золотых стихов и автоматическим определением активного года. Компонент должен быть готов к использованию в страницах создания урока.
</output_format>

---

### Task 13.04: Реализация выбора золотых стихов

<context>
Компонент выбора золотых стихов необходим для выбора стихов при создании урока. Правильная реализация с множественным выбором, поиском и валидацией критически важна для удобства работы пользователей.
</context>

<task>
Создай компонент для выбора золотых стихов. Реализуй множественный выбор стихов с поиском по тексту. Отображай выбранные стихи и валидируй минимум 1 выбранный стих.
</task>

<constraints>
- Компонент должен поддерживать множественный выбор стихов
- Поиск должен работать по тексту стиха
- Выбранные стихи должны отображаться с возможностью удаления
- Валидация должна требовать минимум 1 выбранный стих
- Компонент должен быть интегрирован с React Hook Form
- Используй компоненты Shadcn UI (Combobox, Badge, Button)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.3.1 для понимания требований
2. Изучи WIREFRAMES.md для понимания дизайна
3. Определи структуру компонента и интеграцию с React Hook Form
4. Продумай логику поиска и фильтрации стихов
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент `components/shared/golden-verse-selector.tsx` (или `components/molecules/golden-verse-selector.tsx`)
- [ ] Реализовать множественный выбор стихов через Combobox или MultiSelect
- [ ] Добавить поиск по тексту стиха с debounce для оптимизации
- [ ] Отобразить выбранные стихи с Badge компонентами и возможностью удаления
- [ ] Валидировать минимум 1 выбранный стих через Zod схему
- [ ] Интегрировать компонент с React Hook Form через Controller
- [ ] Использовать компоненты Shadcn UI (Combobox, Badge, Button)

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3.1
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)
- Context7: Shadcn UI Combobox документация
- Context7: React Hook Form Controller документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных золотых стихов

**Критерии приемки:**
- Выбор стихов работает корректно
- Поиск функционирует с debounce
- Выбранные стихи отображаются с возможностью удаления
- Валидация работает (минимум 1 стих)
- Интеграция с React Hook Form работает

<output_format>
После выполнения задачи должен быть создан компонент выбора золотых стихов. Компонент должен поддерживать множественный выбор, поиск, отображение выбранных стихов и валидацию. Компонент должен быть готов к использованию в форме создания урока.
</output_format>

---

### Task 13.05: Создание страницы просмотра урока

<context>
Страница просмотра урока является центральной точкой для работы с уроком. Здесь отображается вся информация об уроке, включая описание в BlockNote формате, золотые стихи и сводная таблица по ученикам. Правильное отображение информации критически важно для пользовательского опыта.
</context>

<task>
Создай страницу просмотра урока с динамическим маршрутом. Реализуй Server Component для отображения полной информации об уроке, включая рендеринг BlockNote контента. Добавь кнопки действий и сводную таблицу по ученикам.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Отображай: тему, дату, описание (рендеринг BlockNote контента через BlockNote компонент), список золотых стихов
- Кнопки действий должны быть доступны согласно правам доступа
- Сводная таблица по ученикам должна отображаться, если есть проверки ДЗ
- Используй компоненты Shadcn UI для отображения
- Проверка прав доступа должна выполняться на сервере
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Lesson Detail для понимания дизайна
2. Изучи USER_FLOW.md раздел View Lesson для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации BlockNote рендеринга
4. Определи структуру данных для отображения информации об уроке
5. Продумай логику рендеринга BlockNote контента
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/lessons/[lessonId]/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Отобразить: тему, дату, описание (рендеринг BlockNote контента через BlockNote компонент), список золотых стихов
- [ ] Добавить кнопки: "Редактировать", "Проверить ДЗ", "Удалить" (с проверкой прав доступа)
- [ ] Добавить сводную таблицу по ученикам (если есть проверки ДЗ)
- [ ] Использовать компоненты Shadcn UI (Card, Badge, Button, Table)
- [ ] Добавить проверку прав доступа перед отображением страницы

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Lesson Detail</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел View Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 2.3 Подготовка к уроку
- Context7: BlockNote рендеринг документация
- Context7: Next.js 15.5.9 динамические маршруты документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных урока

**Критерии приемки:**
- Страница просмотра создана
- Вся информация отображается корректно
- BlockNote контент рендерится правильно
- Кнопки работают и отображаются согласно правам доступа
- Сводная таблица отображается корректно

<output_format>
После выполнения задачи должна быть создана страница просмотра урока с полной информацией. Все данные должны загружаться через Server Component, BlockNote контент должен рендериться корректно, кнопки должны работать и отображаться согласно правам доступа.
</output_format>

---

### Task 13.06: Создание страницы списка уроков

<context>
Страница списка уроков позволяет просматривать все уроки группы в рамках учебного года. Правильная реализация с фильтрацией, пагинацией и сортировкой критически важна для удобства работы с большим количеством уроков.
</context>

<task>
Создай страницу списка уроков для группы и учебного года. Реализуй Server Component для отображения списка уроков с фильтрацией, пагинацией и сортировкой. Добавь кнопку создания нового урока.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Фильтрация должна работать по поиску (тема урока) и датам
- Пагинация должна быть реализована для больших списков
- Сортировка должна быть по дате урока (по умолчанию - новые сначала)
- Кнопка создания нового урока должна быть доступна согласно правам доступа
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Lesson List для понимания дизайна
2. Изучи USER_FLOW.md раздел Lesson List для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи структуру данных для отображения списка уроков
5. Продумай логику фильтрации, пагинации и сортировки
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/grades/[gradeId]/academic-years/[yearId]/lessons/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Добавить фильтрацию (поиск по теме урока, фильтр по датам)
- [ ] Добавить пагинацию для больших списков
- [ ] Добавить сортировку по дате (по умолчанию - новые сначала)
- [ ] Добавить кнопку создания нового урока (с проверкой прав доступа)
- [ ] Использовать компоненты Shadcn UI (Table, Input, Button, Pagination)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Lesson List</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Lesson List
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.3 Просмотр списка уроков
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения списка уроков

**Критерии приемки:**
- Страница списка создана
- Фильтрация работает корректно
- Пагинация работает
- Сортировка работает
- Кнопка создания урока работает

<output_format>
После выполнения задачи должна быть создана страница списка уроков. Список должен отображаться с фильтрацией, пагинацией и сортировкой. Все функции должны работать корректно.
</output_format>

---

### Task 13.07: Реализация редактирования урока

<context>
Страница редактирования урока позволяет изменять информацию об уроке. Правильная реализация с предзаполнением данных, включая BlockNote контент, критически важна для удобства работы пользователей.
</context>

<task>
Создай страницу редактирования урока. Используй форму создания урока с предзаполненными данными. Загрузи данные урока при загрузке страницы и обнови урок через Server Action.
</task>

<constraints>
- Используй форму создания урока (Task 13.03) в режиме редактирования
- Данные урока должны загружаться при загрузке страницы через Server Action
- BlockNote контент должен загружаться и отображаться в редакторе
- Золотые стихи должны быть предзаполнены
- Обновление должно выполняться через Server Action `updateLesson`
- Добавь обработку ошибок с понятными сообщениями
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Edit Lesson для понимания дизайна
2. Изучи USER_FLOW.md раздел Edit Lesson для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи логику предзаполнения формы, включая BlockNote контент
5. Продумай обработку ошибок при загрузке и обновлении данных
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать страницу `app/(private)/lessons/[lessonId]/edit/page.tsx`
- [ ] Реализовать Server Component для загрузки данных урока
- [ ] Использовать форму создания урока (Task 13.03) в режиме редактирования
- [ ] Загрузить данные урока при загрузке страницы через Server Action `getLesson`
- [ ] Предзаполнить форму данными урока (тема, дата, BlockNote контент, золотые стихи)
- [ ] Обновить урок через Server Action `updateLesson`
- [ ] Добавить обработку ошибок с отображением сообщений
- [ ] Добавить проверку прав доступа перед отображением страницы

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Edit Lesson</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Edit Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.2 Редактирование урока
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Страница редактирования создана
- Данные предзаполняются корректно
- BlockNote контент загружается и отображается в редакторе
- Золотые стихи предзаполняются
- Обновление работает корректно
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана страница редактирования урока. Форма должна предзаполняться данными урока, включая BlockNote контент. Обновление должно работать корректно через Server Action.
</output_format>

---

### Task 13.08: Реализация удаления урока

<context>
Удаление урока является критически важной операцией, которая требует подтверждения и каскадного удаления связанных данных. Правильная реализация с подтверждением и обработкой каскадного удаления критически важна для целостности данных.
</context>

<task>
Реализуй удаление урока с подтверждением и каскадным удалением связанных проверок ДЗ. Добавь Dialog подтверждения удаления и покажи уведомление об успешном удалении.
</task>

<constraints>
- Удаление должно выполняться через Server Action `deleteLesson`
- Подтверждение удаления должно быть реализовано через Dialog
- Каскадное удаление должно удалять все связанные проверки ДЗ
- Уведомление об успешном удалении должно отображаться через Toast
- Обработка ошибок должна быть реализована
- Проверка прав доступа должна выполняться перед удалением
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Delete Lesson для понимания требований
2. Изучи USER_FLOW.md раздел Delete Lesson для понимания пользовательских сценариев
3. Определи логику каскадного удаления связанных проверок ДЗ
4. Продумай UI для подтверждения удаления (Dialog)
5. Только после этого реализуй удаление
</thinking>

**Действия:**
- [ ] Добавить функцию удаления в Server Action `deleteLesson` (если еще не реализована)
- [ ] Реализовать каскадное удаление связанных проверок ДЗ в Server Action
- [ ] Добавить проверку прав доступа перед удалением
- [ ] Создать компонент Dialog для подтверждения удаления
- [ ] Добавить обработку ошибок с отображением сообщений
- [ ] Показать уведомление об успешном удалении через Toast
- [ ] Перенаправить пользователя после успешного удаления

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Delete Lesson</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Delete Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.3 Просмотр списка уроков
- Context7: Shadcn UI Dialog документация
- Context7: Shadcn UI Toast документация

**Критерии приемки:**
- Удаление работает корректно
- Подтверждение показывается через Dialog
- Каскадное удаление работает (удаляются связанные проверки ДЗ)
- Уведомление об успешном удалении показывается
- Обработка ошибок работает
- Перенаправление работает после удаления

<output_format>
После выполнения задачи должна быть реализована функция удаления урока с подтверждением и каскадным удалением. Dialog подтверждения должен работать, каскадное удаление должно удалять все связанные проверки ДЗ, уведомление должно показываться после успешного удаления.
</output_format>

---

### Task 13.09: Проверка прав доступа

<context>
<CRITICAL>Это критически важная задача для безопасности системы!</CRITICAL> Проверка прав доступа к урокам должна быть реализована на всех уровнях: в Server Actions, утилитах и компонентах. Правильная реализация защитит систему от несанкционированного доступа.
</context>

<task>
Обнови утилиту проверки доступа для уроков. Реализуй логику, где Teacher может создавать/редактировать уроки только для своих групп, а Admin может создавать/редактировать уроки для всех групп. Используй проверку в Server Actions и компонентах.
</task>

<constraints>
- Утилита должна проверять роль пользователя через Cognito
- Teacher может создавать/редактировать/удалять уроки только для своих групп
- Admin может создавать/редактировать/удалять уроки для всех групп
- Проверка должна выполняться на сервере в Server Actions
- Утилита должна использоваться во всех Server Actions и компонентах, работающих с уроками
- Ошибки доступа должны обрабатываться с понятными сообщениями
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SECURITY.md раздел RBAC для понимания системы прав доступа
2. Изучи MVP_SCOPE.md раздел 2.1.2 для понимания ролей
3. Используй Context7 для получения актуальной документации AWS Cognito
4. Изучи примеры проверки прав доступа из Phase 11 (Grades)
5. Определи структуру функции проверки доступа для уроков
6. Продумай логику определения принадлежности урока группе Teacher
7. Только после этого обновляй утилиту
</thinking>

**Действия:**
- [ ] Обновить утилиту проверки доступа для уроков (или создать новую `lib/utils/lessons.ts`)
- [ ] Реализовать функцию `checkLessonAccess(userId, lessonId, userRole)`:
  - Проверяет роль пользователя через Cognito
  - Для Teacher проверяет принадлежность урока к его группам
  - Для Admin всегда возвращает true
  - Возвращает boolean или выбрасывает ошибку
- [ ] Реализовать функцию `checkGradeAccessForLesson(userId, gradeId, userRole)` для проверки доступа к группе урока
- [ ] Использовать утилиту в Server Actions (createLesson, updateLesson, deleteLesson, getLesson)
- [ ] Использовать утилиту в компонентах при необходимости

**Документация:**
- <CRITICAL>[SECURITY.md](../../../infrastructure/SECURITY.md) - раздел RBAC</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.1.2</CRITICAL>
- Context7: AWS Cognito документация
- **Код реализации:**
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа через Cognito

**Критерии приемки:**
- Проверка прав работает корректно
- Teacher ограничен своими группами
- Admin имеет доступ ко всем группам
- Утилита используется во всех Server Actions
- Ошибки доступа обрабатываются правильно

<output_format>
После выполнения задачи должна быть обновлена утилита для проверки прав доступа к урокам. Утилита должна быть интегрирована во все Server Actions и компоненты, работающие с уроками. Проверка прав доступа должна работать корректно для всех ролей пользователей.
</output_format>

---

### Task 13.10: Тестирование функционала уроков

<context>
Тестирование функционала уроков является финальным этапом фазы. Комплексное тестирование всех функций, интеграции BlockNote, выбора золотых стихов и проверки прав доступа критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления уроками. Протестируй создание, редактирование, просмотр, удаление уроков, интеграцию BlockNote, выбор золотых стихов и проверку прав доступа для всех ролей пользователей.
</task>

<constraints>
- Тестирование должно покрывать все функции управления уроками
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Интеграция BlockNote должна быть протестирована (создание, редактирование, сохранение, загрузка)
- Выбор золотых стихов должен быть протестирован
- Проверка прав доступа должна быть протестирована для всех сценариев
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Подготовь тестовые данные для BlockNote контента
5. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать создание урока (Admin и Teacher)
- [ ] Протестировать редактирование урока (Admin и Teacher)
- [ ] Протестировать просмотр урока (Admin и Teacher)
- [ ] Протестировать удаление урока (Admin и Teacher)
- [ ] Протестировать BlockNote редактор (создание, редактирование, сохранение, загрузка)
- [ ] Протестировать выбор золотых стихов (множественный выбор, поиск, валидация)
- [ ] Протестировать проверку прав доступа для всех операций
- [ ] Протестировать проверку активного учебного года
- [ ] Протестировать каскадное удаление проверок ДЗ
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- BlockNote редактор работает корректно
- Выбор золотых стихов работает корректно
- Права доступа проверяются правильно во всех сценариях
- Ошибки обрабатываются корректно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления уроками. Все функции должны работать корректно, BlockNote редактор должен работать, выбор золотых стихов должен работать, права доступа должны проверяться правильно. Система должна быть готова к использованию.
</output_format>

---

### Task 13.11: Реализация прикрепления файлов к урокам

**Статус:** [ ] Не начато | [ ] В процессе | [ ] Выполнено | [ ] Проверено

**Описание:**
Реализовать функционал прикрепления файлов (изображения, PDF, документы) к урокам.

**Файлы для изменения:**
- [src/actions/lesson-files.ts](../../../../src/actions/lesson-files.ts)
- [src/components/teacher/LessonFileUploader/](../../../../src/components/teacher/LessonFileUploader/)
- [src/components/teacher/LessonFileList/](../../../../src/components/teacher/LessonFileList/)

**Документация:**
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - раздел 3.2

**Действия:**
- [ ] Создать Server Actions для файлов (upload, delete, getUrl)
- [ ] Создать компонент LessonFileUploader
- [ ] Создать компонент LessonFileList
- [ ] Интегрировать в форму редактирования урока
- [ ] Проверить ограничения (10MB, 10 файлов)

**Критерии приемки:**
- Файлы можно загружать к урокам
- Файлы можно удалять
- Ограничения размера и количества файлов работают корректно
- Компоненты интегрированы в форму редактирования урока

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Lessons Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Lesson Schemas
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Lesson Pages
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

