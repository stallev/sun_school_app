# Phase 13: Управление уроками (Lessons)

## Описание фазы
Реализация управления уроками: создание, редактирование, просмотр, удаление. Интеграция с Novel редактором для описания урока, выбор золотых стихов. Реализация страницы сводной таблицы урока с гибридным редактированием (inline + modal).

## Зависимости
Phase 12: Управление учебными годами (Academic Years)

## Оценка времени
10-13 часов (увеличено на 2-3 часа для реализации страницы сводной таблицы)

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Rich text editors (Novel/Tiptap)
- Интеграция сторонних библиотек с Next.js
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI, Novel
Ограничения: MVP подход, интеграция Novel критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x, Novel (последняя стабильная)
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления уроками. Правильная интеграция Novel и реализация всех функций определит качество работы с уроками.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Используй Context7 для получения актуальной документации Novel и Tiptap
3. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
4. Изучи все связанные документы из раздела "Документация" перед выполнением задач
5. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
6. Используй строго Next.js 15.5.9, не более новую версию
7. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**
8. **⚠️ ОБЯЗАТЕЛЬНО**: При создании компонентов страниц (page.tsx) строго следуй принципам из [ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md):
   - Страница должна открываться мгновенно при навигации
   - Используй Suspense boundaries с skeleton fallback
   - Разделяй page.tsx (только проверка аутентификации) и content component (загрузка данных)
9. **⚠️ ОБЯЗАТЕЛЬНО**: Для страниц просмотра (list pages, detail pages) используй ISR generation согласно [ai_isr_optimization_guidelines.md](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md):
   - Используй `export const revalidate = 60` вместо `force-dynamic`
   - Добавляй `revalidatePath` и `revalidateTag` в Server Actions после изменений
10. **⚠️ ОБЯЗАТЕЛЬНО**: При создании React компонентов и компонентов страниц строго соблюдай требования из [ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md):
   - Компоненты должны быть arrow functions
   - Максимальный размер компонента: 100 строк кода
   - Использование explicit typing вместо React.FC
   - Следование Atomic Design hierarchy

<CONSTRAINT>Интеграция Novel обязательна для описания уроков. Контент должен сохраняться в формате JSON (Tiptap/ProseMirror) и корректно загружаться для редактирования.</CONSTRAINT>
</critical_instructions>
</requirements>

## Релевантная документация

При создании программного кода для данной фазы используй следующие документы как источники требований и спецификаций:

### Функциональные требования
- **[app_functionality.md](../../../app_functionality.md)** - **единственный источник истины** для функциональных требований
  - Раздел 4.2 Список уроков за учебный год - описание функционала управления уроками
  - Раздел 4.4 Создание урока - описание создания урока
  - Раздел 4.5 Редактирование урока - описание редактирования урока
  - Раздел 4.6 Обзор урока - описание просмотра урока (включая прикрепленные файлы)
  - Раздел 4.7 Полная сводная таблица урока - описание функционала сводной таблицы

### Пользовательские сценарии
- **[USER_FLOW.md](../../../user_flows/USER_FLOW.md)** - общие пользовательские сценарии и flow-диаграммы
  - Раздел 4.2 Создание нового урока - flow создания урока
- **[TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)** - детальные flow для преподавателей
  - Раздел 3.1 Создание нового урока - детальный flow создания урока
  - Раздел 3.2 Редактирование урока - flow редактирования
  - Раздел 3.3 Просмотр списка уроков - flow просмотра списка
  - Раздел 4.2 Просмотр сводной таблицы - flow просмотра сводной таблицы урока
- **[ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)** - детальные flow для администраторов
  - Раздел 7.1 Создание уроков для любой группы - flow для Admin

### Визуальные макеты
- **[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)** - визуальные макеты страниц и компонентов
  - Раздел 3.2 Управление уроками - макеты для управления уроками
  - Раздел 3.2.1 Список уроков за учебный год - макет списка уроков
  - Раздел 3.2.2 Создание урока - макет формы создания урока
  - Раздел 3.2.3 Обзор урока - макет просмотра урока
  - Раздел 3.2.4 Редактирование урока - макет формы редактирования
  - Раздел 3.2.5 Сводная таблица урока - макет сводной таблицы

### API и валидация
- **[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md)** - спецификация Server Actions API
  - Раздел Lessons - API для управления уроками
  - Раздел Homework - API для работы с проверками домашних заданий (для сводной таблицы)
- **[VALIDATION.md](../../../api/VALIDATION.md)** - схемы валидации Zod
  - Раздел Lesson Schemas - схемы валидации для уроков
  - Раздел Homework Schemas - схемы валидации для проверок домашних заданий

### База данных
- **[GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md)** - GraphQL схема
- **[ERD.md](../../../database/ERD.md)** - диаграмма сущностей
- **[DYNAMODB_SCHEMA.md](../../../database/DYNAMODB_SCHEMA.md)** - схема DynamoDB (для понимания расчета баллов)

### Guidelines
- **[guidelines/react/](../../../guidelines/react/)** - руководящие принципы для React компонентов
  - **[ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: требования для создания React компонентов и компонентов страниц (arrow functions, размер до 100 строк, explicit typing, Atomic Design)
- **[guidelines/nextjs/](../../../guidelines/nextjs/)** - руководящие принципы для Next.js
  - **[ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: принцип построения компонентов страниц (мгновенное открытие страниц, Suspense boundaries, разделение page.tsx и content component)
  - **[ai_isr_optimization_guidelines.md](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: ISR generation для страниц просмотра (revalidate, revalidatePath, revalidateTag)
  - [ai_loading_patterns.md](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- **[guidelines/prompts/general_prompt_guidelines.md](../../../guidelines/prompts/general_prompt_guidelines.md)** - общие принципы работы

> [!NOTE]
> **Принцип единственного источника истины:** 
> - `app_functionality.md` является **единственным источником истины** для функциональных требований
> - Документы в `user_flows/` содержат детальные flow-диаграммы, **ссылающиеся на `app_functionality.md`**
> - Документ `WIREFRAMES.md` содержит визуальные макеты, **ссылающиеся на `app_functionality.md` и `user_flows/`**
> - При изменении функциональных требований обновляй `app_functionality.md`, затем при необходимости обновляй ссылки в других документах

## Задачи

### Task 13.01: Создание Server Actions для уроков

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для уроков являются основой всего функционала управления уроками. Правильная реализация с проверкой прав доступа, активного учебного года и валидацией определит безопасность и корректность системы.
</context>

<task>
Создай Server Actions для управления уроками в файле `src/actions/lessons.ts`. Реализуй все CRUD операции с проверкой прав доступа, активного учебного года и валидацией через Zod схемы.

⚠️ **Важно:** Код Server Actions должен находиться в файле `src/actions/lessons.ts` в каталоге `src/actions/`.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа
- Teacher может создавать/редактировать уроки только для своих групп
- Admin может создавать/редактировать уроки для всех групп
- Проверка наличия активного учебного года обязательна перед созданием урока
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Lessons для понимания требований к API
2. Изучи VALIDATION.md раздел Lesson Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа и активного года
5. Продумай логику работы с Novel контентом (JSON формат)
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [x] Создать `src/actions/lessons.ts` с директивой `'use server'`
- [x] Реализовать `createLesson(input)` - создание урока с проверкой активного года
- [x] Реализовать `updateLesson(input)` - обновление урока
- [x] Реализовать `deleteLesson(id)` - удаление урока с каскадным удалением проверок ДЗ
- [x] Реализовать `getLesson(id)` - получение урока с проверкой доступа
- [x] Реализовать `listLessons(gradeId, academicYearId)` - список уроков
- [x] Добавить проверку прав доступа в каждую функцию через Cognito
- [x] Добавить проверку наличия активного учебного года в `createLesson`
- [x] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.4 Создание урока - требования к созданию урока
  - Раздел 4.5 Редактирование урока - требования к редактированию урока
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Lessons и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (золотые стихи, проверки ДЗ) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Lesson Schemas</CRITICAL>
- [AWS_AMPLIFY.md](../../../infrastructure/AWS_AMPLIFY.md) - раздел 4.3 Работа с S3 Storage для прикрепления файлов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/lessons.ts](../../../../src/lib/validation/lessons.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getLesson, listLessons)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createLesson, updateLesson, deleteLesson)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для уроков
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно
- Проверка активного года работает
- Валидация работает корректно
- Каскадное удаление работает

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления уроками. Все функции должны иметь проверку прав доступа, активного учебного года и валидацию через Zod схемы. Код должен быть готов к использованию в компонентах.
</output_format>

---

### Task 13.02: Интеграция Novel редактора

<context>
<CRITICAL>Это критически важная задача для работы с описанием уроков!</CRITICAL> Интеграция Novel редактора необходима для создания и редактирования описания уроков. Novel построен на Shadcn UI, что обеспечивает нативную интеграцию. Правильная настройка сохранения и загрузки контента в формате JSON критически важна для корректной работы редактора.
</context>

<task>
Создай Client Component для интеграции Novel редактора. Настрой сохранение контента в формате JSON (Tiptap/ProseMirror) и загрузку контента из JSON для редактирования. Протестируй работу редактора.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Novel должен быть установлен: `npm install novel`
- Контент должен сохраняться в формате JSON (Tiptap/ProseMirror)
- Контент должен загружаться из JSON для редактирования
- Редактор должен быть интегрирован с React Hook Form через Controller
- Обработка ошибок должна быть реализована
- Базовая конфигурация без AI функций
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи документацию по ссылкам: https://github.com/steven-tey/novel , используй руководство https://medium.com/@mahesh.paul.j/how-to-implement-novel-sh-into-your-project-a-complete-step-by-step-guide-344ec4000437. AI features я не буду использовать в этом проекте.
2. Изучи MVP_SCOPE.md раздел 2.3.1 для понимания требований
3. Изучи DESIGN_SYSTEM.md раздел Novel для понимания дизайна
4. Используй Context7 для получения актуальной документации Novel
5. Определи структуру компонента и интеграцию с React Hook Form
6. Продумай логику сохранения и загрузки JSON контента (Tiptap format)
7. Только после этого создавай компонент
</thinking>

**Действия:**
- [x] Установи Novel
- [x] Создать Client Component `@/components/shared/rich-text-editor.tsx`
- [x] Интегрировать Novel редактор с использованием `novel`
- [x] Настроить сохранение контента в формате JSON через `editor.getJSON()`
- [x] Настроить загрузку контента из JSON через `initialContent`
- [x] Интегрировать редактор с React Hook Form через Controller
- [x] Протестировать работу редактора (создание, редактирование, сохранение, загрузка)

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел Novel
- <CRITICAL>Novel официальная документация (через Context7): https://github.com/steven-tey/novel</CRITICAL>
- Context7: React Hook Form Controller документация

**Критерии приемки:**
- Novel интегрирован и работает корректно
- Редактор работает в режиме создания и редактирования
- Контент сохраняется в формате JSON (Tiptap)
- Контент загружается из JSON для редактирования
- Интеграция с React Hook Form работает

<output_format>
После выполнения задачи должен быть создан компонент Novel редактора. Редактор должен работать корректно, сохраняя и загружая контент в формате JSON (Tiptap/ProseMirror). Компонент должен быть готов к использованию в форме создания и редактирования урока.
</output_format>

---

### Task 13.03: Создание формы создания урока

<context>
Форма создания урока является ключевым компонентом для работы с уроками. Правильная реализация с интеграцией Novel редактора, выбором золотых стихов и автоматическим определением активного года критически важна для удобства работы пользователей.
</context>

<task>
Создай Client Component формы для создания урока. Реализуй форму с полями: тема урока, дата урока, описание урока (Novel редактор), выбор золотых стихов. Интегрируй с React Hook Form и Zod валидацией. Автоматически определяй активный учебный год. При создании логики формы используй паттерн формы создания/редактирования группы `src\components\admin\grades\grade-form.tsx`. Не забудь добавить кнопку "Отменить".
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Все поля должны быть валидированы через Zod схемы
- Тема урока и дата урока обязательны
- Описание урока должно использовать Novel редактор
- Выбор золотых стихов должен быть множественным с минимумом 1 выбранного стиха
- Активный учебный год должен определяться автоматически при загрузке формы
- Добавь обработку ошибок и loading state
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел New Lesson Form для понимания дизайна
2. Изучи VALIDATION.md раздел Lesson Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Определи структуру формы и интеграцию с Novel редактором
5. Продумай логику автоматического определения активного года
6. Только после этого создавай компонент формы
</thinking>

**Действия:**
- [x] Создать Client Component `components/teacher/lessons/lesson-form.tsx` (или `components/admin/lessons/lesson-form.tsx`)
- [x] Реализовать форму с полями:
  - Тема урока (обязательно, Input)
  - Дата урока (обязательно, DatePicker или Input type="date")
  - Описание урока (Novel редактор из Task 13.02)
  - Выбор золотых стихов (множественный выбор, минимум 1)
- [x] Интегрировать с React Hook Form
- [x] Добавить Zod валидацию через @hookform/resolvers
- [x] Автоматически определять активный учебный год при загрузке формы через Server Action
- [x] Добавить обработку ошибок с отображением сообщений
- [x] Добавить loading state во время отправки формы
- [x] Использовать компоненты Shadcn UI (Form, Input, Button, Dialog, Calendar)

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.4 Создание урока - полное описание функционала создания урока (включая выбор золотых стихов, автоматическое определение активного года)
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел 3.2.2 Создание урока</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Lesson Schemas</CRITICAL>
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.1 Создание нового урока
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 7.1 Создание уроков для любой группы
- Context7: React Hook Form документация
- Context7: Zod документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных
  - [src/lib/validation/lessons.ts](../../../../src/lib/validation/lessons.ts) - для валидации форм

**Критерии приемки:**
- Форма создана и работает
- Все поля работают корректно
- Валидация работает для всех полей
- Novel редактор интегрирован и работает
- Активный год определяется автоматически
- Обработка ошибок работает
- Loading state отображается корректно

<output_format>
После выполнения задачи должна быть создана форма создания урока. Форма должна быть полностью функциональной с валидацией, интеграцией Novel редактора, выбором золотых стихов и автоматическим определением активного года. Компонент должен быть готов к использованию в страницах создания урока.
</output_format>

---

### Task 13.13: Создание страницы создания урока

<context>
<CRITICAL>Это критически важная задача для навигации к созданию урока!</CRITICAL> Страница создания урока `/lessons/new` должна получать `gradeId` из query параметров и передавать его в форму создания урока. Правильная реализация с Suspense boundaries для быстрой навигации критически важна для удобства работы пользователей.
</context>

<task>
Создай страницу создания урока `/lessons/new`. Реализуй Server Component для проверки аутентификации и получения `gradeId` из query параметров. Используй Suspense boundaries для быстрой навигации согласно `ai_suspense_fast_navigation.md`. Передай `gradeId` в компонент `LessonForm` из Task 13.03. Проверь логику передачи параметров и создания урока.
</task>

<constraints>
- Используй Server Component для проверки аутентификации и авторизации
- Получай `gradeId` из query параметров (`searchParams`)
- Если `gradeId` не передан, покажи ошибку или редирект на список групп
- Используй Suspense boundaries для быстрой навигации (согласно `ai_suspense_fast_navigation.md`)
- Создай content component для загрузки данных
- Создай skeleton component для loading state
- Передай `gradeId` в Client Component `LessonForm`
- Соответствуй `ai_component_guidelines.md` (arrow functions, explicit typing, размер до 100 строк)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи ai_suspense_fast_navigation.md для понимания паттерна Suspense boundaries
2. Изучи ai_component_guidelines.md для понимания требований к компонентам
3. Изучи существующие страницы уроков для понимания структуры
4. Определи логику получения `gradeId` из query параметров
5. Продумай проверку логики передачи параметров и создания урока
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/lessons/new/page.tsx` - основная страница (только проверка аутентификации)
- [ ] Создать `app/(private)/lessons/new/lesson-new-content.tsx` - content component (загрузка данных и передача `gradeId` в `LessonForm`)
- [ ] Создать `app/(private)/lessons/new/lesson-new-skeleton.tsx` - skeleton component (loading state)
- [ ] Реализовать получение `gradeId` из query параметров (`searchParams`)
- [ ] Реализовать проверку наличия `gradeId` и редирект при отсутствии
- [ ] Использовать Suspense boundaries для быстрой навигации
- [ ] Передать `gradeId` в компонент `LessonForm`
- [ ] **Подзадача: Проверка логики передачи параметров и создания урока:**
  - [ ] Проверить получение `gradeId` из query параметров
  - [ ] Проверить передачу `gradeId` в `useLessonForm`
  - [ ] Проверить загрузку активного учебного года в `useLessonForm`
  - [ ] Проверить передачу `gradeId` и `academicYearId` в `createLessonAction`
  - [ ] Проверить корректный редирект после создания урока

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.4 Создание урока - полное описание функционала создания урока
- <CRITICAL>[ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md) - ⚠️ **ОБЯЗАТЕЛЬНО**: принцип построения компонентов страниц (мгновенное открытие страниц, Suspense boundaries, разделение page.tsx и content component)</CRITICAL>
- <CRITICAL>[ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md) - ⚠️ **ОБЯЗАТЕЛЬНО**: требования для создания React компонентов (arrow functions, размер до 100 строк, explicit typing)</CRITICAL>
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.1 Создание нового урока
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 7.1 Создание уроков для любой группы
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/components/teacher/LessonForm/LessonForm.tsx](../../../../src/components/teacher/LessonForm/LessonForm.tsx) - компонент формы создания урока
  - [src/hooks/useLessonForm.ts](../../../../src/hooks/useLessonForm.ts) - хук для работы с формой урока
  - [src/actions/lessons.ts](../../../../src/actions/lessons.ts) - Server Action для создания урока

**Критерии приемки:**
- Страница создания урока создана и работает
- `gradeId` корректно получается из query параметров
- При отсутствии `gradeId` происходит редирект или показывается ошибка
- Suspense boundaries работают (страница открывается мгновенно)
- Skeleton component отображается во время загрузки
- `gradeId` корректно передается в `LessonForm`
- Логика передачи параметров проверена и работает корректно
- Создание урока работает с корректной передачей `gradeId` и `academicYearId`
- Редирект после создания урока работает корректно

<output_format>
После выполнения задачи должна быть создана страница создания урока `/lessons/new`. Страница должна получать `gradeId` из query параметров, использовать Suspense boundaries для быстрой навигации и передавать `gradeId` в форму создания урока. Логика передачи параметров и создания урока должна быть проверена и работать корректно.
</output_format>

---

### Task 13.04: Реализация выбора золотых стихов

<context>
Компонент выбора золотых стихов необходим для выбора стихов при создании урока. Правильная реализация с множественным выбором, поиском и валидацией критически важна для удобства работы пользователей.
</context>

<task>
Создай компонент для выбора золотых стихов. Реализуй множественный выбор стихов с поиском по тексту. Отображай выбранные стихи и валидируй минимум 1 выбранный стих.
</task>

<constraints>
- Компонент должен поддерживать множественный выбор стихов
- Поиск должен работать по тексту стиха
- Выбранные стихи должны отображаться с возможностью удаления
- Валидация должна требовать минимум 1 выбранный стих
- Компонент должен быть интегрирован с React Hook Form
- Используй компоненты Shadcn UI (Combobox, Badge, Button)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.3.1 для понимания требований
2. Изучи WIREFRAMES.md для понимания дизайна
3. Определи структуру компонента и интеграцию с React Hook Form
4. Продумай логику поиска и фильтрации стихов
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [x] Создать компонент `components/shared/golden-verse-selector.tsx` (или `components/molecules/golden-verse-selector.tsx`)
- [x] Реализовать множественный выбор стихов через Combobox или MultiSelect
- [x] Добавить поиск по тексту стиха с debounce для оптимизации
- [x] Отобразить выбранные стихи с Badge компонентами и возможностью удаления
- [x] Валидировать минимум 1 выбранный стих через Zod схему
- [x] Интегрировать компонент с React Hook Form через Controller
- [x] Использовать компоненты Shadcn UI (Combobox, Badge, Button)

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.4 Создание урока - логика выбора золотых стихов (книга, глава, стих, автоподстановка текста)
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел 3.2.2 Создание урока
- Context7: Shadcn UI Combobox документация
- Context7: React Hook Form Controller документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных золотых стихов

**Критерии приемки:**
- Выбор стихов работает корректно
- Поиск функционирует с debounce
- Выбранные стихи отображаются с возможностью удаления
- Валидация работает (минимум 1 стих)
- Интеграция с React Hook Form работает

<output_format>
После выполнения задачи должен быть создан компонент выбора золотых стихов. Компонент должен поддерживать множественный выбор, поиск, отображение выбранных стихов и валидацию. Компонент должен быть готов к использованию в форме создания урока.
</output_format>

---

### Task 13.05: Создание страницы просмотра урока

<context>
Страница просмотра урока является центральной точкой для работы с уроком. Здесь отображается вся информация об уроке, включая описание в Novel формате, золотые стихи и сводная таблица по ученикам. Правильное отображение информации критически важно для пользовательского опыта.
</context>

<task>
Создай страницу просмотра урока с динамическим маршрутом. Реализуй Server Component для отображения полной информации об уроке, включая рендеринг Novel контента, прикрепленные файлы, золотые стихи (с учетом настроек группы). Добавь кнопки действий и карточки для перехода к сводной таблице и проверке ДЗ.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Отображай: тему, дату, описание (рендеринг Novel контента через Novel компонент), список золотых стихов (только если grade.settings.showGoldenVerses = true), прикрепленные файлы
- Кнопки действий должны быть доступны согласно правам доступа
- Карточки действий: "Открыть таблицу" (→ /lessons/:lessonId/complete-table), "Начать проверку" (→ /lessons/:lessonId/checking-homework)
- Используй компоненты Shadcn UI для отображения
- Проверка прав доступа должна выполняться на сервере
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Lesson Detail для понимания дизайна
2. Изучи USER_FLOW.md раздел View Lesson для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Novel рендеринга
4. Определи структуру данных для отображения информации об уроке
5. Продумай логику рендеринга Novel контента
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [x] Создать `app/(private)/lessons/[lessonId]/page.tsx`
- [x] Реализовать Server Component для загрузки данных через Server Action
- [x] Отобразить: тему, дату, описание (рендеринг Novel контента через Novel компонент), список золотых стихов (с проверкой grade.settings.enableGoldenVerse), прикрепленные файлы
- [x] Добавить кнопки: "Редактировать", "Удалить" (с проверкой прав доступа)
- [x] Добавить карточки действий: "Открыть таблицу" (→ /lessons/:lessonId/complete-table), "Начать проверку" (→ /lessons/:lessonId/checking-homework)
- [x] Использовать компоненты Shadcn UI (Card, Badge, Button, Progress)
- [x] Добавить проверку прав доступа перед отображением страницы

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.6 Обзор урока - полное описание функционала просмотра урока (включая прикрепленные файлы, золотые стихи, карточки действий)
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел 3.2.3 Обзор урока</CRITICAL>
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 2.3 Подготовка к уроку
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Novel рендеринг документация
- Context7: Next.js 15.5.9 динамические маршруты документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных урока

**Критерии приемки:**
- ✅ Страница просмотра создана
- ✅ Вся информация отображается корректно
- ✅ Novel контент рендерится правильно (read-only режим)
- ✅ Золотые стихи отображаются только если `grade.settings.enableGoldenVerse = true`
- ✅ Прикрепленные файлы отображаются с возможностью скачивания
- ✅ Карточки действий работают и ведут на правильные страницы
- ✅ Кнопки работают и отображаются согласно правам доступа
- ✅ ISR настроен (revalidate = 60)
- ✅ Suspense boundaries работают (мгновенное открытие страницы)
- ✅ Loading states отображаются корректно

<output_format>
После выполнения задачи должна быть создана страница просмотра урока с полной информацией. Все данные должны загружаться через Server Component, Novel контент должен рендериться корректно, кнопки должны работать и отображаться согласно правам доступа.
</output_format>

---

### Task 13.06: Создание страницы списка уроков

<context>
Страница списка уроков позволяет просматривать все уроки группы в рамках учебного года. Правильная реализация с фильтрацией, пагинацией и сортировкой критически важна для удобства работы с большим количеством уроков.
</context>

<task>
Создай страницу списка уроков для группы и учебного года. Реализуй Server Component для отображения списка уроков с фильтрацией, пагинацией и сортировкой. Добавь кнопку создания нового урока.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Фильтрация должна работать по поиску (тема урока) и датам
- Пагинация должна быть реализована для больших списков
- Сортировка должна быть по дате урока (по умолчанию - новые сначала)
- Кнопка создания нового урока должна быть доступна согласно правам доступа
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Lesson List для понимания дизайна
2. Изучи USER_FLOW.md раздел Lesson List для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи структуру данных для отображения списка уроков
5. Продумай логику фильтрации, пагинации и сортировки
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [x] Создать `app/(private)/grades/[gradeId]/academic-years/[yearId]/lessons/page.tsx`
- [x] Реализовать Server Component для загрузки данных через Server Action
- [x] Добавить фильтрацию (поиск по теме урока, фильтр по датам)
- [x] Добавить пагинацию для больших списков
- [x] Добавить сортировку по дате (по умолчанию - новые сначала)
- [x] Добавить кнопку создания нового урока (с проверкой прав доступа)
- [x] Использовать компоненты Shadcn UI (Table, Input, Button, Pagination)

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.2 Список уроков за учебный год - полное описание функционала списка уроков (фильтрация, пагинация, сортировка)
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел 3.2.1 Список уроков за учебный год</CRITICAL>
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.3 Просмотр списка уроков
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения списка уроков

**Критерии приемки:**
- Страница списка создана
- Фильтрация работает корректно
- Пагинация работает
- Сортировка работает
- Кнопка создания урока работает

<output_format>
После выполнения задачи должна быть создана страница списка уроков. Список должен отображаться с фильтрацией, пагинацией и сортировкой. Все функции должны работать корректно.
</output_format>

---

### Task 13.07: Реализация редактирования урока

<context>
Страница редактирования урока позволяет изменять информацию об уроке. Правильная реализация с предзаполнением данных, включая Novel контент, критически важна для удобства работы пользователей.
</context>

<task>
Создай страницу редактирования урока. Используй форму создания урока с предзаполненными данными. Загрузи данные урока при загрузке страницы и обнови урок через Server Action.
</task>

<constraints>
- Используй форму создания урока (Task 13.03) в режиме редактирования
- Данные урока должны загружаться при загрузке страницы через Server Action
- Novel контент должен загружаться и отображаться в редакторе
- Золотые стихи должны быть предзаполнены
- Обновление должно выполняться через Server Action `updateLesson`
- Добавь обработку ошибок с понятными сообщениями
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Edit Lesson для понимания дизайна
2. Изучи USER_FLOW.md раздел Edit Lesson для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи логику предзаполнения формы, включая Novel контент
5. Продумай обработку ошибок при загрузке и обновлении данных
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [x] Создать страницу `app/(private)/lessons/[lessonId]/edit/page.tsx`
- [x] Реализовать Server Component для загрузки данных урока
- [x] Использовать форму создания урока (Task 13.03) в режиме редактирования
- [x] Загрузить данные урока при загрузке страницы через Server Action `getLessonWithRelationsAction`
- [x] Предзаполнить форму данными урока (тема, дата, Novel контент, золотые стихи)
- [x] Обновить урок через Server Action `updateLessonAction`
- [x] Добавить обработку ошибок с отображением сообщений
- [x] Добавить проверку прав доступа перед отображением страницы

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.5 Редактирование урока - полное описание функционала редактирования урока (включая прикрепленные файлы, редактирование золотых стихов)
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел 3.2.4 Редактирование урока</CRITICAL>
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.2 Редактирование урока
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Страница редактирования создана
- Данные предзаполняются корректно
- Novel контент загружается и отображается в редакторе
- Золотые стихи предзаполняются
- Обновление работает корректно
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана страница редактирования урока. Форма должна предзаполняться данными урока, включая Novel контент. Обновление должно работать корректно через Server Action.
</output_format>

---

### Task 13.08: Реализация удаления урока

<context>
Удаление урока является критически важной операцией, которая требует подтверждения и каскадного удаления связанных данных. Правильная реализация с подтверждением и обработкой каскадного удаления критически важна для целостности данных.
</context>

<task>
Реализуй удаление урока с подтверждением и каскадным удалением связанных проверок ДЗ. Добавь Dialog подтверждения удаления и покажи уведомление об успешном удалении.
</task>

<constraints>
- Удаление должно выполняться через Server Action `deleteLesson`
- Подтверждение удаления должно быть реализовано через Dialog
- Каскадное удаление должно удалять все связанные проверки ДЗ
- Уведомление об успешном удалении должно отображаться через Toast
- Обработка ошибок должна быть реализована
- Проверка прав доступа должна выполняться перед удалением
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Delete Lesson для понимания требований
2. Изучи USER_FLOW.md раздел Delete Lesson для понимания пользовательских сценариев
3. Определи логику каскадного удаления связанных проверок ДЗ
4. Продумай UI для подтверждения удаления (Dialog)
5. Только после этого реализуй удаление
</thinking>

**Действия:**
- [x] Добавить функцию удаления в Server Action `deleteLesson` (если еще не реализована)
- [x] Реализовать каскадное удаление связанных проверок ДЗ в Server Action
- [x] Добавить проверку прав доступа перед удалением
- [x] Создать компонент Dialog для подтверждения удаления
- [x] Добавить обработку ошибок с отображением сообщений
- [x] Показать уведомление об успешном удалении через Toast
- [x] Перенаправить пользователя после успешного удаления

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.2 Список уроков за учебный год - сценарий удаления урока
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Delete Lesson</CRITICAL>
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.3 Просмотр списка уроков
- Context7: Shadcn UI Dialog документация
- Context7: Shadcn UI Toast документация

**Критерии приемки:**
- Удаление работает корректно
- Подтверждение показывается через Dialog
- Каскадное удаление работает (удаляются связанные проверки ДЗ)
- Уведомление об успешном удалении показывается
- Обработка ошибок работает
- Перенаправление работает после удаления

<output_format>
После выполнения задачи должна быть реализована функция удаления урока с подтверждением и каскадным удалением. Dialog подтверждения должен работать, каскадное удаление должно удалять все связанные проверки ДЗ, уведомление должно показываться после успешного удаления.
</output_format>

---

### Task 13.09: Проверка прав доступа

<context>
<CRITICAL>Это критически важная задача для безопасности системы!</CRITICAL> Проверка прав доступа к урокам должна быть реализована на всех уровнях: в Server Actions, утилитах и компонентах. Правильная реализация защитит систему от несанкционированного доступа.
</context>

<task>
Обнови утилиту проверки доступа для уроков. Реализуй логику, где Teacher может создавать/редактировать уроки только для своих групп, а Admin может создавать/редактировать уроки для всех групп. Используй проверку в Server Actions и компонентах.
</task>

<constraints>
- Утилита должна проверять роль пользователя через Cognito
- Teacher может создавать/редактировать/удалять уроки только для своих групп
- Admin может создавать/редактировать/удалять уроки для всех групп
- Проверка должна выполняться на сервере в Server Actions
- Утилита должна использоваться во всех Server Actions и компонентах, работающих с уроками
- Ошибки доступа должны обрабатываться с понятными сообщениями
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SECURITY.md раздел RBAC для понимания системы прав доступа
2. Изучи MVP_SCOPE.md раздел 2.1.2 для понимания ролей
3. Используй Context7 для получения актуальной документации AWS Cognito
4. Изучи примеры проверки прав доступа из Phase 11 (Grades)
5. Определи структуру функции проверки доступа для уроков
6. Продумай логику определения принадлежности урока группе Teacher
7. Только после этого обновляй утилиту
</thinking>

**Действия:**
- [x] Обновить утилиту проверки доступа для уроков (или создать новую `lib/utils/lessons.ts`)
- [x] Реализовать функцию `checkLessonAccess(userId, lessonId, userRole)`:
  - Проверяет роль пользователя через Cognito
  - Для Teacher проверяет принадлежность урока к его группам
  - Для Admin всегда возвращает true
  - Возвращает boolean или выбрасывает ошибку
- [x] Реализовать функцию `checkGradeAccessForLesson(userId, gradeId, userRole)` для проверки доступа к группе урока
- [x] Использовать утилиту в Server Actions (createLesson, updateLesson, deleteLesson, getLesson)
- [x] Использовать утилиту в компонентах при необходимости

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 2.1 Teacher - ограничения доступа (только свои группы)
  - Раздел 2.2 Admin - расширенные права (все группы)
  - Разделы 4.2, 4.4, 4.5, 4.6 - требования к доступу для каждой операции
- <CRITICAL>[SECURITY.md](../../../infrastructure/SECURITY.md) - раздел RBAC</CRITICAL>
- Context7: AWS Cognito документация
- **Код реализации:**
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа через Cognito

**Критерии приемки:**
- Проверка прав работает корректно
- Teacher ограничен своими группами
- Admin имеет доступ ко всем группам
- Утилита используется во всех Server Actions
- Ошибки доступа обрабатываются правильно

<output_format>
После выполнения задачи должна быть обновлена утилита для проверки прав доступа к урокам. Утилита должна быть интегрирована во все Server Actions и компоненты, работающие с уроками. Проверка прав доступа должна работать корректно для всех ролей пользователей.
</output_format>

---

### Task 13.10: Тестирование функционала уроков

<context>
Тестирование функционала уроков является финальным этапом фазы. Комплексное тестирование всех функций, интеграции Novel, выбора золотых стихов и проверки прав доступа критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления уроками. Протестируй создание, редактирование, просмотр, удаление уроков, интеграцию Novel, выбор золотых стихов и проверку прав доступа для всех ролей пользователей.
</task>

<constraints>
- Тестирование должно покрывать все функции управления уроками
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Интеграция Novel должна быть протестирована (создание, редактирование, сохранение, загрузка)
- Выбор золотых стихов должен быть протестирован
- Проверка прав доступа должна быть протестирована для всех сценариев
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Подготовь тестовые данные для Novel контента
5. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать создание урока (Admin и Teacher)
- [ ] Протестировать редактирование урока (Admin и Teacher)
- [ ] Протестировать просмотр урока (Admin и Teacher)
- [ ] Протестировать удаление урока (Admin и Teacher)
- [ ] Протестировать Novel редактор (создание, редактирование, сохранение, загрузка)
- [ ] Протестировать выбор золотых стихов (множественный выбор, поиск, валидация)
- [ ] Протестировать страницу сводной таблицы (отображение, фильтры, inline editing, modal editing, расчет баллов)
- [ ] Протестировать проверку прав доступа для всех операций
- [ ] Протестировать проверку активного учебного года
- [ ] Протестировать каскадное удаление проверок ДЗ
- [ ] Протестировать обработку ошибок

**Документация:**
- [app_functionality.md](../../../app_functionality.md) - разделы 4.2-4.7 для проверки соответствия функционала требованиям
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - детальные сценарии для тестирования
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - детальные сценарии для тестирования

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- Novel редактор работает корректно
- Выбор золотых стихов работает корректно
- Страница сводной таблицы работает корректно (отображение, фильтры, редактирование, расчет баллов)
- Права доступа проверяются правильно во всех сценариях
- Ошибки обрабатываются корректно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления уроками. Все функции должны работать корректно, Novel редактор должен работать, выбор золотых стихов должен работать, права доступа должны проверяться правильно. Система должна быть готова к использованию.
</output_format>

---

### Task 13.11: Реализация прикрепления файлов к урокам — Post-MVP

> [!NOTE]
> **Статус:** Функционал прикрепления файлов к урокам перенесен в Post-MVP и не будет реализован в текущей версии приложения.

<context>
Прикрепление файлов к урокам позволяет преподавателям добавлять дополнительные материалы (изображения, PDF, документы) к урокам. Правильная реализация с использованием AWS S3 Storage и публичным доступом критически важна для удобства работы пользователей.

**Примечание:** Данная задача отложена до Post-MVP. Структура БД (модель LessonFile) сохранена в GraphQL схеме для будущей реализации.
</context>

<task>
~~Реализуй функционал прикрепления файлов к урокам. Создай Server Actions для работы с файлами в S3, компоненты для загрузки и отображения файлов. Интегрируй в формы создания и редактирования урока.~~

**Задача отложена до Post-MVP.**
</task>

<constraints>
- Файлы должны храниться в AWS S3 Storage
- При загрузке файлов в S3 использовать ACL: 'public-read' для публичного доступа
- Поддерживаемые форматы: изображения (jpg, png, gif), PDF, документы (doc, docx)
- Максимальный размер файла: 10MB
- Максимальное количество файлов: 10
- Файлы должны быть доступны по прямым URL без аутентификации
- Компоненты должны быть интегрированы в формы создания и редактирования урока
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.4 и 4.5 для понимания требований к прикреплению файлов
2. Изучи AWS_AMPLIFY.md раздел 4.3 для понимания работы с S3 Storage
3. Определи структуру Server Actions для работы с файлами
4. Продумай UI компоненты для загрузки и отображения файлов
5. Только после этого создавай компоненты
</thinking>

**Действия:**
- [ ] Задача отложена до Post-MVP

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.4 Создание урока - секция прикрепления файлов
  - Раздел 4.5 Редактирование урока - управление прикрепленными файлами
  - Раздел 4.6 Обзор урока - отображение прикрепленных файлов
- <CRITICAL>[AWS_AMPLIFY.md](../../../infrastructure/AWS_AMPLIFY.md) - раздел 4.3 Работа с S3 Storage</CRITICAL>
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - разделы 3.2.2, 3.2.3, 3.2.4 для визуальных макетов
- Context7: AWS S3 SDK документация

**Критерии приемки:**
- Задача отложена до Post-MVP

<output_format>
Функционал прикрепления файлов к урокам будет реализован в Post-MVP. Структура БД (модель LessonFile) сохранена в GraphQL схеме для будущей реализации.
</output_format>

---

### Task 13.12: Создание страницы сводной таблицы урока

<context>
<CRITICAL>Это критически важная задача для работы с оценками учеников!</CRITICAL> Страница сводной таблицы урока позволяет просматривать все оценки учеников по уроку в табличном формате и редактировать их с использованием гибридного подхода (inline + modal editing). Правильная реализация с автоматическим расчетом баллов и зависимостью от настроек группы критически важна для удобства работы преподавателей.
</context>

<task>
Создай страницу сводной таблицы урока `/lessons/:lessonId/complete-table`. Реализуй Server Component для загрузки данных, Client Component для интерактивной таблицы с гибридным редактированием (inline editing для быстрых изменений, modal editing для полного редактирования), фильтры, автоматический расчет баллов и зависимость от настроек группы (GradeSettings).
</task>

<constraints>
- Используй Server Component для загрузки данных урока и всех связанных проверок ДЗ
- Таблица должна отображать все оценки учеников по уроку
- Фильтры: "Показать только присутствовавших", "Показать только непроверенных"
- Колонки таблицы зависят от настроек группы (GradeSettings):
  - ЗС1, ЗС2, ЗС3 - показываются только если `grade.settings.showGoldenVerses = true`
  - Тест - показывается только если `grade.settings.enableTest = true`
  - Тетрадь - показывается только если `grade.settings.enableNotebook = true`
  - Спевка - показывается только если `grade.settings.enableSinging = true`
- Автоматический расчет баллов по формуле из DYNAMODB_SCHEMA.md
- Гибридное редактирование: inline editing (быстрое) + modal editing (полное)
- Цветовое кодирование строк и ячеек
- Состояния: Loading, Error, Empty
- Проверка прав доступа на сервере
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.7 для понимания всех требований к сводной таблице
2. Изучи TEACHER_FLOWS.md раздел 4.2 для понимания пользовательских сценариев
3. Изучи WIREFRAMES.md раздел 3.2.5 для понимания визуального дизайна
4. Изучи SERVER_ACTIONS.md для понимания API получения и обновления данных
5. Изучи VALIDATION.md для понимания схем валидации проверок ДЗ
6. Определи структуру компонентов (Server Component + Client Component)
7. Продумай логику inline editing и modal editing
8. Только после этого создавай страницу
</thinking>

**Действия:**
- [x] Создать страницу `app/(private)/lessons/[lessonId]/complete-table/page.tsx`
- [x] Реализовать Server Component для загрузки данных через Server Action `getLessonComplete`
- [x] Создать Client Component для интерактивной таблицы `components/teacher/CompleteLessonTable/CompleteLessonTable.tsx`
- [x] Реализовать отображение таблицы с колонками:
  - №, Ученик (с ссылкой на личную карточку), При., ЗС1/ЗС2/ЗС3, Тест, Тетрадь, Спевка, Итого, Действия
  - Колонки показываются/скрываются в зависимости от GradeSettings
- [x] Реализовать фильтры: "Показать только присутствовавших", "Показать только непроверенных"
- [x] Реализовать автоматический расчет баллов по формуле:
  ```
  points = (goldenVerse1Score + goldenVerse2Score + goldenVerse3Score) + testScore + notebookScore + (singing ? gradeSettings.pointsSinging : 0)
  ```
- [x] Реализовать inline editing:
  - Числовые поля (Тест, Тетрадь): двойной клик → input с валидацией (0-10)
  - Чекбоксы (Спевка, Присутствие): клик → toggle значения
  - Золотые стихи (0/1/2): клик → dropdown с опциями
- [x] Реализовать modal editing:
  - Клик на ✏️ в колонке "Действия" → открытие модального окна с полной формой редактирования
  - Все поля формы с валидацией
  - Кнопки "Сохранить" и "Отмена"
- [x] Реализовать цветовое кодирование:
  - Строка с отсутствующим учеником — серый фон
  - Строка с непроверенным учеником — жёлтый фон
  - Ячейка с низкой оценкой (0-4) — красный оттенок
  - Ячейка с хорошей оценкой (8-10) — зелёный оттенок
- [x] Реализовать состояния: Loading (skeleton), Error (сообщение с кнопкой "Повторить"), Empty (сообщение с кнопкой "Начать проверку")
- [x] Добавить легенду с расшифровкой сокращений и символов
- [x] Добавить кнопку возврата "← Назад к обзору урока"
- [x] Использовать Server Action `updateHomeworkCheck` для обновления проверок
- [x] Добавить проверку прав доступа перед отображением страницы

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований</CRITICAL>
  - Раздел 4.7 Полная сводная таблица урока - полное описание функционала (таблица, фильтры, редактирование, расчет баллов, зависимости от GradeSettings)
- <CRITICAL>[TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 4.2 Просмотр сводной таблицы</CRITICAL>
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел 3.2.5 Сводная таблица урока</CRITICAL>
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Homework</CRITICAL>
  - `getLessonComplete(lessonId: string)` - получение урока со всеми связанными данными
  - `updateHomeworkCheck(homeworkCheckId: string, data: UpdateHomeworkCheckInput)` - обновление проверки
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Homework Schemas</CRITICAL>
  - `updateHomeworkCheckSchema` - валидация данных при обновлении
- [DYNAMODB_SCHEMA.md](../../../database/DYNAMODB_SCHEMA.md) - формула расчета баллов
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Next.js 15.5.9 App Router документация
- Context7: Shadcn UI Table, Dialog документация

**Критерии приемки:**
- Страница сводной таблицы создана и работает
- Таблица отображает все оценки учеников по уроку
- Фильтры работают корректно
- Колонки показываются/скрываются в зависимости от GradeSettings
- Автоматический расчет баллов работает по формуле
- Inline editing работает для всех типов полей (числовые, чекбоксы, dropdown)
- Modal editing работает для полного редактирования проверки
- Цветовое кодирование работает корректно
- Состояния Loading, Error, Empty отображаются правильно
- Проверка прав доступа работает
- Обновление данных через Server Action работает корректно
- Валидация работает на клиенте и сервере

<output_format>
После выполнения задачи должна быть создана страница сводной таблицы урока с полным функционалом. Таблица должна отображать все оценки учеников, поддерживать фильтрацию, гибридное редактирование (inline + modal), автоматический расчет баллов и зависимость от настроек группы. Все функции должны работать корректно.
</output_format>

---

## Ссылки на документацию проекта

- [app_functionality.md](../../../app_functionality.md) - единственный источник истины для функциональных требований (разделы 4.2-4.7)
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Lessons Actions и Homework Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Lesson Schemas и Homework Schemas
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Lesson Pages (разделы 3.2.1-3.2.5)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - детальные flow для преподавателей (разделы 3.1-3.3, 4.2)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - детальные flow для администраторов (раздел 7.1)

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 2.0  
**Последнее обновление:** 25 декабря 2025

