# Phase 13: Управление уроками (Lessons)

## Описание фазы
Реализация управления уроками: создание, редактирование, просмотр, удаление. Интеграция с BlockNote редактором для описания урока, выбор золотых стихов.

## Зависимости
Phase 12: Управление учебными годами (Academic Years)

## Оценка времени
8-10 часов

## Требования к AI Agent

> [!IMPORTANT]
> - AI Agent при создании программного кода должен использовать актуальную документацию через Context7
> - Для Next.js 15.5.9 должна быть использована документация версии 15.5.9
> - Для BlockNote должна быть использована официальная документация
> - Перед созданием кода необходимо проверять какой функционал NextJS поддерживается AWS Amplify
> - Следовать принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`

## Задачи

### Task 13.01: Создание Server Actions для уроков
- [ ] Создать `app/actions/lessons.ts`
- [ ] Реализовать `createLesson(input)` - создание урока
- [ ] Реализовать `updateLesson(input)` - обновление урока
- [ ] Реализовать `deleteLesson(id)` - удаление урока
- [ ] Реализовать `getLesson(id)` - получение урока
- [ ] Реализовать `listLessons(gradeId, academicYearId)` - список уроков
- [ ] Добавить проверку прав доступа (Teacher - только своя группа)
- [ ] Добавить проверку наличия активного учебного года

**Документация:**
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Lessons
- [VALIDATION.md](../../../api/VALIDATION.md) - раздел Lesson Schemas
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3 Управление уроками

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает
- Проверка активного года работает

---

### Task 13.02: Интеграция BlockNote редактора
- [ ] Убедиться, что BlockNote установлен (из Phase 01)
- [ ] Создать Client Component `components/organisms/lessons/lesson-editor.tsx`
- [ ] Интегрировать BlockNote редактор
- [ ] Настроить сохранение контента в формате JSON
- [ ] Настроить загрузку контента из JSON
- [ ] Протестировать работу редактора

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3.1
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел BlockNote
- BlockNote официальная документация (через Context7)

**Критерии приемки:**
- BlockNote интегрирован
- Редактор работает корректно
- Контент сохраняется и загружается

---

### Task 13.03: Создание формы создания урока
- [ ] Создать Client Component `components/organisms/lessons/lesson-form.tsx`
- [ ] Реализовать форму с полями:
  - Тема урока (обязательно)
  - Дата урока (обязательно)
  - Описание урока (BlockNote редактор)
  - Выбор золотых стихов (множественный выбор, минимум 1)
- [ ] Интегрировать с React Hook Form и Zod валидацией
- [ ] Автоматически определять активный учебный год
- [ ] Добавить обработку ошибок и loading state

**Документация:**
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел New Lesson Form
- [VALIDATION.md](../../../api/VALIDATION.md) - раздел Lesson Schemas
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Create Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.1 Создание нового урока
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 7.1 Создание уроков для любой группы

**Критерии приемки:**
- Форма создана
- Все поля работают
- Валидация работает
- Активный год определяется автоматически

---

### Task 13.04: Реализация выбора золотых стихов
- [ ] Создать компонент `components/molecules/golden-verse-selector.tsx`
- [ ] Реализовать множественный выбор стихов
- [ ] Добавить поиск по стихам
- [ ] Отобразить выбранные стихи
- [ ] Валидировать минимум 1 выбранный стих

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3.1
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)

**Критерии приемки:**
- Выбор стихов работает
- Поиск функционирует
- Валидация работает

---

### Task 13.05: Создание страницы просмотра урока
- [ ] Создать `app/(private)/lessons/[lessonId]/page.tsx`
- [ ] Реализовать Server Component для отображения урока
- [ ] Отобразить: тему, дату, описание (рендеринг BlockNote контента), список золотых стихов
- [ ] Добавить кнопки: "Редактировать", "Проверить ДЗ", "Удалить"
- [ ] Добавить сводную таблицу по ученикам (если есть проверки ДЗ)

**Документация:**
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Lesson Detail
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел View Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 2.3 Подготовка к уроку

**Критерии приемки:**
- Страница просмотра создана
- Вся информация отображается
- Кнопки работают

---

### Task 13.06: Создание страницы списка уроков
- [ ] Создать `app/(private)/grades/[gradeId]/academic-years/[yearId]/lessons/page.tsx`
- [ ] Реализовать Server Component для списка уроков
- [ ] Добавить фильтрацию (поиск, даты)
- [ ] Добавить пагинацию
- [ ] Добавить сортировку по дате
- [ ] Добавить кнопку создания нового урока

**Документация:**
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Lesson List
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Lesson List
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.3 Просмотр списка уроков

**Критерии приемки:**
- Страница списка создана
- Фильтрация работает
- Пагинация работает

---

### Task 13.07: Реализация редактирования урока
- [ ] Создать страницу `app/(private)/lessons/[lessonId]/edit/page.tsx`
- [ ] Использовать форму создания урока с предзаполненными данными
- [ ] Загрузить данные урока при загрузке страницы
- [ ] Обновить урок через Server Action
- [ ] Добавить обработку ошибок

**Документация:**
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Edit Lesson
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Edit Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.2 Редактирование урока

**Критерии приемки:**
- Страница редактирования создана
- Данные предзаполняются
- Обновление работает

---

### Task 13.08: Реализация удаления урока
- [ ] Добавить функцию удаления в Server Action
- [ ] Добавить подтверждение удаления (Dialog)
- [ ] Обработать каскадное удаление (удаление связанных проверок ДЗ)
- [ ] Показать уведомление об успешном удалении

**Документация:**
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Delete Lesson
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Delete Lesson
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 3.3 Просмотр списка уроков

**Критерии приемки:**
- Удаление работает
- Подтверждение показывается
- Каскадное удаление работает

---

### Task 13.09: Проверка прав доступа
- [ ] Обновить утилиту проверки доступа для уроков
- [ ] Teacher может создавать/редактировать уроки только для своих групп
- [ ] Admin может создавать/редактировать уроки для всех групп
- [ ] Использовать проверку в Server Actions и компонентах

**Документация:**
- [SECURITY.md](../../../infrastructure/SECURITY.md) - раздел RBAC
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.1.2

**Критерии приемки:**
- Проверка прав работает
- Teacher ограничен своими группами
- Admin имеет доступ ко всем группам

---

### Task 13.10: Тестирование функционала уроков
- [ ] Протестировать создание урока
- [ ] Протестировать редактирование урока
- [ ] Протестировать просмотр урока
- [ ] Протестировать удаление урока
- [ ] Протестировать BlockNote редактор
- [ ] Протестировать выбор золотых стихов
- [ ] Протестировать проверку прав доступа

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Lessons Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Lesson Schemas
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Lesson Pages
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

