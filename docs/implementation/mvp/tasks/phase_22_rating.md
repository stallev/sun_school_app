# Phase 22: Рейтинг группы

## Описание фазы
Реализация рейтинга группы: таблица рейтинга учеников с баллами, сортировка по баллам, медали для топ-3, фильтрация по периодам (месяц, год, кастомный период), визуализация прогресса.

## Зависимости
Phase 15: Система баллов и домиков

## Оценка времени
5-6 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки React приложений, специализирующийся на:
- Next.js 15.5.9 App Router и Server Components
- React 19 и современные паттерны React
- Shadcn UI и Tailwind CSS
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Фильтрация и сортировка данных
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, React 19, AWS Amplify Gen 1, AppSync GraphQL, Shadcn UI, TypeScript
Ограничения: MVP подход (функциональность важнее идеального кода), доступность критически важна, компоненты должны следовать дизайн-системе
Зависимости: Phase 15 (Система баллов и домиков)
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для реализации рейтинга группы. Правильная реализация рейтинга определит качество мотивации учеников и удобство работы учителей с данными группы.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Изучи MVP_SCOPE.md раздел 2.7 Рейтинг группы - полные требования к функционалу
2. Изучи WIREFRAMES.md раздел Rating Table - визуальные требования
3. Изучи TEACHER_FLOWS.md раздел 7.1 - пользовательские сценарии
4. Используй Context7 для получения актуальной документации Shadcn UI компонентов
5. Используй Context7 для получения актуальной документации Next.js Server Actions
6. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
7. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**
8. **⚠️ ОБЯЗАТЕЛЬНО**: При создании компонентов страниц (page.tsx) строго следуй принципам из [ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md):
   - Страница должна открываться мгновенно при навигации
   - Используй Suspense boundaries с skeleton fallback
   - Разделяй page.tsx (только проверка аутентификации) и content component (загрузка данных)
9. **⚠️ ОБЯЗАТЕЛЬНО**: Для страниц просмотра (list pages, detail pages) используй ISR generation согласно [ai_isr_optimization_guidelines.md](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md):
   - Используй `export const revalidate = 60` вместо `force-dynamic`
   - Добавляй `revalidatePath` и `revalidateTag` в Server Actions после изменений
10. **⚠️ ОБЯЗАТЕЛЬНО**: При создании React компонентов и компонентов страниц строго соблюдай требования из [ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md):
   - Компоненты должны быть arrow functions
   - Максимальный размер компонента: 100 строк кода
   - Использование explicit typing вместо React.FC
   - Следование Atomic Design hierarchy

<CONSTRAINT>Все компоненты должны следовать дизайн-системе проекта и быть доступными (WCAG 2.1 AA). Фильтрация и сортировка должны работать быстро и корректно.</CONSTRAINT>
</critical_instructions>
</requirements>

## Релевантная документация

При создании программного кода для данной фазы используй следующие документы как источники требований и спецификаций:

### Функциональные требования
- **[app_functionality.md](../../../app_functionality.md)** - единственный источник истины для функциональных требований
  - Раздел 4.10 Рейтинг группы - описание функционала рейтинга и лидерборда

### Пользовательские сценарии
- **[USER_FLOW.md](../../../user_flows/USER_FLOW.md)** - общие пользовательские сценарии и flow-диаграммы
  - Раздел 4.6 Рейтинг - flow просмотра рейтинга
- **[TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)** - детальные flow для преподавателей
  - Раздел 7.1 Просмотр рейтинга группы - детальный flow просмотра рейтинга

### Визуальные макеты
- **[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)** - визуальные макеты страниц и компонентов
  - Раздел 3.6 Рейтинг группы - макеты для рейтинга

### API и валидация
- **[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md)** - спецификация Server Actions API
- **[VALIDATION.md](../../../api/VALIDATION.md)** - схемы валидации Zod

### База данных
- **[GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md)** - GraphQL схема
- **[ERD.md](../../../database/ERD.md)** - диаграмма сущностей

### Guidelines
- **[guidelines/react/](../../../guidelines/react/)** - руководящие принципы для React компонентов
  - **[ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: требования для создания React компонентов и компонентов страниц (arrow functions, размер до 100 строк, explicit typing, Atomic Design)
- **[guidelines/nextjs/](../../../guidelines/nextjs/)** - руководящие принципы для Next.js
  - **[ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: принцип построения компонентов страниц (мгновенное открытие страниц, Suspense boundaries, разделение page.tsx и content component)
  - **[ai_isr_optimization_guidelines.md](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: ISR generation для страниц просмотра (revalidate, revalidatePath, revalidateTag)
- **[guidelines/prompts/general_prompt_guidelines.md](../../../guidelines/prompts/general_prompt_guidelines.md)** - общие принципы работы

> [!NOTE]
> **Принцип единственного источника истины:** 
> - `app_functionality.md` является единственным источником истины для функциональных требований
> - Документы в `user_flows/` содержат детальные flow-диаграммы, ссылающиеся на `app_functionality.md`
> - При изменении функциональных требований обновляй `app_functionality.md`, затем при необходимости обновляй ссылки в других документах

## Задачи

### Task 22.01: Создание Server Actions для рейтинга

<context>
<CRITICAL>Это первая и критически важная задача фазы!</CRITICAL> Создание Server Actions для рейтинга является основой для всех остальных компонентов фазы. Правильная реализация расчетов рейтинга определит корректность отображения данных в таблице рейтинга.
</context>

<task>
Создай Server Actions файл `src/actions/rating.ts` с функцией `getGroupRating(gradeId, period)` для получения рейтинга группы. Реализуй расчет рейтинга с учетом периода: весь учебный год, текущий месяц, кастомный период (с даты по дату). Добавь сортировку по баллам (по убыванию).

⚠️ **Важно:** Код Server Actions должен находиться в файле `src/actions/rating.ts` в каталоге `src/actions/`.
</task>

<constraints>
- Server Actions должны иметь директиву `'use server'`
- Используй amplifyData для получения данных через AppSync GraphQL
- Расчет рейтинга должен выполняться на сервере
- Фильтрация по периодам должна быть эффективной
- Сортировка должна быть по баллам (по убыванию)
- Валидация входных данных через Zod обязательна
- Обработка ошибок обязательна
- Проверка прав доступа обязательна (Teacher - только своя группа, Admin - все группы)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Rating для понимания требований к Server Actions
2. Изучи MVP_SCOPE.md раздел 2.7 Рейтинг группы для понимания требований к функционалу
3. Изучи GraphQL схему для понимания структуры данных для расчета рейтинга
4. Определи, какие данные нужны для расчета рейтинга по каждому периоду
5. Продумай логику фильтрации по периодам
6. Используй Context7 для получения актуальной документации Next.js Server Actions
7. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `src/actions/rating.ts` с директивой `'use server'`
- [ ] Реализовать `getGroupRating(gradeId, period)` - получение рейтинга группы
- [ ] Реализовать расчет рейтинга с учетом периода:
  - Весь учебный год
  - Текущий месяц
  - Кастомный период (с даты по дату)
- [ ] Добавить сортировку по баллам (по убыванию)
- [ ] Добавить валидацию входных данных через Zod
- [ ] Добавить проверку прав доступа
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Rating и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (ученики, проверки ДЗ) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.7 Рейтинг группы</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js Server Actions документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных для расчета рейтинга
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте getGradeWithNestedData() для получения группы со всеми данными
- Grade содержит вложенные данные: pupils, academicYears.lessons.homeworkChecks
- Все данные для расчета рейтинга доступны в одном запросе
- Не требуются отдельные запросы для получения данных учеников и их проверок ДЗ
- Снижение количества запросов с ~110 до 1

**Критерии приемки:**
- Server Actions созданы
- Расчет рейтинга работает корректно
- Фильтрация по периодам работает
- Сортировка работает правильно
- Валидация работает
- Проверка прав доступа работает

<output_format>
После выполнения задачи должны быть созданы Server Actions для рейтинга, которые рассчитывают рейтинг группы с учетом периода и сортируют по баллам.
</output_format>

---

### Task 22.02: Создание страницы рейтинга

<context>
Создание страницы рейтинга критически важно для отображения данных рейтинга группы. Страница должна загружать данные через Server Actions и отображать таблицу рейтинга с учениками.
</context>

<task>
Создай страницу рейтинга `app/(private)/grades/[gradeId]/rating/page.tsx` как Server Component. Реализуй загрузку данных рейтинга через Server Actions и отобрази таблицу рейтинга с учениками. Используй компоненты Shadcn UI (Table, Badge) для визуального оформления.
</task>

<constraints>
- Страница должна быть Server Component (по умолчанию)
- Используй Server Actions для загрузки данных
- Компоненты Shadcn UI должны быть из `components/ui/`
- Структура должна соответствовать WIREFRAMES.md
- Таблица должна быть адаптивной для разных экранов
- Обработка ошибок обязательна
- Страница должна включать breadcrumb навигацию с использованием компонента `AppBreadcrumb`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Rating Table для понимания визуальной структуры
2. Изучи USER_FLOW.md раздел Rating для понимания пользовательских сценариев
3. Изучи TEACHER_FLOWS.md раздел 7.1 для понимания контекста использования
4. Используй Context7 для получения актуальной документации Next.js App Router
5. Используй Context7 для получения актуальной документации Shadcn UI компонентов
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/grades/[gradeId]/rating/page.tsx`
- [ ] Реализовать Server Component для загрузки данных рейтинга
- [ ] Отобразить таблицу рейтинга с учениками
- [ ] Использовать компоненты Shadcn UI (Table, Badge)
- [ ] Добавить адаптивность для мобильных устройств
- [ ] Добавить обработку ошибок и loading states
- [ ] Добавить breadcrumb навигацию с использованием компонента `AppBreadcrumb` из `components/shared/breadcrumb.tsx`

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Rating Table</CRITICAL>
- <CRITICAL>[USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Rating</CRITICAL>
- <CRITICAL>[TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 7.1 Просмотр рейтинга группы</CRITICAL>
- Context7: Next.js 15.5.9 App Router документация
- Context7: Shadcn UI компоненты документация
- [src/components/shared/breadcrumb.tsx](../../../../src/components/shared/breadcrumb.tsx) - компонент AppBreadcrumb для breadcrumb навигации

**Критерии приемки:**
- Страница рейтинга создана
- Таблица отображается корректно
- Данные загружаются через Server Actions
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана страница рейтинга, которая загружает данные через Server Actions и отображает таблицу рейтинга с использованием компонентов Shadcn UI.
</output_format>

---

### Task 22.03: Реализация медалей для топ-3

<context>
Реализация медалей для топ-3 критически важна для мотивации учеников. Медали должны визуально выделять лучших учеников и создавать соревновательный элемент в группе.
</context>

<task>
Создай компонент для отображения медалей и интегрируй его с таблицей рейтинга. Реализуй отображение 🥇 для 1 места, 🥈 для 2 места, 🥉 для 3 места. Убедись, что медали отображаются только для топ-3 учеников в рейтинге.
</task>

<constraints>
- Медали должны отображаться только для топ-3
- Медали должны быть визуально заметными
- Компонент должен следовать дизайн-системе
- Медали должны быть доступными (ARIA labels)
- Компонент должен быть переиспользуемым
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.7.1 Таблица рейтинга для понимания требований
2. Изучи DESIGN_SYSTEM.md для понимания визуальных требований
3. Определи, как лучше интегрировать медали с таблицей
4. Продумай доступность медалей (ARIA labels)
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для отображения медалей
- [ ] Отобразить 🥇 для 1 места
- [ ] Отобразить 🥈 для 2 места
- [ ] Отобразить 🥉 для 3 места
- [ ] Интегрировать с таблицей рейтинга
- [ ] Добавить ARIA labels для доступности

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.7.1 Таблица рейтинга</CRITICAL>
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md)

**Критерии приемки:**
- Медали отображаются корректно
- Медали показываются только для топ-3
- Медали доступны (ARIA labels)
- Компонент следует дизайн-системе

<output_format>
После выполнения задачи должны быть реализованы медали для топ-3, которые отображаются в таблице рейтинга и визуально выделяют лучших учеников.
</output_format>

---

### Task 22.04: Реализация фильтрации по периодам

<context>
Реализация фильтрации по периодам критически важна для гибкости работы с рейтингом. Фильтрация должна позволять просматривать рейтинг за разные периоды: весь учебный год, текущий месяц, кастомный период.
</context>

<task>
Создай компонент фильтров периодов для выбора периода рейтинга. Реализуй выбор периода: весь учебный год, текущий месяц, кастомный период (DatePicker для выбора дат). Примени фильтр к рейтингу через Server Actions.
</task>

<constraints>
- Компонент должен быть Client Component (требуется интерактивность)
- Фильтрация должна работать через Server Actions
- DatePicker должен быть из Shadcn UI
- Фильтр должен применяться к рейтингу корректно
- Компонент должен быть доступным (WCAG 2.1 AA)
- Обработка ошибок обязательна
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.7.2 Фильтрация для понимания требований
2. Используй Context7 для получения актуальной документации Shadcn UI DatePicker
3. Определи, как лучше интегрировать фильтры с Server Actions
4. Продумай UX фильтрации (когда применять фильтр)
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент фильтров периодов
- [ ] Реализовать выбор периода:
  - Весь учебный год
  - Текущий месяц
  - Кастомный период (DatePicker для выбора дат)
- [ ] Применить фильтр к рейтингу через Server Actions
- [ ] Добавить обработку ошибок
- [ ] Обеспечить доступность (WCAG 2.1 AA)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.7.2 Фильтрация</CRITICAL>
- Context7: Shadcn UI DatePicker документация
- Context7: React Hook Form документация (если используется)

**Критерии приемки:**
- Фильтрация работает корректно
- Периоды применяются правильно
- DatePicker работает корректно
- Компонент доступен (WCAG 2.1 AA)
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована фильтрация по периодам, которая позволяет выбирать период рейтинга и применять фильтр к данным.
</output_format>

---

### Task 22.05: Реализация визуализации прогресса

<context>
Реализация визуализации прогресса критически важна для понимания динамики успеваемости учеников. Визуализация должна отображать прогресс-бары, домики и badges в рейтинге.
</context>

<task>
Добавь визуализацию прогресса в таблицу рейтинга. Реализуй progress bars для визуализации прогресса, отобрази домики в рейтинге и отобрази badges в рейтинге. Используй компоненты Shadcn UI (Progress) для визуального оформления.
</task>

<constraints>
- Визуализация должна быть понятной и привлекательной
- Компоненты Shadcn UI должны быть из `components/ui/`
- Progress bars должны отображать прогресс корректно
- Домики и badges должны отображаться визуально
- Компонент должен быть доступным (WCAG 2.1 AA)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.7.1 Визуализация прогресса для понимания требований
2. Изучи DESIGN_SYSTEM.md для понимания визуальных требований
3. Определи, как лучше визуализировать прогресс в таблице
4. Продумай отображение домиков и badges
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Добавить progress bars для визуализации прогресса
- [ ] Отобразить домики в рейтинге
- [ ] Отобразить badges в рейтинге
- [ ] Использовать компоненты Shadcn UI (Progress)
- [ ] Обеспечить доступность (WCAG 2.1 AA)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.7.1 Визуализация прогресса</CRITICAL>
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md)
- Context7: Shadcn UI Progress документация

**Критерии приемки:**
- Визуализация прогресса работает
- Домики и badges отображаются корректно
- Компонент следует дизайн-системе
- Компонент доступен (WCAG 2.1 AA)

<output_format>
После выполнения задачи должна быть реализована визуализация прогресса, которая отображает progress bars, домики и badges в таблице рейтинга.
</output_format>

---

### Task 22.06: Тестирование функционала рейтинга

<context>
<CRITICAL>Это финальная задача фазы!</CRITICAL> Тестирование функционала рейтинга критически важно для подтверждения правильности работы всех компонентов. Все функции должны быть протестированы перед переходом к следующей фазе.
</context>

<task>
Протестируй весь функционал рейтинга: расчет рейтинга, сортировку, фильтрацию по периодам, отображение медалей, визуализацию прогресса. Убедись, что все компоненты работают корректно, данные отображаются правильно, и нет критических ошибок.
</task>

<constraints>
- Все функции должны быть протестированы
- Тестирование должно включать проверку на разных экранах (Mobile, Tablet, Desktop)
- Должна быть проверена обработка ошибок
- Должна быть проверена доступность (WCAG 2.1 AA)
- Не должно быть критических ошибок в консоли браузера
- Все данные должны отображаться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Убедись, что все предыдущие задачи выполнены
2. Подготовь тестовые данные для проверки всех функций
3. Определи все сценарии тестирования
4. Проверь работу на разных экранах
5. Проверь обработку ошибок
6. Только после этого проводи тестирование
</thinking>

**Действия:**
- [ ] Протестировать расчет рейтинга
- [ ] Протестировать сортировку
- [ ] Протестировать фильтрацию по периодам
- [ ] Протестировать отображение медалей
- [ ] Протестировать визуализацию прогресса
- [ ] Проверить работу на разных экранах (Mobile, Tablet, Desktop)
- [ ] Проверить обработку ошибок
- [ ] Проверить доступность (WCAG 2.1 AA)
- [ ] Проверить отсутствие ошибок в консоли браузера

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.7 Рейтинг группы
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 7.1

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно
- Нет критических ошибок
- Компоненты адаптивны для разных экранов
- Доступность соответствует WCAG 2.1 AA

<output_format>
После выполнения задачи весь функционал рейтинга должен быть протестирован, все функции должны работать корректно, и не должно быть критических ошибок.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Rating Actions
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Rating Pages
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.7

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025
