# Phase 12: Управление учебными годами (Academic Years)

## Описание фазы
Реализация управления учебными годами: создание, завершение, автоматическое определение активного года, блокировка создания уроков без активного года.

## Зависимости
Phase 11: Управление группами (Grades)

## Оценка времени
4-5 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Бизнес-логика и управление состоянием данных
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, логика активного учебного года критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления учебными годами. Правильная реализация логики активного года определит корректность работы всей системы уроков.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Логика определения активного учебного года обязательна. Создание уроков должно блокироваться, если нет активного года для группы.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 12.01: Создание Server Actions для учебных годов

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для учебных годов являются основой логики управления учебными годами. Правильная реализация с проверкой прав доступа и логикой активного года определит корректность работы всей системы уроков.
</context>

<task>
Создай Server Actions для управления учебными годами в файле `actions/academicYears.ts`. Реализуй все операции с проверкой прав доступа и логикой определения активного года.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа (Admin only для создания, обновления, завершения)
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
- Логика активного года должна быть реализована корректно
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Academic Years для понимания требований к API
2. Изучи MVP_SCOPE.md раздел 2.2.2 Учебные годы для понимания бизнес-логики
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа
5. Продумай логику определения активного года (статус ACTIVE)
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/academicYears.ts` с директивой `'use server'`
- [ ] Реализовать `createAcademicYear(input)` - создание года (Admin only)
- [ ] Реализовать `updateAcademicYear(input)` - обновление года (Admin only)
- [ ] Реализовать `getActiveAcademicYear(gradeId)` - получение активного года группы
- [ ] Реализовать `listAcademicYears(gradeId)` - список годов группы
- [ ] Реализовать `completeAcademicYear(gradeId)` - завершение года (Admin only)
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Academic Years и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (группа, уроки) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.2 Учебные годы</CRITICAL>
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/academicYears.ts](../../../../src/lib/validation/academicYears.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getAcademicYear, listAcademicYears)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createAcademicYear, updateAcademicYear)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для учебных годов
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно
- Валидация работает корректно
- Логика активного года работает правильно

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления учебными годами. Все функции должны иметь проверку прав доступа и валидацию через Zod схемы. Логика определения активного года должна работать корректно.
</output_format>

---

### Task 12.02: Реализация логики определения активного года

<context>
<CRITICAL>Это критически важная задача для бизнес-логики!</CRITICAL> Логика определения активного учебного года является основой для работы всей системы уроков. Правильная реализация гарантирует, что уроки создаются только в активном учебном году.
</context>

<task>
Создай утилиту для определения активного учебного года группы. Реализуй функцию, которая ищет год со статусом ACTIVE для группы и возвращает его или null. Используй функцию в Server Actions и компонентах.
</task>

<constraints>
- Функция должна искать год со статусом ACTIVE для конкретной группы
- Функция должна возвращать активный год или null
- Функция должна быть оптимизирована для производительности
- Функция должна использоваться во всех местах, где требуется проверка активного года
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.2.2 для понимания бизнес-логики активного года
2. Изучи DATA_MODELING.md для понимания структуры данных учебных годов
3. Определи структуру функции и логику поиска активного года
4. Продумай оптимизацию запроса к базе данных
5. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/academicYears.ts`
- [ ] Реализовать функцию `getActiveYear(gradeId)`:
  - Ищет год со статусом ACTIVE для группы через amplifyData
  - Возвращает активный год или null
  - Обрабатывает ошибки
- [ ] Использовать функцию в Server Actions (getActiveAcademicYear, createLesson)
- [ ] Использовать функцию в компонентах при необходимости

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.2</CRITICAL>
- [DATA_MODELING.md](../../../database/DATA_MODELING.md)
- Context7: AWS Amplify Gen 1 amplifyData документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных учебных годов
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)

**Критерии приемки:**
- Логика определения активного года работает корректно
- Функция возвращает правильный год или null
- Функция используется во всех необходимых местах
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана утилита для определения активного учебного года. Функция должна работать корректно и использоваться во всех Server Actions и компонентах, где требуется проверка активного года.
</output_format>

---

### Task 12.03: Создание UI для управления учебными годами

<context>
UI для управления учебными годами позволяет Admin управлять учебными годами группы. Правильное отображение статусов и доступность действий критически важны для удобства работы с учебными годами.
</context>

<task>
Создай страницу для управления учебными годами группы. Реализуй Server Component для отображения списка учебных годов с их статусами. Добавь кнопки создания нового года и завершения активного года для Admin.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Отображай список учебных годов группы
- Показывай статус каждого года (ACTIVE, COMPLETED) с визуальными индикаторами
- Кнопка создания нового года должна быть видна только для Admin
- Кнопка завершения активного года должна быть видна только для Admin
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md для понимания дизайна страницы
2. Изучи USER_FLOW.md для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи структуру данных для отображения списка годов
5. Продумай визуальное отображение статусов (ACTIVE, COMPLETED)
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать страницу `app/(private)/grades/[gradeId]/academic-years/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Отобразить список учебных годов группы
- [ ] Показать статус каждого года (ACTIVE, COMPLETED) с Badge компонентами
- [ ] Добавить кнопку создания нового года (Admin only)
- [ ] Добавить кнопку завершения активного года (Admin only)
- [ ] Использовать компоненты Shadcn UI (Table, Card, Badge, Button)

**Документация:**
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 2.1 Вход в систему и навигация
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных
  - [src/lib/validation/academicYears.ts](../../../../src/lib/validation/academicYears.ts) - для валидации форм

**Критерии приемки:**
- UI создан и работает
- Список годов отображается корректно
- Статусы отображаются с визуальными индикаторами
- Действия работают и доступны только для Admin

<output_format>
После выполнения задачи должна быть создана страница управления учебными годами. Список годов должен отображаться корректно с визуальными индикаторами статусов. Все действия должны работать и быть доступны только для Admin.
</output_format>

---

### Task 12.04: Реализация глобального завершения учебного года

<context>
Глобальное завершение учебного года позволяет Admin завершить все активные учебные годы одновременно. Это полезная функция для завершения учебного года во всех группах школы. Правильная реализация критически важна для корректности данных.
</context>

<task>
Реализуй Server Action для глобального завершения всех активных учебных годов. Создай функцию, которая завершает все активные годы, изменяя их статус на COMPLETED. Добавь UI для выполнения действия.
</task>

<constraints>
- Функция должна быть доступна только для Admin
- Функция должна завершать все активные учебные годы
- Изменение статуса должно быть атомарным (транзакция)
- Должна быть добавлена проверка прав доступа
- UI должен показывать подтверждение перед выполнением действия
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.12.1 для понимания требований
2. Определи структуру функции и логику завершения всех активных годов
3. Продумай атомарность операции (транзакция или batch операция)
4. Определи UI для выполнения действия (кнопка с подтверждением)
5. Только после этого реализуй функцию
</thinking>

**Действия:**
- [ ] Реализовать Server Action `completeAllAcademicYears()` (Admin only)
- [ ] Добавить проверку прав доступа через Cognito
- [ ] Реализовать логику завершения всех активных учебных годов
- [ ] Изменить статус всех активных годов на COMPLETED через amplifyData
- [ ] Добавить обработку ошибок
- [ ] Добавить UI для выполнения действия (кнопка с Dialog подтверждением)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12.1</CRITICAL>
- Context7: AWS Amplify Gen 1 batch операции документация

**Критерии приемки:**
- Глобальное завершение работает корректно
- Все активные годы завершены
- Проверка прав доступа работает
- UI с подтверждением работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция глобального завершения всех активных учебных годов. Функция должна работать корректно, завершая все активные годы и изменяя их статус на COMPLETED. UI должен показывать подтверждение перед выполнением действия.
</output_format>

---

### Task 12.05: Блокировка создания уроков без активного года

<context>
<CRITICAL>Это критически важная задача для бизнес-логики!</CRITICAL> Блокировка создания уроков без активного учебного года является обязательным бизнес-правилом MVP. Правильная реализация гарантирует, что уроки создаются только в активном учебном году.
</context>

<task>
Реализуй блокировку создания уроков без активного учебного года. Обнови Server Action `createLesson` для проверки наличия активного года перед созданием урока. Обнови UI создания урока для отображения сообщения и блокировки формы, если активного года нет.
</task>

<constraints>
- Проверка наличия активного года должна выполняться в Server Action `createLesson`
- Если активного года нет, должна возвращаться ошибка с понятным сообщением
- UI должен проверять наличие активного года перед отображением формы
- Если активного года нет, форма должна быть заблокирована с понятным сообщением
- Сообщения должны быть понятны пользователю
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.2.2 Бизнес-правило MVP для понимания требований
2. Изучи SERVER_ACTIONS.md раздел Lessons для понимания структуры Server Action
3. Определи место проверки активного года в Server Action
4. Продумай UI для отображения сообщения и блокировки формы
5. Только после этого реализуй блокировку
</thinking>

**Действия:**
- [ ] Обновить Server Action `createLesson`:
  - Добавить проверку наличия активного года через утилиту `getActiveYear(gradeId)`
  - Возвращать ошибку с понятным сообщением, если активного года нет
- [ ] Обновить UI создания урока:
  - Проверять наличие активного года при загрузке страницы
  - Показывать сообщение, если активного года нет
  - Блокировать форму создания урока, если активного года нет
  - Использовать Alert или AlertDialog для отображения сообщения

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.2 Бизнес-правило MVP</CRITICAL>
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Lessons
- Context7: Next.js 15.5.9 Server Actions документация

**Критерии приемки:**
- Блокировка работает корректно в Server Action
- UI блокирует форму, если активного года нет
- Сообщения понятны пользователю
- Ошибки обрабатываются корректно

<output_format>
После выполнения задачи должна быть реализована блокировка создания уроков без активного учебного года. Server Action должен проверять наличие активного года и возвращать ошибку, если его нет. UI должен блокировать форму и показывать понятное сообщение пользователю.
</output_format>

---

### Task 12.06: Тестирование функционала учебных годов

<context>
Тестирование функционала учебных годов является финальным этапом фазы. Комплексное тестирование всех функций, логики активного года и блокировки создания уроков критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления учебными годами. Протестируй создание, завершение, определение активного года и блокировку создания уроков для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции управления учебными годами
- Тестирование должно выполняться для всех ролей (Admin)
- Логика активного года должна быть протестирована для всех сценариев
- Блокировка создания уроков должна быть протестирована
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать создание учебного года (Admin)
- [ ] Протестировать завершение года (Admin)
- [ ] Протестировать глобальное завершение всех активных годов (Admin)
- [ ] Протестировать определение активного года для всех сценариев
- [ ] Протестировать блокировку создания уроков без активного года
- [ ] Протестировать создание урока с активным годом
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех сценариев
- Логика активного года работает правильно
- Блокировка создания уроков работает корректно
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления учебными годами. Все функции должны работать корректно, логика активного года должна работать правильно, блокировка создания уроков должна работать. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Academic Years Actions
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.2

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

