# Phase 16: Управление учениками (Pupils)

## Описание фазы
Реализация CRUD операций для учеников: создание, редактирование, просмотр, деактивация. Привязка к группам и семьям, просмотр истории групп.

## Зависимости
Phase 11: Управление группами (Grades)

## Оценка времени
6-7 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- CRUD операции и управление данными
- Связи между сущностями (ученики, группы, семьи)
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, управление учениками критически важно, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления учениками. Правильная реализация CRUD операций, привязки к группам и семьям критически важна для работы системы.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию
6. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**

<CONSTRAINT>Все операции с учениками доступны только для Admin. Привязка к группам и семьям должна работать корректно. История групп должна отслеживаться.</CONSTRAINT>
</critical_instructions>
</requirements>

## Релевантная документация

При создании программного кода для данной фазы используй следующие документы как источники требований и спецификаций:

### Функциональные требования
- **[app_functionality.md](../../../app_functionality.md)** - единственный источник истины для функциональных требований
  - Раздел 5.3 Управление учениками - описание функционала управления учениками

### Пользовательские сценарии
- **[USER_FLOW.md](../../../user_flows/USER_FLOW.md)** - общие пользовательские сценарии и flow-диаграммы
  - Раздел 5.2 Управление учениками - flow управления учениками
- **[ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)** - детальные flow для администраторов
  - Раздел 4.1 Создание нового ученика - flow создания ученика
  - Раздел 4.2 Перемещение ученика между группами - flow перемещения

### Визуальные макеты
- **[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)** - визуальные макеты страниц и компонентов
  - Раздел 4.3 Управление учениками - макеты для управления учениками

### API и валидация
- **[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md)** - спецификация Server Actions API
  - Раздел Pupils - API для управления учениками
- **[VALIDATION.md](../../../api/VALIDATION.md)** - схемы валидации Zod
  - Раздел Pupil Schemas - схемы валидации для учеников

### База данных
- **[GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md)** - GraphQL схема
- **[ERD.md](../../../database/ERD.md)** - диаграмма сущностей

### Guidelines
- **[guidelines/react/](../../../guidelines/react/)** - руководящие принципы для React компонентов
- **[guidelines/nextjs/](../../../guidelines/nextjs/)** - руководящие принципы для Next.js
- **[guidelines/prompts/general_prompt_guidelines.md](../../../guidelines/prompts/general_prompt_guidelines.md)** - общие принципы работы

> [!NOTE]
> **Принцип единственного источника истины:** 
> - `app_functionality.md` является единственным источником истины для функциональных требований
> - Документы в `user_flows/` содержат детальные flow-диаграммы, ссылающиеся на `app_functionality.md`
> - При изменении функциональных требований обновляй `app_functionality.md`, затем при необходимости обновляй ссылки в других документах

## Задачи

### Task 16.01: Создание Server Actions для учеников

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для учеников являются основой всего функционала управления учениками. Правильная реализация с проверкой прав доступа, привязкой к группам и отслеживанием истории критически важна для работы системы.
</context>

<task>
Создай Server Actions для управления учениками в файле `actions/pupils.ts`. Реализуй все CRUD операции, назначение на группу и получение истории групп с проверкой прав доступа и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа (Admin only)
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
- История групп должна отслеживаться при назначении на группу
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Pupils для понимания требований к API
2. Изучи VALIDATION.md раздел Pupil Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа
5. Продумай логику отслеживания истории групп
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/pupils.ts` с директивой `'use server'`
- [ ] Реализовать CRUD операции: create, update, delete, get, list
- [ ] Реализовать `assignPupilToGrade(pupilId, gradeId)` - назначение на группу с обновлением истории
- [ ] Реализовать `getPupilHistory(pupilId)` - история групп ученика
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito (Admin only)
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Pupils и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (проверки ДЗ, достижения, группа) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Pupil Schemas</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.2 Управление учениками</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/pupils.ts](../../../../src/lib/validation/pupils.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getPupil, listPupils)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createPupil, updatePupil, deletePupil)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для учеников
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте getPupilWithNestedData() для получения ученика со всеми связанными данными
- Pupil содержит вложенные данные: homeworkChecks (с lesson), achievements (с achievement), families (с family)
- HomeworkCheck содержит вложенные данные pupil благодаря @belongsTo
- Не требуются отдельные запросы для получения связанных данных

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно (Admin only)
- Валидация работает корректно
- История групп отслеживается

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления учениками. Все функции должны иметь проверку прав доступа (Admin only) и валидацию через Zod схемы. История групп должна отслеживаться при назначении на группу.
</output_format>

---

### Task 16.02: Создание UI для списка учеников

<context>
Страница списка учеников является основной точкой входа для работы с учениками. Правильная реализация с фильтрацией, поиском и пагинацией критически важна для удобства работы с большим количеством учеников.
</context>

<task>
Создай страницу списка учеников. Реализуй Server Component для отображения списка учеников с фильтрацией, поиском и пагинацией. Добавь кнопку создания нового ученика для Admin.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Фильтрация должна работать по поиску (имя, фамилия)
- Пагинация должна быть реализована для больших списков
- Кнопка создания нового ученика должна быть видна только для Admin
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Pupils List для понимания дизайна
2. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
3. Определи структуру данных для отображения списка учеников
4. Продумай логику фильтрации, поиска и пагинации
5. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/pupils/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Реализовать таблицу со списком учеников
- [ ] Добавить фильтрацию и поиск (по имени, фамилии)
- [ ] Добавить пагинацию для больших списков
- [ ] Добавить кнопку создания нового ученика (Admin only)
- [ ] Использовать компоненты Shadcn UI (Table, Input, Button, Pagination)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Pupils List</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Admin flows
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 4.1 Создание нового ученика
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных групп
  - [src/lib/validation/pupils.ts](../../../../src/lib/validation/pupils.ts) - для валидации форм

**Критерии приемки:**
- Страница списка создана
- Фильтрация работает корректно
- Пагинация работает
- Кнопка создания работает для Admin

<output_format>
После выполнения задачи должна быть создана страница списка учеников. Список должен отображаться с фильтрацией, поиском и пагинацией. Все функции должны работать корректно.
</output_format>

---

### Task 16.03: Создание формы создания/редактирования ученика

<context>
Форма создания и редактирования ученика является ключевым компонентом для управления учениками. Правильная реализация с валидацией, выбором группы и семьи критически важна для обеспечения целостности данных.
</context>

<task>
Создай Client Component формы для создания и редактирования ученика. Реализуй форму с полями: имя, фамилия, возраст, группа, семья. Интегрируй с React Hook Form и Zod валидацией. Добавь выбор группы и семьи из списков.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Все поля должны быть валидированы через Zod схемы
- Выбор группы должен быть из списка всех групп
- Выбор семьи должен быть опциональным из списка всех семей
- Используй компоненты Shadcn UI (Form, Input, Select, Button)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Pupil Form для понимания дизайна
2. Изучи VALIDATION.md раздел Pupil Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Определи структуру формы и логику работы в режиме создания/редактирования
5. Только после этого создавай компонент формы
</thinking>

**Действия:**
- [ ] Создать Client Component `components/admin/pupils/pupil-form.tsx`
- [ ] Реализовать форму с полями: имя, фамилия, возраст, группа, семья
- [ ] Интегрировать с React Hook Form
- [ ] Добавить Zod валидацию через @hookform/resolvers
- [ ] Добавить выбор группы из списка через Select или Combobox
- [ ] Добавить выбор семьи из списка (опционально) через Select или Combobox
- [ ] Использовать компоненты Shadcn UI (Form, Input, Select, Button, Dialog)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Pupil Form</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Pupil Schemas</CRITICAL>
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 4.1 Создание нового ученика
- Context7: React Hook Form документация
- Context7: Zod документация
- **Код реализации:**
  - [src/lib/validation/pupils.ts](../../../../src/lib/validation/pupils.ts) - схемы валидации для форм
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Критерии приемки:**
- Форма создана и работает
- Валидация работает для всех полей
- Выбор группы и семьи работает
- Форма интегрирована с Server Actions

<output_format>
После выполнения задачи должна быть создана форма создания и редактирования ученика. Форма должна быть полностью функциональной с валидацией, выбором группы и семьи. Компонент должен быть готов к использованию в страницах создания и редактирования ученика.
</output_format>

---

### Task 16.04: Реализация назначения ученика на группу

<context>
Назначение ученика на группу является важной функцией для управления учениками. Правильная реализация с обновлением истории групп критически важна для отслеживания перемещений учеников между группами.
</context>

<task>
Создай компонент для назначения ученика на группу. Реализуй выбор группы из списка, сохранение назначения через Server Action и обновление истории групп ученика.
</task>

<constraints>
- Компонент должен позволять выбирать группу из списка всех групп
- Назначение должно сохраняться через Server Action `assignPupilToGrade`
- История групп должна обновляться при назначении
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.2 Управление группами для понимания требований
2. Определи структуру компонента и логику назначения на группу
3. Продумай обновление истории групп
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для назначения на группу (можно интегрировать в форму ученика)
- [ ] Реализовать выбор группы из списка через Select или Combobox
- [ ] Сохранить назначение через Server Action `assignPupilToGrade`
- [ ] Обновить историю групп ученика при назначении
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.2 Управление группами

**Критерии приемки:**
- Назначение на группу работает корректно
- История обновляется при назначении
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент для назначения ученика на группу. Назначение должно работать корректно, история групп должна обновляться при назначении.
</output_format>

---

### Task 16.05: Реализация привязки к семье

<context>
Привязка ученика к семье необходима для управления семейными связями. Правильная реализация с выбором семьи и отображением в профиле критически важна для работы с семьями.
</context>

<task>
Создай компонент для привязки ученика к семье. Реализуй выбор семьи из списка, сохранение привязки через Server Action и отображение семьи в профиле ученика.
</task>

<constraints>
- Компонент должен позволять выбирать семью из списка всех семей
- Привязка должна быть опциональной
- Привязка должна сохраняться через Server Action
- Семья должна отображаться в профиле ученика
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.2 Связывание с семьями для понимания требований
2. Определи структуру компонента и логику привязки к семье
3. Продумай отображение семьи в профиле ученика
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для привязки к семье (можно интегрировать в форму ученика)
- [ ] Реализовать выбор семьи из списка через Select или Combobox
- [ ] Сохранить привязку через Server Action (updatePupil)
- [ ] Отобразить семью в профиле ученика
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.2 Связывание с семьями

**Критерии приемки:**
- Привязка к семье работает корректно
- Семья отображается в профиле ученика
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент для привязки ученика к семье. Привязка должна работать корректно, семья должна отображаться в профиле ученика.
</output_format>

---

### Task 16.06: Реализация просмотра истории групп

<context>
Просмотр истории групп необходим для отслеживания перемещений учеников между группами. Правильное отображение истории с датами начала и окончания критически важно для понимания истории ученика.
</context>

<task>
Создай компонент для отображения истории групп ученика. Отобрази все группы, в которых был ученик, с датами начала и окончания пребывания. Добавь возможность просмотра в профиле ученика.
</task>

<constraints>
- Компонент должен отображать все группы, в которых был ученик
- Должны отображаться даты начала и окончания пребывания в группе
- Компонент должен быть доступен в профиле ученика
- Используй компоненты Shadcn UI для отображения
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.2 Просмотр истории групп для понимания требований
2. Определи структуру компонента и логику отображения истории
3. Продумай формат отображения дат
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для отображения истории групп `components/shared/pupil-history.tsx`
- [ ] Отобразить все группы, в которых был ученик через Server Action `getPupilHistory`
- [ ] Показать даты начала и окончания пребывания в группе
- [ ] Добавить возможность просмотра в профиле ученика
- [ ] Использовать компоненты Shadcn UI (Table, Card, Badge)
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.2 Просмотр истории групп

**Критерии приемки:**
- История групп отображается корректно
- Данные корректны (даты, группы)
- Компонент доступен в профиле ученика
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент для отображения истории групп ученика. История должна отображаться корректно с датами начала и окончания пребывания в группе. Компонент должен быть доступен в профиле ученика.
</output_format>

---

### Task 16.07: Тестирование функционала учеников

<context>
Тестирование функционала учеников является финальным этапом фазы. Комплексное тестирование всех функций, CRUD операций, назначения на группу, привязки к семье и просмотра истории критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления учениками. Протестируй CRUD операции, назначение на группу, привязку к семье и просмотр истории для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции управления учениками
- Тестирование должно выполняться для роли Admin
- CRUD операции должны быть протестированы
- Назначение на группу должно быть протестировано
- Привязка к семье должна быть протестирована
- Просмотр истории должен быть протестирован
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовый аккаунт Admin
4. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать CRUD операции (create, update, delete, get, list)
- [ ] Протестировать назначение на группу
- [ ] Протестировать привязку к семье
- [ ] Протестировать просмотр истории групп
- [ ] Протестировать проверку прав доступа (Admin only)
- [ ] Протестировать валидацию форм
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для Admin
- CRUD операции работают корректно
- Назначение на группу работает
- Привязка к семье работает
- Просмотр истории работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления учениками. Все функции должны работать корректно, CRUD операции должны работать, назначение на группу и привязка к семье должны работать. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Pupils Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Pupil Schemas
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.2

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

