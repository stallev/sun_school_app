# Phase 23: Расписание группы (Calendar)

## Описание фазы
Реализация расписания группы: календарь с событиями (уроки, выездные мероприятия, отмена уроков), CRUD операции для событий, интеграция с уроками, цветовые индикаторы типов событий.

## Зависимости
Phase 13: Управление уроками (Lessons)

## Оценка времени
6-7 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки React приложений, специализирующийся на:
- Next.js 15.5.9 App Router и Server Components
- React 19 и современные паттерны React
- Библиотеки календарей (react-day-picker, date-fns)
- Shadcn UI и Tailwind CSS
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- CRUD операции и управление событиями
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, React 19, AWS Amplify Gen 1, AppSync GraphQL, Shadcn UI, react-day-picker (или другая библиотека), TypeScript
Ограничения: MVP подход (функциональность важнее идеального кода), доступность критически важна, компоненты должны следовать дизайн-системе
Зависимости: Phase 13 (Управление уроками)
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для реализации расписания группы. Правильная реализация календаря определит качество планирования уроков и удобство работы учителей с расписанием.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Изучи MVP_SCOPE.md раздел 2.8 Расписание группы - полные требования к функционалу
2. Изучи WIREFRAMES.md раздел Calendar - визуальные требования
3. Изучи TEACHER_FLOWS.md раздел 6.1 - пользовательские сценарии
4. Используй Context7 для получения актуальной документации библиотек календарей (react-day-picker)
5. Используй Context7 для получения актуальной документации Shadcn UI компонентов
6. Используй Context7 для получения актуальной документации Next.js Server Actions
7. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
8. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**

<CONSTRAINT>Все компоненты должны следовать дизайн-системе проекта и быть доступными (WCAG 2.1 AA). Календарь должен быть интерактивным и адаптивным для разных экранов. Выбор библиотеки календаря должен быть обоснован совместимостью с Next.js 15.5.9.</CONSTRAINT>
</critical_instructions>
</requirements>

## Релевантная документация

При создании программного кода для данной фазы используй следующие документы как источники требований и спецификаций:

### Функциональные требования
- **[app_functionality.md](../../../app_functionality.md)** - единственный источник истины для функциональных требований
  - Раздел 4.3.1 Расписание группы - описание функционала расписания и календаря

### Пользовательские сценарии
- **[USER_FLOW.md](../../../user_flows/USER_FLOW.md)** - общие пользовательские сценарии и flow-диаграммы
  - Раздел 4.7 Расписание - flow работы с расписанием
- **[TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)** - детальные flow для преподавателей
  - Раздел 6.1 Добавление события в расписание - детальный flow добавления события

### Визуальные макеты
- **[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)** - визуальные макеты страниц и компонентов
  - Раздел 3.5 Расписание группы - макеты для расписания и календаря

### API и валидация
- **[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md)** - спецификация Server Actions API
  - Раздел Schedule - API для управления расписанием
- **[VALIDATION.md](../../../api/VALIDATION.md)** - схемы валидации Zod
  - Раздел Schedule Schemas - схемы валидации для событий расписания

### База данных
- **[GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md)** - GraphQL схема
- **[ERD.md](../../../database/ERD.md)** - диаграмма сущностей

### Guidelines
- **[guidelines/react/](../../../guidelines/react/)** - руководящие принципы для React компонентов
- **[guidelines/nextjs/](../../../guidelines/nextjs/)** - руководящие принципы для Next.js
- **[guidelines/prompts/general_prompt_guidelines.md](../../../guidelines/prompts/general_prompt_guidelines.md)** - общие принципы работы

> [!NOTE]
> **Принцип единственного источника истины:** 
> - `app_functionality.md` является единственным источником истины для функциональных требований
> - Документы в `user_flows/` содержат детальные flow-диаграммы, ссылающиеся на `app_functionality.md`
> - При изменении функциональных требований обновляй `app_functionality.md`, затем при необходимости обновляй ссылки в других документах

## Задачи

### Task 23.01: Выбор библиотеки календаря

<context>
<CRITICAL>Это первая и критически важная задача фазы!</CRITICAL> Выбор правильной библиотеки календаря определит успех всей фазы. Библиотека должна быть совместима с Next.js 15.5.9, поддерживать Server Components, быть доступной и следовать дизайн-системе проекта.
</context>

<task>
Изучи варианты библиотек календаря для React и выбери наиболее подходящую (например, react-day-picker или кастомное решение). Установи библиотеку и проверь совместимость с Next.js 15.5.9. Убедись, что библиотека поддерживает Server Components и доступность.
</task>

<constraints>
- Библиотека должна быть совместима с Next.js 15.5.9
- Библиотека должна поддерживать Server Components (или работать с Client Components)
- Библиотека должна быть доступной (WCAG 2.1 AA)
- Библиотека должна следовать дизайн-системе проекта
- Библиотека должна быть активно поддерживаемой
- Если используется Shadcn UI Calendar, он основан на react-day-picker
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.8 Расписание группы для понимания требований
2. Используй Context7 для получения актуальной документации react-day-picker
3. Проверь совместимость react-day-picker с Next.js 15.5.9
4. Проверь, используется ли Shadcn UI Calendar (он основан на react-day-picker)
5. Определи, какая библиотека лучше подходит для проекта
6. Только после этого устанавливай библиотеку
</thinking>

**Действия:**
- [ ] Изучить варианты библиотек календаря для React
- [ ] Выбрать библиотеку (например, react-day-picker или кастомное решение)
- [ ] Установить библиотеку: `npm install react-day-picker` (или другую)
- [ ] Проверить совместимость с Next.js 15.5.9
- [ ] Проверить поддержку Server Components
- [ ] Проверить доступность (WCAG 2.1 AA)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8 Расписание группы</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- <CRITICAL>react-day-picker официальная документация (через Context7)</CRITICAL>
- Context7: Shadcn UI Calendar документация (если используется)

**Критерии приемки:**
- Библиотека выбрана и установлена
- Совместимость проверена
- Библиотека поддерживает Server Components или работает с Client Components
- Библиотека доступна (WCAG 2.1 AA)

<output_format>
После выполнения задачи должна быть выбрана и установлена библиотека календаря, совместимая с Next.js 15.5.9 и поддерживающая требования проекта.
</output_format>

---

### Task 23.02: Создание Server Actions для событий расписания

<context>
Создание Server Actions для событий расписания критически важно для управления событиями календаря. Server Actions должны поддерживать все CRUD операции и проверку прав доступа.
</context>

<task>
Создай Server Actions файл `actions/gradeEvents.ts` с CRUD операциями для событий расписания: create, update, delete, get, list. Реализуй функцию `getGradeEvents(gradeId, date)` для получения событий на дату. Добавь проверку прав доступа (Teacher - только своя группа, Admin - все группы).
</task>

<constraints>
- Server Actions должны иметь директиву `'use server'`
- Используй amplifyData для получения данных через AppSync GraphQL
- Все CRUD операции должны быть реализованы
- Валидация входных данных через Zod обязательна
- Проверка прав доступа обязательна
- Обработка ошибок обязательна
- Функция `getGradeEvents` должна эффективно получать события на дату
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Grade Events для понимания требований к Server Actions
2. Изучи VALIDATION.md раздел Grade Event Schemas для понимания схем валидации
3. Изучи MVP_SCOPE.md раздел 2.8.2 Управление событиями для понимания требований
4. Изучи GraphQL схему для понимания структуры данных GradeEvent
5. Определи, какие поля нужны для событий
6. Используй Context7 для получения актуальной документации Next.js Server Actions
7. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/gradeEvents.ts`
- [ ] Реализовать CRUD операции: create, update, delete, get, list
- [ ] Реализовать `getGradeEvents(gradeId, date)` - получение событий на дату
- [ ] Добавить проверку прав доступа
- [ ] Добавить валидацию входных данных через Zod
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Grade Events и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (группа, урок) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Grade Event Schemas</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8.2 Управление событиями</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js Server Actions документация
- **Код реализации:**
  - [src/lib/validation/gradeEvents.ts](../../../../src/lib/validation/gradeEvents.ts) - для валидации событий
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных уроков и событий
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - для создания/обновления событий
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте getGradeWithNestedData() для получения группы с событиями
- Grade содержит вложенные данные events через @hasMany
- Не требуются отдельные запросы для получения событий группы

**Критерии приемки:**
- Все Server Actions созданы
- CRUD операции работают корректно
- Проверка прав доступа работает
- Валидация работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должны быть созданы Server Actions для событий расписания, которые поддерживают все CRUD операции и проверку прав доступа.
</output_format>

---

### Task 23.03: Создание календаря с событиями

<context>
Создание календаря с событиями критически важно для отображения расписания группы. Календарь должен отображать события на соответствующих датах и поддерживать навигацию по месяцам.
</context>

<task>
Создай страницу календаря `app/(private)/grades/[gradeId]/schedule/page.tsx` как Server Component. Реализуй календарь с отображением событий, добавь навигацию по месяцам и отобрази события на календаре. Используй выбранную библиотеку календаря и компоненты Shadcn UI.
</task>

<constraints>
- Страница должна быть Server Component (по умолчанию)
- Используй Server Actions для загрузки данных событий
- Календарь должен отображать события на соответствующих датах
- Навигация по месяцам должна работать
- Компоненты Shadcn UI должны быть из `components/ui/`
- Календарь должен быть адаптивным для разных экранов
- Обработка ошибок обязательна
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Calendar для понимания визуальной структуры
2. Изучи USER_FLOW.md раздел Schedule для понимания пользовательских сценариев
3. Изучи TEACHER_FLOWS.md раздел 6.1 для понимания контекста использования
4. Используй Context7 для получения актуальной документации выбранной библиотеки календаря
5. Используй Context7 для получения актуальной документации Next.js App Router
6. Только после этого создавай календарь
</thinking>

**Действия:**
- [ ] Создать `app/(private)/grades/[gradeId]/schedule/page.tsx`
- [ ] Реализовать календарь с отображением событий
- [ ] Добавить навигацию по месяцам
- [ ] Отобразить события на календаре
- [ ] Использовать выбранную библиотеку календаря
- [ ] Использовать компоненты Shadcn UI
- [ ] Добавить адаптивность для мобильных устройств
- [ ] Добавить обработку ошибок и loading states

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Calendar</CRITICAL>
- <CRITICAL>[USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Schedule</CRITICAL>
- <CRITICAL>[TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 6.1 Добавление события в расписание</CRITICAL>
- Context7: Библиотека календаря документация
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Календарь создан
- События отображаются корректно
- Навигация по месяцам работает
- Календарь адаптивен для разных экранов
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан календарь с событиями, который отображает события на соответствующих датах и поддерживает навигацию по месяцам.
</output_format>

---

### Task 23.04: Реализация цветовых индикаторов типов событий

<context>
Реализация цветовых индикаторов типов событий критически важна для быстрого понимания типа события в календаре. Цветовые индикаторы должны быть понятными и следовать дизайн-системе проекта.
</context>

<task>
Создай компонент для отображения событий с цветами и интегрируй его с календарем. Реализуй цветовые индикаторы: 🔵 Урок (LESSON) - синий, 🟢 Выездное мероприятие (OUTDOOR_EVENT) - зеленый, 🔴 Отмена урока (LESSON_SKIPPING) - красный. Примени цвета к событиям в календаре.
</task>

<constraints>
- Цветовые индикаторы должны быть понятными
- Цвета должны следовать дизайн-системе проекта
- Компонент должен быть переиспользуемым
- Цвета должны быть доступными (контрастность WCAG 2.1 AA)
- Индикаторы должны быть визуально заметными
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.8.1 Календарь для понимания требований к цветовым индикаторам
2. Изучи DESIGN_SYSTEM.md для понимания цветовой палитры
3. Определи, как лучше интегрировать цвета с календарем
4. Продумай доступность цветов (контрастность)
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для отображения событий с цветами
- [ ] Реализовать цветовые индикаторы:
  - 🔵 Урок (LESSON) - синий
  - 🟢 Выездное мероприятие (OUTDOOR_EVENT) - зеленый
  - 🔴 Отмена урока (LESSON_SKIPPING) - красный
- [ ] Применить цвета к событиям в календаре
- [ ] Проверить контрастность цветов (WCAG 2.1 AA)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8.1 Календарь</CRITICAL>
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел Color Palette

**Критерии приемки:**
- Цветовые индикаторы работают
- События отображаются с правильными цветами
- Цвета следуют дизайн-системе
- Контрастность соответствует WCAG 2.1 AA

<output_format>
После выполнения задачи должны быть реализованы цветовые индикаторы типов событий, которые отображаются в календаре и следуют дизайн-системе проекта.
</output_format>

---

### Task 23.05: Реализация CRUD операций для событий

<context>
Реализация CRUD операций для событий критически важна для управления расписанием. Учителя должны иметь возможность создавать, редактировать и удалять события в календаре.
</context>

<task>
Создай формы и компоненты для CRUD операций событий. Реализуй форму создания события, редактирование события и удаление события. Добавь подтверждение удаления. Используй компоненты Shadcn UI (Dialog, Form) для визуального оформления.
</task>

<constraints>
- Формы должны быть Client Components (требуется интерактивность)
- Используй Server Actions для CRUD операций
- Валидация форм через Zod обязательна
- Компоненты Shadcn UI должны быть из `components/ui/`
- Подтверждение удаления обязательно
- Обработка ошибок обязательна
- Формы должны быть доступными (WCAG 2.1 AA)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.8.2 Управление событиями для понимания требований
2. Изучи WIREFRAMES.md раздел Event Form для понимания визуальной структуры
3. Используй Context7 для получения актуальной документации Shadcn UI Dialog и Form
4. Используй Context7 для получения актуальной документации react-hook-form
5. Определи, какие поля нужны для формы события
6. Только после этого создавай формы
</thinking>

**Действия:**
- [ ] Создать форму создания события
- [ ] Реализовать редактирование события
- [ ] Реализовать удаление события
- [ ] Добавить подтверждение удаления
- [ ] Использовать компоненты Shadcn UI (Dialog, Form)
- [ ] Добавить валидацию через Zod
- [ ] Добавить обработку ошибок
- [ ] Обеспечить доступность (WCAG 2.1 AA)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8.2 Управление событиями</CRITICAL>
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Event Form</CRITICAL>
- Context7: Shadcn UI Dialog и Form документация
- Context7: react-hook-form документация

**Критерии приемки:**
- CRUD операции работают корректно
- Подтверждение показывается при удалении
- Валидация работает
- Формы доступны (WCAG 2.1 AA)
- Обработка ошибок работает

<output_format>
После выполнения задачи должны быть реализованы CRUD операции для событий, которые позволяют создавать, редактировать и удалять события с подтверждением удаления.
</output_format>

---

### Task 23.06: Интеграция событий типа "Урок" с уроками

<context>
Интеграция событий типа "Урок" с уроками критически важна для связи календаря с системой уроков. При создании урока должно автоматически создаваться событие в календаре, и при клике на событие должен происходить переход к уроку.
</context>

<task>
Реализуй связь события типа LESSON с уроком. При создании урока автоматически создавай событие в календаре. Отобрази урок в календаре и при клике на событие переходи к уроку. Убедись, что интеграция работает корректно в обе стороны.
</task>

<constraints>
- Интеграция должна работать автоматически при создании урока
- Событие должно создаваться в календаре при создании урока
- Клик на событие должен переходить к уроку
- Интеграция должна работать в обе стороны
- Обработка ошибок обязательна
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.8.3 Интеграция с уроками для понимания требований
2. Изучи Phase 13 (Управление уроками) для понимания структуры создания уроков
3. Определи, как лучше интегрировать события с уроками
4. Продумай логику автоматического создания события при создании урока
5. Только после этого реализуй интеграцию
</thinking>

**Действия:**
- [ ] Реализовать связь события типа LESSON с уроком
- [ ] При создании урока автоматически создавать событие в календаре
- [ ] Отобразить урок в календаре
- [ ] При клике на событие переходить к уроку
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8.3 Интеграция с уроками</CRITICAL>
- Phase 13: Управление уроками (Lessons)

**Критерии приемки:**
- Интеграция работает корректно
- Уроки отображаются в календаре
- Автоматическое создание события работает
- Переход к уроку работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована интеграция событий типа "Урок" с уроками, которая автоматически создает события при создании уроков и позволяет переходить к урокам из календаря.
</output_format>

---

### Task 23.07: Тестирование функционала расписания

<context>
<CRITICAL>Это финальная задача фазы!</CRITICAL> Тестирование функционала расписания критически важно для подтверждения правильности работы всех компонентов. Все функции должны быть протестированы перед переходом к следующей фазе.
</context>

<task>
Протестируй весь функционал расписания: отображение календаря, CRUD операции, цветовые индикаторы, интеграцию с уроками. Убедись, что все компоненты работают корректно, данные отображаются правильно, и нет критических ошибок.
</task>

<constraints>
- Все функции должны быть протестированы
- Тестирование должно включать проверку на разных экранах (Mobile, Tablet, Desktop)
- Должна быть проверена обработка ошибок
- Должна быть проверена доступность (WCAG 2.1 AA)
- Не должно быть критических ошибок в консоли браузера
- Все данные должны отображаться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Убедись, что все предыдущие задачи выполнены
2. Подготовь тестовые данные для проверки всех функций
3. Определи все сценарии тестирования
4. Проверь работу на разных экранах
5. Проверь обработку ошибок
6. Только после этого проводи тестирование
</thinking>

**Действия:**
- [ ] Протестировать отображение календаря
- [ ] Протестировать CRUD операции
- [ ] Протестировать цветовые индикаторы
- [ ] Протестировать интеграцию с уроками
- [ ] Проверить работу на разных экранах (Mobile, Tablet, Desktop)
- [ ] Проверить обработку ошибок
- [ ] Проверить доступность (WCAG 2.1 AA)
- [ ] Проверить отсутствие ошибок в консоли браузера

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8 Расписание группы
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 6.1

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно
- Нет критических ошибок
- Компоненты адаптивны для разных экранов
- Доступность соответствует WCAG 2.1 AA

<output_format>
После выполнения задачи весь функционал расписания должен быть протестирован, все функции должны работать корректно, и не должно быть критических ошибок.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Grade Events Actions
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Calendar Pages
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.8

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025
