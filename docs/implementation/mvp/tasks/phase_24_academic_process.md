# Phase 24: Управление учебным процессом (Admin)

## Описание фазы
Реализация управления учебным процессом для Admin: глобальное завершение учебного года, создание нового учебного года для выбранных групп, блокировка создания уроков после завершения года.

## Зависимости
Phase 12: Управление учебными годами (Academic Years)

## Оценка времени
3-4 часа

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки React приложений, специализирующийся на:
- Next.js 15.5.9 App Router и Server Components
- React 19 и современные паттерны React
- Shadcn UI и Tailwind CSS
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Admin-панели и управление системой
- Бизнес-логика и валидация процессов
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, React 19, AWS Amplify Gen 1, AppSync GraphQL, Shadcn UI, TypeScript
Ограничения: MVP подход (функциональность важнее идеального кода), доступность критически важна, компоненты должны следовать дизайн-системе
Зависимости: Phase 12 (Управление учебными годами)
Особенность: Это Admin-функционал, доступный только администраторам
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для реализации управления учебным процессом. Правильная реализация управления учебными годами определит стабильность работы системы и предотвратит создание уроков после завершения учебного года.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Изучи MVP_SCOPE.md раздел 2.12 Управление учебным процессом - полные требования к функционалу
2. Изучи ADMIN_FLOWS.md раздел 6.1 - пользовательские сценарии для Admin
3. Изучи Phase 12 (Управление учебными годами) для понимания структуры данных
4. Используй Context7 для получения актуальной документации Next.js Server Actions
5. Используй Context7 для получения актуальной документации Shadcn UI компонентов
6. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
7. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**
8. **⚠️ ОБЯЗАТЕЛЬНО**: При создании компонентов страниц (page.tsx) строго следуй принципам из [ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md):
   - Страница должна открываться мгновенно при навигации
   - Используй Suspense boundaries с skeleton fallback
   - Разделяй page.tsx (только проверка аутентификации) и content component (загрузка данных)
9. **⚠️ ОБЯЗАТЕЛЬНО**: Для страниц просмотра (list pages, detail pages) используй ISR generation согласно [ai_isr_optimization_guidelines.md](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md):
   - Используй `export const revalidate = 60` вместо `force-dynamic`
   - Добавляй `revalidatePath` и `revalidateTag` в Server Actions после изменений
10. **⚠️ ОБЯЗАТЕЛЬНО**: При создании React компонентов и компонентов страниц строго соблюдай требования из [ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md):
   - Компоненты должны быть arrow functions
   - Максимальный размер компонента: 100 строк кода
   - Использование explicit typing вместо React.FC
   - Следование Atomic Design hierarchy

<CONSTRAINT>Все компоненты должны следовать дизайн-системе проекта и быть доступными (WCAG 2.1 AA). Проверка прав доступа (Admin only) обязательна для всех операций. Блокировка создания уроков после завершения года критически важна для целостности данных.</CONSTRAINT>
</critical_instructions>
</requirements>

## Релевантная документация

При создании программного кода для данной фазы используй следующие документы как источники требований и спецификаций:

### Функциональные требования
- **[app_functionality.md](../../../app_functionality.md)** - единственный источник истины для функциональных требований
  - Раздел 5.0 Управление учебным процессом - описание функционала завершения учебного года

### Пользовательские сценарии
- **[USER_FLOW.md](../../../user_flows/USER_FLOW.md)** - общие пользовательские сценарии и flow-диаграммы
  - Раздел 5.2 Завершение учебного года (глобально) - flow завершения года
- **[ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)** - детальные flow для администраторов
  - Раздел 6.1 Завершение учебного года - детальный flow завершения года

### Визуальные макеты
- **[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md)** - визуальные макеты страниц и компонентов
  - Раздел 4.5 Управление учебным процессом - макеты для управления процессом

### API и валидация
- **[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md)** - спецификация Server Actions API
  - Раздел Academic Process - API для управления учебным процессом
- **[VALIDATION.md](../../../api/VALIDATION.md)** - схемы валидации Zod

### База данных
- **[GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md)** - GraphQL схема
- **[ERD.md](../../../database/ERD.md)** - диаграмма сущностей

### Guidelines
- **[guidelines/react/](../../../guidelines/react/)** - руководящие принципы для React компонентов
  - **[ai_component_guidelines.md](../../../guidelines/react/ai_component_guidelines.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: требования для создания React компонентов и компонентов страниц (arrow functions, размер до 100 строк, explicit typing, Atomic Design)
- **[guidelines/nextjs/](../../../guidelines/nextjs/)** - руководящие принципы для Next.js
  - **[ai_suspense_fast_navigation.md](../../../guidelines/nextjs/ai_suspense_fast_navigation.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: принцип построения компонентов страниц (мгновенное открытие страниц, Suspense boundaries, разделение page.tsx и content component)
  - **[ai_isr_optimization_guidelines.md](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md)** - ⚠️ **ОБЯЗАТЕЛЬНО**: ISR generation для страниц просмотра (revalidate, revalidatePath, revalidateTag)
- **[guidelines/prompts/general_prompt_guidelines.md](../../../guidelines/prompts/general_prompt_guidelines.md)** - общие принципы работы

> [!NOTE]
> **Принцип единственного источника истины:** 
> - `app_functionality.md` является единственным источником истины для функциональных требований
> - Документы в `user_flows/` содержат детальные flow-диаграммы, ссылающиеся на `app_functionality.md`
> - При изменении функциональных требований обновляй `app_functionality.md`, затем при необходимости обновляй ссылки в других документах

## Задачи

### Task 24.01: Создание Server Actions для управления учебным процессом

<context>
<CRITICAL>Это первая и критически важная задача фазы!</CRITICAL> Создание Server Actions для управления учебным процессом является основой для всех остальных компонентов фазы. Правильная реализация операций завершения и создания учебных годов определит корректность работы системы.
</context>

<task>
Создай Server Actions файл `src/actions/academicProcess.ts` с функциями для управления учебным процессом. Реализуй `completeAllAcademicYears()` для глобального завершения всех активных годов и `createNewAcademicYearForGroups(groups, yearData)` для создания нового года для выбранных групп. Добавь проверку прав доступа (Admin only).

⚠️ **Важно:** Код Server Actions должен находиться в файле `src/actions/academicProcess.ts` в каталоге `src/actions/`.
</task>

<constraints>
- Server Actions должны иметь директиву `'use server'`
- Используй amplifyData для получения данных через AppSync GraphQL
- Проверка прав доступа обязательна (Admin only)
- Валидация входных данных через Zod обязательна
- Обработка ошибок обязательна
- Функция `completeAllAcademicYears` должна завершать все активные годы
- Функция `createNewAcademicYearForGroups` должна создавать год для выбранных групп
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Academic Process для понимания требований к Server Actions
2. Изучи MVP_SCOPE.md раздел 2.12 Управление учебным процессом для понимания требований
3. Изучи Phase 12 (Управление учебными годами) для понимания структуры данных AcademicYear
4. Изучи GraphQL схему для понимания структуры данных
5. Определи, какие данные нужны для завершения и создания годов
6. Используй Context7 для получения актуальной документации Next.js Server Actions
7. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `src/actions/academicProcess.ts` с директивой `'use server'`
- [ ] Реализовать `completeAllAcademicYears()` - глобальное завершение всех активных годов
- [ ] Реализовать `createNewAcademicYearForGroups(groups, yearData)` - создание нового года для групп
- [ ] Добавить проверку прав доступа (Admin only)
- [ ] Добавить валидацию входных данных через Zod
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Academic Process и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12 Управление учебным процессом</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Phase 12: Управление учебными годами (Academic Years)
- Context7: Next.js Server Actions документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - для обновления данных
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/lib/validation/academicYears.ts](../../../../src/lib/validation/academicYears.ts) - схемы валидации для учебных годов
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте getGradeWithNestedData() для получения всех данных учебного процесса
- Grade содержит вложенные данные: academicYears.lessons с homeworkChecks, goldenVerses, files
- Все данные для отображения учебного процесса доступны в одном запросе
- Не требуются отдельные запросы для получения связанных данных

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает (Admin only)
- Глобальное завершение работает корректно
- Создание нового года работает корректно
- Валидация работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должны быть созданы Server Actions для управления учебным процессом, которые поддерживают завершение и создание учебных годов с проверкой прав доступа.
</output_format>

---

### Task 24.02: Создание UI для завершения учебного года

<context>
Создание UI для завершения учебного года критически важно для удобства работы администраторов. UI должен показывать список активных годов, предупреждения о последствиях и подтверждение завершения.
</context>

<task>
Создай страницу `app/(private)/school-process-management/page.tsx` для управления учебным процессом. Реализуй форму завершения учебного года, покажи список всех активных учебных годов, добавь подтверждение завершения и покажи предупреждение о последствиях. Используй компоненты Shadcn UI (Card, Button, Alert) для визуального оформления.
</task>

<constraints>
- Страница должна быть Server Component (по умолчанию)
- Используй Server Actions для завершения годов
- Компоненты Shadcn UI должны быть из `components/ui/`
- Подтверждение завершения обязательно
- Предупреждение о последствиях обязательно
- Обработка ошибок обязательна
- Проверка прав доступа обязательна (Admin only)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.12.1 Завершение учебного года для понимания требований
2. Изучи USER_FLOW.md раздел Admin flows для понимания пользовательских сценариев
3. Изучи ADMIN_FLOWS.md раздел 6.1 для понимания контекста использования
4. Используй Context7 для получения актуальной документации Next.js App Router
5. Используй Context7 для получения актуальной документации Shadcn UI компонентов
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/school-process-management/page.tsx`
- [ ] Реализовать форму завершения учебного года
- [ ] Показать список всех активных учебных годов
- [ ] Добавить подтверждение завершения
- [ ] Показать предупреждение о последствиях
- [ ] Использовать компоненты Shadcn UI (Card, Button, Alert)
- [ ] Добавить проверку прав доступа (Admin only)
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12.1 Завершение учебного года</CRITICAL>
- <CRITICAL>[USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Admin flows</CRITICAL>
- <CRITICAL>[ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 6.1 Завершение учебного года</CRITICAL>
- Context7: Next.js 15.5.9 App Router документация
- Context7: Shadcn UI компоненты документация

**Критерии приемки:**
- UI создан
- Подтверждение показывается
- Предупреждение о последствиях показывается
- Проверка прав доступа работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан UI для завершения учебного года, который показывает список активных годов, предупреждения и подтверждение завершения.
</output_format>

---

### Task 24.03: Реализация глобального завершения

<context>
Реализация глобального завершения критически важна для завершения всех активных учебных годов одновременно. Логика должна изменять статус всех активных годов на COMPLETED и обновлять UI после завершения.
</context>

<task>
Реализуй логику глобального завершения всех активных учебных годов. Измени статус всех активных годов на COMPLETED, покажи уведомление об успешном завершении и обнови UI после завершения. Убедись, что операция выполняется атомарно и обрабатываются все ошибки.
</task>

<constraints>
- Операция должна быть атомарной (все или ничего)
- Статус всех активных годов должен быть изменен на COMPLETED
- Уведомление об успешном завершении обязательно
- UI должен обновляться после завершения
- Обработка ошибок обязательна
- Операция должна быть эффективной
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.12.1 для понимания требований к завершению
2. Изучи GraphQL схему для понимания структуры данных AcademicYear
3. Определи, как лучше реализовать атомарную операцию
4. Продумай обработку ошибок и откат изменений
5. Только после этого реализуй логику
</thinking>

**Действия:**
- [ ] Реализовать логику завершения всех активных учебных годов
- [ ] Изменить статус всех активных годов на COMPLETED
- [ ] Показать уведомление об успешном завершении
- [ ] Обновить UI после завершения
- [ ] Добавить обработку ошибок
- [ ] Обеспечить атомарность операции

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12.1</CRITICAL>
- GraphQL схема: AcademicYear

**Критерии приемки:**
- Глобальное завершение работает корректно
- Все активные годы завершены
- Уведомление показывается
- UI обновляется после завершения
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована логика глобального завершения, которая завершает все активные учебные годы и обновляет UI.
</output_format>

---

### Task 24.04: Реализация создания нового учебного года

<context>
Реализация создания нового учебного года критически важна для начала нового учебного цикла. Форма должна позволять выбирать группы и устанавливать параметры нового года.
</context>

<task>
Создай форму создания нового учебного года. Реализуй множественный выбор групп, реализуй поля: название, дата начала, дата окончания. Создай учебный год для выбранных групп и установи статус ACTIVE. Используй компоненты Shadcn UI (Form, Select, DatePicker) для визуального оформления.
</task>

<constraints>
- Форма должна быть Client Component (требуется интерактивность)
- Используй Server Actions для создания года
- Валидация форм через Zod обязательна
- Компоненты Shadcn UI должны быть из `components/ui/`
- Множественный выбор групп обязателен
- Обработка ошибок обязательна
- Форма должна быть доступной (WCAG 2.1 AA)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.12.2 Создание нового учебного года для понимания требований
2. Используй Context7 для получения актуальной документации Shadcn UI Form, Select, DatePicker
3. Используй Context7 для получения актуальной документации react-hook-form
4. Определи, какие поля нужны для формы
5. Продумай логику множественного выбора групп
6. Только после этого создавай форму
</thinking>

**Действия:**
- [ ] Создать форму создания нового учебного года
- [ ] Реализовать множественный выбор групп
- [ ] Реализовать поля: название, дата начала, дата окончания
- [ ] Создать учебный год для выбранных групп
- [ ] Установить статус ACTIVE
- [ ] Использовать компоненты Shadcn UI (Form, Select, DatePicker)
- [ ] Добавить валидацию через Zod
- [ ] Добавить обработку ошибок
- [ ] Обеспечить доступность (WCAG 2.1 AA)

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12.2 Создание нового учебного года</CRITICAL>
- Context7: Shadcn UI Form, Select, DatePicker документация
- Context7: react-hook-form документация

**Критерии приемки:**
- Создание нового года работает корректно
- Год создается для выбранных групп
- Валидация работает
- Форма доступна (WCAG 2.1 AA)
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована форма создания нового учебного года, которая позволяет выбирать группы и устанавливать параметры года.
</output_format>

---

### Task 24.05: Блокировка создания уроков после завершения года

<context>
<CRITICAL>Это критически важная задача для целостности данных!</CRITICAL> Блокировка создания уроков после завершения года критически важна для предотвращения создания уроков в завершенных учебных годах. Блокировка должна работать как на уровне Server Actions, так и на уровне UI.
</context>

<task>
Обнови Server Action `createLesson` для проверки наличия активного учебного года. Если активного года нет, возвращай ошибку. Обнови UI создания урока для показа сообщения о необходимости создания нового года и блокировки формы. Убедись, что блокировка работает корректно.
</task>

<constraints>
- Проверка наличия активного года обязательна в Server Action
- Возврат ошибки обязателен, если активного года нет
- UI должен показывать понятное сообщение
- Форма должна быть заблокирована, если активного года нет
- Обработка ошибок обязательна
- Сообщения должны быть понятными для пользователя
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.12.1 Блокировка создания уроков для понимания требований
2. Изучи Phase 13 (Управление уроками) для понимания структуры Server Action createLesson
3. Определи, как лучше проверять наличие активного года
4. Продумай UX блокировки (когда показывать сообщение)
5. Только после этого обновляй Server Action и UI
</thinking>

**Действия:**
- [ ] Обновить Server Action `createLesson`:
  - Проверять наличие активного года
  - Возвращать ошибку, если активного года нет
- [ ] Обновить UI создания урока:
  - Показывать сообщение о необходимости создания нового года
  - Блокировать форму
- [ ] Добавить обработку ошибок
- [ ] Убедиться, что сообщения понятны пользователю

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12.1 Блокировка создания уроков</CRITICAL>
- Phase 13: Управление уроками (Lessons)

**Критерии приемки:**
- Блокировка работает корректно
- Сообщения понятны пользователю
- Форма блокируется, если активного года нет
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована блокировка создания уроков после завершения года, которая работает на уровне Server Actions и UI.
</output_format>

---

### Task 24.06: Тестирование функционала управления процессом

<context>
<CRITICAL>Это финальная задача фазы!</CRITICAL> Тестирование функционала управления учебным процессом критически важно для подтверждения правильности работы всех компонентов. Все функции должны быть протестированы перед переходом к следующей фазе.
</context>

<task>
Протестируй весь функционал управления учебным процессом: завершение учебного года, создание нового года, блокировку создания уроков. Убедись, что все компоненты работают корректно, данные обрабатываются правильно, и нет критических ошибок.
</task>

<constraints>
- Все функции должны быть протестированы
- Тестирование должно включать проверку на разных экранах (Mobile, Tablet, Desktop)
- Должна быть проверена обработка ошибок
- Должна быть проверена доступность (WCAG 2.1 AA)
- Должна быть проверена проверка прав доступа (Admin only)
- Не должно быть критических ошибок в консоли браузера
- Все данные должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Убедись, что все предыдущие задачи выполнены
2. Подготовь тестовые данные для проверки всех функций
3. Определи все сценарии тестирования
4. Проверь работу на разных экранах
5. Проверь обработку ошибок
6. Проверь проверку прав доступа
7. Только после этого проводи тестирование
</thinking>

**Действия:**
- [ ] Протестировать завершение учебного года
- [ ] Протестировать создание нового года
- [ ] Протестировать блокировку создания уроков
- [ ] Проверить работу на разных экранах (Mobile, Tablet, Desktop)
- [ ] Проверить обработку ошибок
- [ ] Проверить доступность (WCAG 2.1 AA)
- [ ] Проверить проверку прав доступа (Admin only)
- [ ] Проверить отсутствие ошибок в консоли браузера

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12 Управление учебным процессом
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 6.1

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно
- Нет критических ошибок
- Компоненты адаптивны для разных экранов
- Доступность соответствует WCAG 2.1 AA
- Проверка прав доступа работает

<output_format>
После выполнения задачи весь функционал управления учебным процессом должен быть протестирован, все функции должны работать корректно, и не должно быть критических ошибок.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Academic Process Actions
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.12
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 6.1

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025
