# Phase 10: Создание системы валидации

## Описание фазы
Создание Zod схем валидации для всех сущностей, утилиты валидации, обработка ошибок валидации, интеграция с формами.

## Зависимости
Phase 09: Создание Data Access Layer

## Оценка времени
4-5 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки систем валидации, специализирующийся на:
- Zod схемы валидации и TypeScript типы
- React Hook Form и интеграция с Zod
- Валидация данных на клиенте и сервере
- Обработка ошибок валидации
- TypeScript с строгой типизацией
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Zod, React Hook Form, TypeScript, Next.js 15.5.9
Ограничения: MVP подход, Zod схемы как единый источник истины для валидации
Документация: VALIDATION.md должна быть изучена перед началом работы
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для создания системы валидации. Правильная настройка валидации определит корректность данных во всем приложении.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Изучи VALIDATION.md - все схемы валидации проекта
2. Изучи GRAPHQL_SCHEMA.md - Input Types для соответствия схем
3. Используй Context7 для получения актуальной документации Zod
4. Используй Context7 для получения актуальной документации React Hook Form
5. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`

<CONSTRAINT>Zod схемы должны быть единым источником истины для валидации. Типы должны быть выведены из схем через z.infer. Все схемы должны соответствовать GraphQL Input Types!</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 10.01: Создание структуры валидации

<context>
<CRITICAL>Это первая и критически важная задача фазы!</CRITICAL> Создание структуры валидации определяет организацию всех схем валидации проекта. Правильная структура обеспечит консистентность и поддерживаемость кода.
</context>

<task>
Создай структуру каталогов и файлов для валидации согласно VALIDATION.md. Создай каталог `lib/validation/` и все необходимые файлы для схем валидации.
</task>

<constraints>
- Структура каталогов должна быть создана
- Все файлы должны быть созданы согласно VALIDATION.md
- Структура должна соответствовать документации
- Файлы должны быть организованы по сущностям
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи VALIDATION.md раздел 1.2 File Structure детально
2. Определи все файлы, которые нужно создать
3. Только после этого создавай структуру
</thinking>

**Действия:**
- [ ] Создать каталог `lib/validation/`
- [ ] Создать файлы согласно [VALIDATION.md](../../../api/VALIDATION.md):
  - `lib/validation/index.ts` - реэкспорт всех схем
  - `lib/validation/auth.ts` - схемы аутентификации
  - `lib/validation/lessons.ts` - схемы уроков
  - `lib/validation/homework.ts` - схемы домашних заданий
  - `lib/validation/pupils.ts` - схемы учеников
  - `lib/validation/grades.ts` - схемы групп
  - И другие файлы согласно документации

**Документация:**
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел 1.2 File Structure</CRITICAL>
- [COMPONENT_LIBRARY.md](../../../components/COMPONENT_LIBRARY.md)

**Критерии приемки:**
- Структура каталогов создана
- Все файлы созданы
- Структура соответствует документации

<output_format>
После выполнения задачи структура каталогов должна быть создана, все файлы должны быть созданы, и структура должна соответствовать документации.
</output_format>

---

### Task 10.02: Создание базовых схем валидации

<context>
Создание базовых схем валидации критически важно для переиспользования общих паттернов валидации. Базовые схемы будут использоваться во всех других схемах.
</context>

<task>
Создай базовые схемы валидации в `lib/validation/common.ts`. Реализуй схемы для UUID, даты, email, пароля и других общих паттернов. Экспортируй схемы для использования в других файлах.
</task>

<constraints>
- Базовые схемы должны быть созданы в `lib/validation/common.ts`
- Схемы должны работать корректно
- Схемы должны экспортироваться для использования
- Используй Zod для создания схем
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи VALIDATION.md раздел 2 Common Validation Patterns для понимания требований
2. Используй Context7 для получения актуальной документации Zod
3. Определи все базовые схемы, которые нужно создать
4. Только после этого создавай схемы
</thinking>

**Действия:**
- [ ] Создать общие схемы в `lib/validation/common.ts`:
  - `uuidSchema` - валидация UUID
  - `dateSchema` - валидация даты
  - `emailSchema` - валидация email
  - `passwordSchema` - валидация пароля
  - И другие общие схемы
- [ ] Экспортировать схемы для использования

**Документация:**
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел 2 Common Validation Patterns</CRITICAL>
- Zod документация (через Context7)

**Критерии приемки:**
- Базовые схемы созданы
- Схемы работают корректно
- Схемы экспортируются

<output_format>
После выполнения задачи базовые схемы должны быть созданы, схемы должны работать корректно, и схемы должны экспортироваться.
</output_format>

---

### Task 10.03: Создание схем для аутентификации

<context>
Создание схем для аутентификации критически важно для безопасности. Схемы должны использовать базовые схемы (email, password) и иметь понятные сообщения об ошибках.
</context>

<task>
Создай схемы валидации для аутентификации в `lib/validation/auth.ts`. Реализуй signInSchema, signUpSchema (если требуется) и другие схемы аутентификации. Используй базовые схемы и добавь кастомные сообщения об ошибках.
</task>

<constraints>
- Схемы аутентификации должны быть созданы в `lib/validation/auth.ts`
- Валидация должна работать корректно
- Сообщения об ошибках должны быть понятны
- Используй базовые схемы (email, password)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи VALIDATION.md раздел 3 Authentication Schemas для понимания требований
2. Изучи SERVER_ACTIONS.md раздел Auth Actions для понимания использования
3. Используй базовые схемы из Task 10.02
4. Только после этого создавай схемы
</thinking>

**Действия:**
- [ ] Создать схемы в `lib/validation/auth.ts`:
  - `signInSchema` - вход
  - `signUpSchema` - регистрация (если требуется)
  - И другие схемы аутентификации
- [ ] Использовать общие схемы (email, password)
- [ ] Добавить кастомные сообщения об ошибках

**Документация:**
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел 3 Authentication Schemas</CRITICAL>
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Auth Actions

**Критерии приемки:**
- Схемы аутентификации созданы
- Валидация работает корректно
- Сообщения об ошибках понятны

<output_format>
После выполнения задачи схемы аутентификации должны быть созданы, валидация должна работать корректно, и сообщения об ошибках должны быть понятны.
</output_format>

---

### Task 10.04: Создание схем для уроков

<context>
Создание схем для уроков критически важно для валидации данных уроков. Схемы должны соответствовать GraphQL Input Types и требованиям MVP.
</context>

<task>
Создай схемы валидации для уроков в `lib/validation/lessons.ts`. Реализуй createLessonSchema, updateLessonSchema и lessonIdSchema. Используй базовые схемы где возможно и добавь валидацию для всех полей урока.
</task>

<constraints>
- Схемы уроков должны быть созданы в `lib/validation/lessons.ts`
- Валидация всех полей должна работать
- Схемы должны соответствовать требованиям MVP
- Схемы должны соответствовать GraphQL Input Types
- Используй базовые схемы где возможно
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи VALIDATION.md раздел 4 Lesson Schemas для понимания требований
2. Изучи SERVER_ACTIONS.md раздел Lesson Actions для понимания использования
3. Изучи MVP_SCOPE.md раздел 2.3 Управление уроками для понимания требований MVP
4. Изучи GRAPHQL_SCHEMA.md для понимания Input Types
5. Только после этого создавай схемы
</thinking>

**Действия:**
- [ ] Создать схемы в `lib/validation/lessons.ts`:
  - `createLessonSchema` - создание урока
  - `updateLessonSchema` - обновление урока
  - `lessonIdSchema` - валидация ID урока
- [ ] Использовать общие схемы где возможно
- [ ] Добавить валидацию для всех полей урока

**Документация:**
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел 4 Lesson Schemas</CRITICAL>
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Lesson Actions
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3 Управление уроками

**Критерии приемки:**
- Схемы уроков созданы
- Валидация всех полей работает
- Схемы соответствуют требованиям MVP

<output_format>
После выполнения задачи схемы уроков должны быть созданы, валидация всех полей должна работать, и схемы должны соответствовать требованиям MVP.
</output_format>

---

### Task 10.05: Создание схем для других сущностей

<context>
Создание схем для других сущностей критически важно для валидации всех данных приложения. Все схемы должны соответствовать GraphQL Schema и Input Types.
</context>

<task>
Создай схемы валидации для всех остальных сущностей (группы, ученики, домашние задания и др.) согласно VALIDATION.md. Убедись, что все схемы соответствуют GraphQL Schema и Input Types.
</task>

<constraints>
- Все схемы должны быть созданы согласно VALIDATION.md
- Схемы должны соответствовать GraphQL Schema
- Схемы должны соответствовать GraphQL Input Types
- Валидация должна работать корректно
- Используй базовые схемы где возможно
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи VALIDATION.md все разделы для понимания всех схем
2. Изучи GRAPHQL_SCHEMA.md Input Types для понимания соответствия
3. Определи все сущности, для которых нужно создать схемы
4. Только после этого создавай схемы
</thinking>

**Действия:**
- [ ] Создать схемы для групп (`grades.ts`)
- [ ] Создать схемы для учеников (`pupils.ts`)
- [ ] Создать схемы для домашних заданий (`homework.ts`)
- [ ] Создать схемы для других сущностей согласно [VALIDATION.md](../../../api/VALIDATION.md)
- [ ] Убедиться, что все схемы соответствуют GraphQL Schema

**Документация:**
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - все разделы</CRITICAL>
- <CRITICAL>[GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md) - Input Types</CRITICAL>

**Критерии приемки:**
- Все схемы созданы
- Схемы соответствуют GraphQL Schema
- Валидация работает корректно

<output_format>
После выполнения задачи все схемы должны быть созданы, схемы должны соответствовать GraphQL Schema, и валидация должна работать корректно.
</output_format>

---

### Task 10.06: Создание утилит для обработки ошибок валидации

<context>
<CRITICAL>Это критически важная задача для UX!</CRITICAL> Создание утилит для обработки ошибок валидации критически важно для обеспечения понятных сообщений пользователю. Ошибки должны быть отформатированы и понятны.
</context>

<task>
Создай утилиты для обработки ошибок валидации в `lib/validation/utils.ts`. Реализуй функции formatValidationErrors() и getFieldError() для преобразования Zod ошибок в понятный формат и получения ошибок по полям.
</task>

<constraints>
- Утилиты должны быть созданы в `lib/validation/utils.ts`
- Форматирование ошибок должно работать
- Ошибки должны быть понятны пользователю
- Функции должны работать с Zod ошибками
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи ERROR_HANDLING.md раздел Ошибки валидации для понимания требований
2. Изучи VALIDATION.md раздел 5 Error Handling для понимания паттернов
3. Используй Context7 для получения актуальной документации Zod Error Handling
4. Определи структуру форматирования ошибок
5. Только после этого создавай утилиты
</thinking>

**Действия:**
- [ ] Создать файл `lib/validation/utils.ts`
- [ ] Реализовать функцию `formatValidationErrors()`:
  - Преобразует Zod ошибки в понятный формат
  - Возвращает ошибки по полям
- [ ] Реализовать функцию `getFieldError()`:
  - Получает ошибку для конкретного поля
  - Возвращает сообщение об ошибке
- [ ] Экспортировать утилиты

**Документация:**
- [ERROR_HANDLING.md](../../../user_flows/ERROR_HANDLING.md) - раздел Ошибки валидации
- [VALIDATION.md](../../../api/VALIDATION.md) - раздел 5 Error Handling
- Zod Error Handling документация (через Context7)

**Критерии приемки:**
- Утилиты созданы
- Форматирование ошибок работает
- Ошибки понятны пользователю

<output_format>
После выполнения задачи утилиты должны быть созданы, форматирование ошибок должно работать, и ошибки должны быть понятны пользователю.
</output_format>

---

### Task 10.07: Интеграция с React Hook Form

<context>
Интеграция с React Hook Form критически важна для использования Zod схем в формах. Правильная интеграция обеспечит валидацию на клиенте и сервере.
</context>

<task>
Интегрируй Zod схемы с React Hook Form. Убедись, что `@hookform/resolvers` установлен, создай пример интеграции и утилиту для создания resolver из Zod схемы. Протестируй интеграцию.
</task>

<constraints>
- `@hookform/resolvers` должен быть установлен
- Интеграция должна работать корректно
- Resolver должен создаваться из Zod схемы
- Валидация в формах должна работать
- Интеграция должна быть протестирована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Убедись, что `@hookform/resolvers` установлен
2. Изучи VALIDATION.md раздел 6 React Hook Form Integration для понимания требований
3. Используй Context7 для получения актуальной документации React Hook Form Zod Resolver
4. Определи структуру интеграции
5. Только после этого интегрируй
</thinking>

**Действия:**
- [ ] Убедиться, что `@hookform/resolvers` установлен
- [ ] Создать пример интеграции Zod с React Hook Form
- [ ] Создать утилиту для создания resolver из Zod схемы
- [ ] Протестировать интеграцию

**Документация:**
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел 6 React Hook Form Integration</CRITICAL>
- React Hook Form Zod Resolver документация (через Context7)

**Критерии приемки:**
- Интеграция работает корректно
- Resolver создается из Zod схемы
- Валидация в формах работает

<output_format>
После выполнения задачи интеграция должна работать корректно, resolver должен создаваться из Zod схемы, и валидация в формах должна работать.
</output_format>

---

### Task 10.08: Тестирование схем валидации

<context>
<CRITICAL>Это финальная задача фазы!</CRITICAL> Тестирование схем валидации необходимо для подтверждения правильности работы всех схем. Это важный шаг перед переходом к следующей фазе.
</context>

<task>
Протестируй все схемы валидации. Протестируй схемы с валидными и невалидными данными, обработку ошибок и интеграцию с формами.
</task>

<constraints>
- Все тесты должны быть пройдены успешно
- Валидация должна работать корректно
- Ошибки должны обрабатываться правильно
- Интеграция с формами должна работать
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Подготовь тестовые сценарии для всех схем
2. Подготовь валидные и невалидные тестовые данные
3. Только после этого тестируй схемы
</thinking>

**Действия:**
- [ ] Протестировать все схемы с валидными данными
- [ ] Протестировать все схемы с невалидными данными
- [ ] Протестировать обработку ошибок
- [ ] Протестировать интеграцию с формами

**Документация:**
- [VALIDATION.md](../../../api/VALIDATION.md)
- Zod Testing документация (через Context7)

**Критерии приемки:**
- Все тесты пройдены успешно
- Валидация работает корректно
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи все тесты должны быть пройдены успешно, валидация должна работать корректно, и ошибки должны обрабатываться правильно.
</output_format>

---

## Ссылки на документацию проекта

- [VALIDATION.md](../../../api/VALIDATION.md) - Все схемы валидации
- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Использование валидации
- [GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md) - Input Types

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

