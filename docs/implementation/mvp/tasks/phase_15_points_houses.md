# Phase 15: Система баллов и домиков

## Описание фазы
Реализация системы баллов и домиков: автоматический расчет баллов на основе настроек группы, логика получения домика (все параметры выполнены), визуализация домиков.

## Зависимости
Phase 14: Проверка домашних заданий (Homework Checks)

## Оценка времени
4-5 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Расчеты и бизнес-логика
- Визуализация данных
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI, lucide-react
Ограничения: MVP подход, система баллов и домиков критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для системы мотивации. Правильная реализация расчета баллов, логики получения домика и визуализации критически важна для работы системы мотивации.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Расчет баллов должен учитывать настройки группы. Логика получения домика должна работать корректно (все параметры выполнены). Визуализация домиков должна быть понятной для пользователей.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 15.01: Реализация логики расчета баллов

<context>
<CRITICAL>Это критически важная задача для системы мотивации!</CRITICAL> Логика расчета баллов является основой системы мотивации. Правильная реализация с учетом настроек группы и всех параметров критически важна для корректности оценивания.
</context>

<task>
Создай утилиту для расчета баллов. Реализуй функции для расчета общей суммы баллов за все уроки и среднего балла. Учитывай настройки группы (баллы за каждый параметр). Интегрируй расчет в компоненты.
</task>

<constraints>
- Функция должна рассчитывать общую сумму баллов за все уроки
- Должны учитываться настройки группы (баллы за каждый параметр)
- Функция должна рассчитывать средний балл
- Обработка ошибок должна быть реализована
- Функции должны быть оптимизированы для производительности
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.6.1 Система баллов для понимания логики расчета
2. Изучи MVP_SCOPE.md раздел 2.11.3 Настройка баллов для понимания настроек
3. Определи структуру функций и логику расчета баллов
4. Продумай интеграцию с компонентами
5. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/points.ts`
- [ ] Реализовать функцию `calculateTotalPoints(homeworkChecks, gradeSettings)`:
  - Рассчитывает общую сумму баллов за все уроки
  - Учитывает настройки группы (баллы за каждый параметр)
  - Возвращает общую сумму
- [ ] Реализовать функцию `calculateAveragePoints(points, lessonsCount)`:
  - Рассчитывает средний балл
- [ ] Интегрировать расчет в компоненты
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.6.1 Система баллов</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11.3 Настройка баллов</CRITICAL>

**Критерии приемки:**
- Расчет баллов работает корректно
- Средний балл рассчитывается правильно
- Учитываются настройки группы
- Интеграция с компонентами работает

<output_format>
После выполнения задачи должна быть создана утилита для расчета баллов. Функции должны работать корректно, учитывая все настройки группы. Расчет должен интегрироваться в компоненты и выполняться автоматически.
</output_format>

---

### Task 15.02: Реализация логики получения домика

<context>
Логика получения домика является частью системы мотивации. Правильная реализация с проверкой всех включенных параметров критически важна для корректности определения получения домика учеником.
</context>

<task>
Создай утилиту для определения получения домика. Реализуй функции для проверки получения домика и подсчета количества домиков. Интегрируй логику в проверку ДЗ.
</task>

<constraints>
- Функция должна проверять, все ли включенные параметры выполнены
- Домик должен получаться только если все включенные параметры отмечены
- Функция должна подсчитывать количество домиков за все уроки
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.6.2 Система домиков для понимания логики
2. Определи структуру функций и логику проверки всех параметров
3. Продумай интеграцию с проверкой ДЗ
4. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/houses.ts`
- [ ] Реализовать функцию `checkHouseEarned(homeworkCheck, gradeSettings)`:
  - Проверяет, все ли включенные параметры выполнены (все чекбоксы отмечены)
  - Возвращает true, если домик получен
- [ ] Реализовать функцию `countHouses(homeworkChecks, gradeSettings)`:
  - Подсчитывает количество домиков за все уроки
- [ ] Интегрировать логику в проверку ДЗ
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.6.2 Система домиков</CRITICAL>

**Критерии приемки:**
- Логика получения домика работает корректно
- Подсчет домиков работает правильно
- Интеграция с проверкой ДЗ работает

<output_format>
После выполнения задачи должна быть создана утилита для определения получения домика. Функции должны работать корректно, определяя получение домика на основе всех включенных параметров. Логика должна интегрироваться в проверку ДЗ.
</output_format>

---

### Task 15.03: Создание визуализации домиков

<context>
Визуализация домиков является важной частью системы мотивации. Правильное отображение количества домиков критически важно для мотивации учеников и удобства работы учителей.
</context>

<task>
Создай компоненты для визуализации домиков. Реализуй компонент иконки домика и компонент отображения количества домиков. Используй иконки из lucide-react или кастомные изображения.
</task>

<constraints>
- Компонент иконки домика должен быть визуально понятным
- Компонент отображения должен показывать количество домиков
- Используй иконки из lucide-react или кастомные изображения
- Компоненты должны следовать дизайн-системе проекта
- Компоненты должны быть доступны (WCAG 2.1 AA)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.5.4 Домики для понимания требований
2. Изучи DESIGN_SYSTEM.md раздел Iconography для понимания дизайна
3. Определи структуру компонентов и визуальное отображение
4. Продумай использование иконок из lucide-react
5. Только после этого создавай компоненты
</thinking>

**Действия:**
- [ ] Создать компонент `components/shared/house-icon.tsx` (или `components/molecules/house-icon.tsx`)
- [ ] Реализовать визуальное отображение домика (иконка из lucide-react или кастомное изображение)
- [ ] Создать компонент `components/shared/house-display.tsx` (или `components/organisms/houses/house-display.tsx`):
  - Отображает количество домиков
  - Показывает визуализацию домиков
- [ ] Использовать иконки из lucide-react или кастомные изображения
- [ ] Следовать дизайн-системе проекта

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.5.4 Домики
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел Iconography
- Context7: lucide-react документация

**Критерии приемки:**
- Визуализация домиков создана
- Компоненты отображаются корректно
- Иконки понятны и соответствуют дизайн-системе

<output_format>
После выполнения задачи должны быть созданы компоненты для визуализации домиков. Компоненты должны отображаться корректно, показывая количество домиков и визуализацию. Компоненты должны быть готовы к использованию в различных местах приложения.
</output_format>

---

### Task 15.04: Интеграция с проверкой ДЗ

<context>
Интеграция системы баллов и домиков с проверкой ДЗ является критически важной для автоматизации работы. Правильная реализация с автоматическим расчетом баллов и определением домика критически важна для удобства работы пользователей.
</context>

<task>
Обнови форму проверки ДЗ для интеграции системы баллов и домиков. Реализуй автоматический расчет баллов при изменении чекбоксов, автоматическое определение получения домика и отображение индикатора домика в таблице. Сохраняй информацию о домике при сохранении проверки ДЗ.
</task>

<constraints>
- Баллы должны рассчитываться автоматически при изменении чекбоксов
- Домик должен определяться автоматически при изменении чекбоксов
- Индикатор домика должен отображаться в таблице
- Информация о домике должна сохраняться при сохранении проверки ДЗ
- Интеграция должна работать без перезагрузки страницы
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.4.1 и 2.6.2 для понимания требований
2. Определи логику интеграции с формой проверки ДЗ
3. Продумай автоматический расчет и определение домика
4. Только после этого обновляй форму проверки ДЗ
</thinking>

**Действия:**
- [ ] Обновить форму проверки ДЗ:
  - Автоматически рассчитывать баллы при изменении чекбоксов через функцию `calculateTotalPoints`
  - Автоматически определять получение домика через функцию `checkHouseEarned`
  - Отображать индикатор домика в таблице через компонент `house-icon`
- [ ] Сохранять информацию о домике при сохранении проверки ДЗ через Server Action
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4.1
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.6.2

**Критерии приемки:**
- Интеграция работает корректно
- Баллы рассчитываются автоматически при изменении чекбоксов
- Домик определяется автоматически при изменении чекбоксов
- Индикатор домика отображается в таблице
- Информация о домике сохраняется

<output_format>
После выполнения задачи должна быть реализована интеграция системы баллов и домиков с проверкой ДЗ. Баллы должны рассчитываться автоматически, домик должен определяться автоматически, индикатор домика должен отображаться в таблице. Информация о домике должна сохраняться при сохранении проверки ДЗ.
</output_format>

---

### Task 15.05: Сохранение истории домиков

<context>
Сохранение истории домиков необходимо для отслеживания прогресса учеников. Правильная реализация с сохранением информации о получении домика и связыванием с уроком и учеником критически важна для работы системы мотивации.
</context>

<task>
Обнови Server Action создания проверки ДЗ для сохранения информации о получении домика. Создай функцию для получения истории домиков ученика. Связывай домик с уроком и учеником.
</task>

<constraints>
- Информация о получении домика должна сохраняться при создании проверки ДЗ
- Домик должен связываться с уроком и учеником
- Функция получения истории домиков должна работать корректно
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.5.4 Домики для понимания требований
2. Изучи DATA_MODELING.md для понимания структуры данных
3. Определи логику сохранения информации о домике
4. Продумай структуру функции получения истории домиков
5. Только после этого обновляй Server Action
</thinking>

**Действия:**
- [ ] Обновить Server Action создания проверки ДЗ:
  - Сохранять информацию о получении домика (поле `houseEarned`)
  - Связывать домик с уроком и учеником через связи в базе данных
- [ ] Создать функцию `getPupilHouseHistory(pupilId)` для получения истории домиков ученика
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.5.4 Домики</CRITICAL>
- [DATA_MODELING.md](../../../database/DATA_MODELING.md)
- Context7: AWS Amplify Gen 1 amplifyData документация

**Критерии приемки:**
- История домиков сохраняется корректно
- Можно получить историю домиков ученика
- Домик связывается с уроком и учеником
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция сохранения истории домиков. Информация о получении домика должна сохраняться при создании проверки ДЗ, домик должен связываться с уроком и учеником. Функция получения истории домиков должна работать корректно.
</output_format>

---

### Task 15.06: Тестирование функционала баллов и домиков

<context>
Тестирование функционала баллов и домиков является финальным этапом фазы. Комплексное тестирование всех функций, расчета баллов, получения домика, визуализации и сохранения истории критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала системы баллов и домиков. Протестируй расчет баллов, получение домика, визуализацию домиков и сохранение истории для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции системы баллов и домиков
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Расчет баллов должен быть протестирован для всех настроек группы
- Получение домика должно быть протестировано для всех сценариев
- Визуализация домиков должна быть протестирована
- Сохранение истории должно быть протестировано
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Подготовь тестовые настройки группы с разными параметрами
5. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать расчет баллов для всех настроек группы
- [ ] Протестировать получение домика для всех сценариев
- [ ] Протестировать визуализацию домиков
- [ ] Протестировать сохранение истории домиков
- [ ] Протестировать интеграцию с проверкой ДЗ
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- Расчет баллов работает для всех настроек группы
- Получение домика работает для всех сценариев
- Визуализация домиков работает корректно
- Сохранение истории работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала системы баллов и домиков. Все функции должны работать корректно, расчет баллов должен работать для всех настроек группы, получение домика должно работать для всех сценариев. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.6 Система мотивации
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.5.4 Домики

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

