# Phase 15: Система баллов и кирпичиков

## Описание фазы
Реализация системы баллов и кирпичиков: автоматический расчет баллов на основе настроек группы, логика выдачи кирпичиков (за каждый балл = 1 кирпичик), интерфейс выдачи кирпичиков, визуализация баллов и кирпичиков.

## Зависимости
Phase 14: Проверка домашних заданий (Homework Checks)

## Оценка времени
4-5 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Расчеты и бизнес-логика
- Визуализация данных
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI, lucide-react
Ограничения: MVP подход, система баллов и кирпичиков критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для системы мотивации. Правильная реализация расчета баллов, логики выдачи кирпичиков и визуализации критически важна для работы системы мотивации.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Расчет баллов должен учитывать настройки группы. Логика выдачи кирпичиков должна работать корректно (за каждый балл = 1 кирпичик). Визуализация баллов и кирпичиков должна быть понятной для пользователей. Интерфейс выдачи кирпичиков должен быть построен по аналогии с интерфейсом проверки ДЗ.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 15.01: Реализация логики расчета баллов

<context>
<CRITICAL>Это критически важная задача для системы мотивации!</CRITICAL> Логика расчета баллов является основой системы мотивации. Правильная реализация с учетом настроек группы и всех параметров критически важна для корректности оценивания.
</context>

<task>
Создай утилиту для расчета баллов. Реализуй функции для расчета общей суммы баллов за все уроки и среднего балла. Учитывай настройки группы (баллы за каждый параметр). Интегрируй расчет в компоненты.
</task>

<constraints>
- Функция должна рассчитывать общую сумму баллов за все уроки
- Должны учитываться настройки группы (баллы за каждый параметр)
- Функция должна рассчитывать средний балл
- Обработка ошибок должна быть реализована
- Функции должны быть оптимизированы для производительности
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.6.1 Система баллов для понимания логики расчета
2. Изучи MVP_SCOPE.md раздел 2.11.3 Настройка баллов для понимания настроек
3. Определи структуру функций и логику расчета баллов
4. Продумай интеграцию с компонентами
5. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/points.ts`
- [ ] Реализовать функцию `calculateTotalPoints(homeworkChecks, gradeSettings)`:
  - Рассчитывает общую сумму баллов за все уроки
  - Учитывает настройки группы (баллы за каждый параметр)
  - Возвращает общую сумму
- [ ] Реализовать функцию `calculateAveragePoints(points, lessonsCount)`:
  - Рассчитывает средний балл
- [ ] Интегрировать расчет в компоненты
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.6.1 Система баллов</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11.3 Настройка баллов</CRITICAL>

**Критерии приемки:**
- Расчет баллов работает корректно
- Средний балл рассчитывается правильно
- Учитываются настройки группы
- Интеграция с компонентами работает

<output_format>
После выполнения задачи должна быть создана утилита для расчета баллов. Функции должны работать корректно, учитывая все настройки группы. Расчет должен интегрироваться в компоненты и выполняться автоматически.
</output_format>

---

### Task 15.02: Реализация логики выдачи кирпичиков

<context>
Логика выдачи кирпичиков является частью системы мотивации. Правильная реализация с отслеживанием выдачи кирпичиков за каждый балл критически важна для корректности системы мотивации. За каждый балл ученик получает 1 бумажный кирпичик.
</context>

<task>
Создай утилиту для расчета количества кирпичиков. Реализуй функции для подсчета набранных баллов (которые равны количеству кирпичиков) и отслеживания выданных кирпичиков. Интегрируй логику в интерфейс выдачи кирпичиков.
</task>

<constraints>
- За каждый балл = 1 кирпичик
- Функция должна подсчитывать общее количество набранных баллов (кирпичиков) за учебный год
- Функция должна отслеживать количество выданных кирпичиков
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.9 для понимания логики кирпичиков
2. Определи структуру функций и логику подсчета баллов и кирпичиков
3. Продумай интеграцию с интерфейсом выдачи кирпичиков
4. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/bricks.ts`
- [ ] Реализовать функцию `calculateTotalBricks(homeworkChecks)`:
  - Подсчитывает общее количество набранных баллов (кирпичиков) за учебный год
  - Возвращает общее количество кирпичиков
- [ ] Реализовать функцию `calculateBricksByCategory(homeworkChecks)`:
  - Подсчитывает количество кирпичиков по категориям (золотые стихи, тест, тетрадь, спевка)
  - Возвращает разбивку по категориям
- [ ] Реализовать функцию `getIssuedBricks(pupilId, academicYearId)`:
  - Получает количество выданных кирпичиков для ученика за учебный год
- [ ] Интегрировать логику в интерфейс выдачи кирпичиков
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - раздел 4.9 Личные данные ученика</CRITICAL>

**Критерии приемки:**
- Логика подсчета кирпичиков работает корректно
- Подсчет по категориям работает правильно
- Интеграция с интерфейсом выдачи кирпичиков работает

<output_format>
После выполнения задачи должна быть создана утилита для расчета количества кирпичиков. Функции должны работать корректно, подсчитывая набранные баллы (кирпичики) и отслеживая выданные кирпичики. Логика должна интегрироваться в интерфейс выдачи кирпичиков.
</output_format>

---

### Task 15.03: Создание визуализации баллов и кирпичиков

<context>
Визуализация баллов и кирпичиков является важной частью системы мотивации. Правильное отображение количества баллов и кирпичиков критически важно для мотивации учеников и удобства работы учителей.
</context>

<task>
Создай компоненты для визуализации баллов и кирпичиков. Реализуй компонент отображения баллов, компонент отображения кирпичиков и компонент разбивки по категориям. Используй иконки из lucide-react или кастомные изображения.
</task>

<constraints>
- Компонент отображения баллов должен показывать общее количество баллов за учебный год
- Компонент отображения кирпичиков должен показывать набранные и выданные кирпичики
- Компонент разбивки должен показывать баллы по категориям (золотые стихи, тест, тетрадь, спевка)
- Используй иконки из lucide-react или кастомные изображения
- Компоненты должны следовать дизайн-системе проекта
- Компоненты должны быть доступны (WCAG 2.1 AA)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.9 для понимания требований
2. Изучи DESIGN_SYSTEM.md раздел Iconography для понимания дизайна
3. Определи структуру компонентов и визуальное отображение
4. Продумай использование иконок из lucide-react
5. Только после этого создавай компоненты
</thinking>

**Действия:**
- [ ] Создать компонент `components/shared/points-display.tsx`:
  - Отображает общее количество баллов за учебный год
- [ ] Создать компонент `components/shared/bricks-display.tsx`:
  - Отображает набранные и выданные кирпичики
  - Показывает прогресс выдачи
- [ ] Создать компонент `components/shared/points-breakdown.tsx`:
  - Отображает разбивку баллов по категориям
  - Показывает количество кирпичиков по каждой категории
- [ ] Использовать иконки из lucide-react или кастомные изображения
- [ ] Следовать дизайн-системе проекта

**Документация:**
- [app_functionality.md](../../../app_functionality.md) - раздел 4.9 Личные данные ученика
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел Iconography
- Context7: lucide-react документация

**Критерии приемки:**
- Визуализация баллов и кирпичиков создана
- Компоненты отображаются корректно
- Иконки понятны и соответствуют дизайн-системе

<output_format>
После выполнения задачи должны быть созданы компоненты для визуализации баллов и кирпичиков. Компоненты должны отображаться корректно, показывая количество баллов, кирпичиков и разбивку по категориям. Компоненты должны быть готовы к использованию в различных местах приложения.
</output_format>

---

### Task 15.04: Создание интерфейса выдачи кирпичиков

<context>
Интерфейс выдачи кирпичиков является критически важной частью системы мотивации. Правильная реализация интерфейса по аналогии с интерфейсом последовательной проверки ДЗ (раздел 4.1 в TEACHER_FLOWS.md) критически важна для удобства работы учителей при выдаче кирпичиков ученикам. Интерфейс должен поддерживать последовательную выдачу в полноэкранном режиме по одному ученику, аналогично проверке домашних заданий.
</context>

<task>
Создай интерфейс выдачи кирпичиков по аналогии с интерфейсом последовательной проверки ДЗ. Реализуй полноэкранную страницу для последовательной выдачи кирпичиков всем ученикам группы. Отображай количество набранных баллов (кирпичиков) и количество уже выданных кирпичиков для каждого ученика.
</task>

<constraints>
- Интерфейс должен быть построен по аналогии с интерфейсом последовательной проверки ДЗ (раздел 4.1 в TEACHER_FLOWS.md)
- Интерфейс должен поддерживать последовательную выдачу (полноэкранный режим по одному ученику)
- Интерфейс должен отображать для каждого ученика:
  - Суммарное количество баллов за текущий учебный год
  - Количество набранных кирпичиков (равно количеству баллов)
  - Количество уже выданных кирпичиков
  - Остаток невыданных кирпичиков
  - Разбивку баллов по категориям с указанием кирпичиков для каждой категории (золотые стихи, тест, тетрадь, спевка)
- Должна быть возможность отметить выдачу кирпичиков (количество, дата)
- Интерфейс должен работать в полноэкранном режиме с автоматическим переходом к следующему ученику
- Интерфейс должен работать без перезагрузки страницы
- Навигация должна включать кнопки "← Предыдущий" и "Следующий →" вверху и внизу экрана
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.8 для понимания интерфейса проверки ДЗ
2. Определи структуру интерфейса выдачи кирпичиков
3. Продумай логику отображения и сохранения выдачи кирпичиков
4. Только после этого создавай интерфейс
</thinking>

**Действия:**
- [ ] Создать страницу `/grades/:gradeId/issue-bricks` для выдачи кирпичиков группе
- [ ] Реализовать полноэкранный режим последовательной выдачи:
  - Отображение списка учеников с информацией о баллах и кирпичиках
  - Кнопка "▶ Последовательная выдача" для перехода в полноэкранный режим
  - Полноэкранная страница с одним учеником на экране
  - Индикатор прогресса (например, "5 из 15 (33%)")
- [ ] Создать компонент `components/teacher/BricksIssueForm.tsx`:
  - Отображает информацию о баллах и кирпичиках для каждого ученика:
    - Суммарное количество баллов за текущий учебный год
    - Количество набранных кирпичиков (равно количеству баллов)
    - Количество уже выданных кирпичиков
    - Остаток невыданных кирпичиков
    - Разбивку баллов по категориям с указанием кирпичиков
  - Позволяет отметить выдачу кирпичиков (количество, дата)
  - Реализует последовательную выдачу с автоматическим переходом к следующему ученику
  - Кнопки навигации "← Предыдущий" и "Следующий →"
- [ ] Создать Server Action `actions/bricks.ts`:
  - Сохраняет информацию о выдаче кирпичиков (количество, дата, ученик, учебный год)
  - Получает историю выдачи кирпичиков
- [ ] Добавить обработку ошибок

**Документация:**
- [app_functionality.md](../../../app_functionality.md) - раздел 4.8 Проверка домашних заданий
- [app_functionality.md](../../../app_functionality.md) - раздел 4.9 Личные данные ученика

**Критерии приемки:**
- Интерфейс выдачи кирпичиков создан
- Отображается информация о набранных и выданных кирпичиках
- Можно отметить выдачу кирпичиков для каждого ученика
- Информация о выдаче сохраняется

<output_format>
После выполнения задачи должен быть создан интерфейс выдачи кирпичиков. Интерфейс должен работать по аналогии с проверкой ДЗ, отображая информацию о набранных и выданных кирпичиках и позволяя отметить выдачу для каждого ученика. Информация о выдаче должна сохраняться.
</output_format>

---

### Task 15.05: Сохранение истории выдачи кирпичиков

<context>
Сохранение истории выдачи кирпичиков необходимо для отслеживания прогресса учеников. Правильная реализация с сохранением информации о выдаче кирпичиков и связыванием с учеником и учебным годом критически важна для работы системы мотивации.
</context>

<task>
Создай Server Action для сохранения информации о выдаче кирпичиков. Создай функцию для получения истории выдачи кирпичиков ученика. Связывай выдачу кирпичиков с учеником и учебным годом.
</task>

<constraints>
- Информация о выдаче кирпичиков должна сохраняться при отметке выдачи
- История должна включать дату выдачи кирпичиков
- История должна быть привязана к учебному году
- Выдача кирпичиков должна связываться с учеником и учебным годом
- Функция получения истории выдачи кирпичиков должна работать корректно с фильтрацией по учебному году
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.9 для понимания требований
2. Изучи DATA_MODELING.md для понимания структуры данных
3. Определи логику сохранения информации о выдаче кирпичиков
4. Продумай структуру функции получения истории выдачи кирпичиков
5. Только после этого создавай Server Action
</thinking>

**Действия:**
- [ ] Создать Server Action `actions/bricks.ts`:
  - Сохранять информацию о выдаче кирпичиков (количество, дата выдачи, ученик, учебный год)
  - Сохранение даты выдачи при отметке выдачи (обязательное поле)
  - Связывать выдачу с учеником и учебным годом через связи в базе данных
- [ ] Создать функцию `getPupilBricksHistory(pupilId, academicYearId)` для получения истории выдачи кирпичиков ученика:
  - Получение истории с фильтрацией по учебному году
  - Возврат истории с датами выдачи в хронологическом порядке
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - раздел 4.9 Личные данные ученика</CRITICAL>
- [DATA_MODELING.md](../../../database/DATA_MODELING.md)
- Context7: AWS Amplify Gen 1 amplifyData документация

**Критерии приемки:**
- История выдачи кирпичиков сохраняется корректно
- Можно получить историю выдачи кирпичиков ученика
- Выдача связывается с учеником и учебным годом
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция сохранения истории выдачи кирпичиков. Информация о выдаче кирпичиков должна сохраняться при отметке выдачи, выдача должна связываться с учеником и учебным годом. Функция получения истории выдачи кирпичиков должна работать корректно.
</output_format>

---

### Task 15.06: Тестирование функционала баллов и кирпичиков

<context>
Тестирование функционала баллов и кирпичиков является финальным этапом фазы. Комплексное тестирование всех функций, расчета баллов, выдачи кирпичиков, визуализации и сохранения истории критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала системы баллов и кирпичиков. Протестируй расчет баллов, выдачу кирпичиков, визуализацию баллов и кирпичиков и сохранение истории для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции системы баллов и кирпичиков
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Расчет баллов должен быть протестирован для всех настроек группы
- Выдача кирпичиков должна быть протестирована для всех сценариев
- Визуализация баллов и кирпичиков должна быть протестирована
- Сохранение истории должно быть протестировано
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Подготовь тестовые настройки группы с разными параметрами
5. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать расчет баллов для всех настроек группы
- [ ] Протестировать выдачу кирпичиков для всех сценариев
- [ ] Протестировать визуализацию баллов и кирпичиков
- [ ] Протестировать сохранение истории выдачи кирпичиков
- [ ] Протестировать интерфейс выдачи кирпичиков
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- Расчет баллов работает для всех настроек группы
- Выдача кирпичиков работает для всех сценариев
- Визуализация баллов и кирпичиков работает корректно
- Сохранение истории работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала системы баллов и кирпичиков. Все функции должны работать корректно, расчет баллов должен работать для всех настроек группы, выдача кирпичиков должна работать для всех сценариев. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [app_functionality.md](../../../app_functionality.md) - раздел 4.8 Проверка домашних заданий
- [app_functionality.md](../../../app_functionality.md) - раздел 4.9 Личные данные ученика

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

