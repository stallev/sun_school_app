# Phase 14: Проверка домашних заданий (Homework Checks)

## Описание фазы
Реализация массовой проверки домашних заданий: таблица проверки для всех учеников группы, сохранение результатов, расчет баллов на основе настроек группы.

## Зависимости
Phase 13: Управление уроками (Lessons)

## Оценка времени
6-8 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Массовые операции с данными
- Расчеты и бизнес-логика
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, массовая проверка ДЗ критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для проверки домашних заданий. Правильная реализация массовой проверки и расчета баллов определит качество работы системы оценивания.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Массовая проверка ДЗ обязательна. Расчет баллов должен учитывать настройки группы. Интерфейс проверки должен поддерживать ввод баллов для каждого параметра (золотые стихи 0-2, тест и тетрадь 0-10).</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 14.01: Создание Server Actions для проверки ДЗ

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для проверки ДЗ являются основой всего функционала проверки домашних заданий. Правильная реализация с массовым созданием проверок, проверкой прав доступа и валидацией определит эффективность работы системы.
</context>

<task>
Создай Server Actions для управления проверками ДЗ в файле `actions/homework.ts`. Реализуй все операции, включая массовое создание проверок, с проверкой прав доступа и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа
- Массовое создание проверок должно быть оптимизировано
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Homework для понимания требований к API
2. Изучи VALIDATION.md раздел Homework Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа
5. Продумай оптимизацию массового создания проверок
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/homework.ts` с директивой `'use server'`
- [ ] Реализовать `createHomeworkCheck(input)` - создание проверки
- [ ] Реализовать `updateHomeworkCheck(input)` - обновление проверки
- [ ] Реализовать `bulkCreateHomeworkChecks(inputs)` - массовое создание проверок
- [ ] Реализовать `getHomeworkChecks(lessonId)` - получение проверок для урока
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Homework и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (урок, ученик) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Homework Schemas</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4 Проверка домашних заданий</CRITICAL>
- Context7: Next.js 15.5.9 Server Actions документация

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно
- Валидация работает корректно
- Массовое создание проверок работает эффективно

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления проверками ДЗ. Все функции должны иметь проверку прав доступа и валидацию через Zod схемы. Массовое создание проверок должно работать эффективно.
</output_format>

---

### Task 14.02: Создание таблицы массовой проверки

<context>
<CRITICAL>Это критически важная задача для массовой проверки ДЗ!</CRITICAL> Таблица массовой проверки является основным компонентом для работы с проверкой домашних заданий. Правильная реализация с отображением только включенных параметров критически важна для удобства работы пользователей.
</context>

<task>
Создай Client Component таблицы массовой проверки. Реализуй таблицу со списком всех учеников группы с чекбоксами для каждого параметра. Показывай только включенные параметры из настроек группы.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Таблица должна отображать всех учеников группы
- Чекбоксы должны быть для каждого параметра: Золотые стихи, Оценка за тест, Оценка за тетрадь, Посещение спевки
- Показывай только включенные параметры из настроек группы
- Используй компоненты Shadcn UI (Table, Checkbox)
- Состояние чекбоксов должно управляться через React state
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Homework Check Table для понимания дизайна
2. Изучи MVP_SCOPE.md раздел 2.4.1 для понимания требований
3. Определи структуру компонента и управление состоянием
4. Продумай логику отображения только включенных параметров
5. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать Client Component `components/teacher/homework/homework-check-table.tsx` (или `components/admin/homework/homework-check-table.tsx`)
- [ ] Реализовать таблицу со списком всех учеников группы
- [ ] Добавить чекбоксы для каждого параметра:
  - Золотые стихи
  - Оценка за тест
  - Оценка за тетрадь
  - Посещение спевки
- [ ] Показывать только включенные параметры (из настроек группы)
- [ ] Использовать компоненты Shadcn UI (Table, Checkbox)
- [ ] Управлять состоянием чекбоксов через React state

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Homework Check Table</CRITICAL>
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4.1
- Context7: Shadcn UI Table документация
- Context7: Shadcn UI Checkbox документация

**Критерии приемки:**
- Таблица создана и работает
- Чекбоксы работают корректно
- Параметры отображаются согласно настройкам группы
- Состояние чекбоксов управляется правильно

<output_format>
После выполнения задачи должна быть создана таблица массовой проверки. Таблица должна отображать всех учеников группы с чекбоксами для включенных параметров. Компонент должен быть готов к использованию на странице проверки ДЗ.
</output_format>

---

### Task 14.03: Реализация автоматического расчета баллов

<context>
<CRITICAL>Это критически важная задача для системы оценивания!</CRITICAL> Автоматический расчет баллов на основе настроек группы является основой системы мотивации. Правильная реализация с учетом всех параметров и настроек критически важна для корректности оценивания.
</context>

<task>
Создай утилиту для автоматического расчета баллов. Реализуй функцию, которая рассчитывает баллы на основе настроек группы, учитывая включенные параметры. Интегрируй расчет в форму проверки ДЗ.
</task>

<constraints>
- Функция должна рассчитывать баллы на основе настроек группы
- Должны учитываться только включенные параметры
- Баллы должны рассчитываться автоматически при изменении чекбоксов
- Функция должна возвращать общую сумму баллов для каждого ученика
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.6.1 Система баллов для понимания логики расчета
2. Изучи MVP_SCOPE.md раздел 2.11.3 Настройка баллов для понимания настроек
3. Определи структуру функции и логику расчета баллов
4. Продумай интеграцию с формой проверки ДЗ
5. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/homework.ts`
- [ ] Реализовать функцию `calculatePoints(checks, gradeSettings)`:
  - Рассчитывает баллы на основе настроек группы
  - Учитывает включенные параметры
  - Возвращает общую сумму баллов для каждого ученика
- [ ] Интегрировать расчет в форму проверки ДЗ (автоматический расчет при изменении чекбоксов)
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.6.1 Система баллов</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11.3 Настройка баллов</CRITICAL>

**Критерии приемки:**
- Расчет баллов работает корректно
- Учитываются настройки группы
- Баллы рассчитываются автоматически при изменении чекбоксов
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана утилита для автоматического расчета баллов. Функция должна работать корректно, учитывая все настройки группы и включенные параметры. Расчет должен интегрироваться в форму проверки ДЗ и выполняться автоматически.
</output_format>

---

### Task 14.04: Реализация логики получения домика

<context>
Логика получения домика является частью системы мотивации. Правильная реализация с проверкой всех параметров критически важна для корректности определения получения домика учеником.
</context>

<task>
Реализуй функцию для определения получения домика. Функция должна проверять, все ли параметры выполнены (все чекбоксы отмечены), и возвращать true, если домик получен. Интегрируй логику в форму проверки ДЗ и отобрази индикатор домика в таблице.
</task>

<constraints>
- Функция должна проверять, все ли включенные параметры выполнены
- Домик должен получаться только если все включенные параметры отмечены
- Логика должна интегрироваться в форму проверки ДЗ
- Индикатор домика должен отображаться в таблице
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи app_functionality.md раздел 4.8 Проверка домашних заданий для понимания логики
2. Определи структуру функции и логику проверки всех параметров
3. Продумай интеграцию с формой проверки ДЗ
4. Продумай визуальное отображение индикатора домика
5. Только после этого реализуй функцию
</thinking>

**Действия:**
- [ ] Реализовать функцию `calculateHouse(checks, gradeSettings)` в утилите `lib/utils/homework.ts`:
  - Проверяет, все ли включенные параметры выполнены (все чекбоксы отмечены)
  - Возвращает true, если домик получен
- [ ] Интегрировать логику в форму проверки ДЗ (автоматическое определение при изменении чекбоксов)
- [ ] Отобразить индикатор домика в таблице (иконка или Badge)
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[app_functionality.md](../../../app_functionality.md) - раздел 4.8 Проверка домашних заданий</CRITICAL>

**Критерии приемки:**
- Логика получения домика работает корректно
- Индикатор отображается корректно в таблице
- Определение домика происходит автоматически при изменении чекбоксов
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована логика расчета баллов. Функция должна работать корректно, суммируя все компоненты (золотые стихи, тест, тетрадь, спевка). Общее количество баллов должно отображаться в таблице.
</output_format>

---

### Task 14.05: Создание страницы проверки ДЗ

<context>
Страница проверки ДЗ является центральной точкой для работы с проверкой домашних заданий. Правильная реализация с интеграцией таблицы массовой проверки, автоматическим расчетом баллов и определением домика критически важна для удобства работы пользователей.
</context>

<task>
Создай страницу проверки ДЗ с динамическим маршрутом. Реализуй Server Component для загрузки данных урока и учеников. Интегрируй таблицу массовой проверки с автоматическим расчетом баллов и определением домика. Добавь кнопку сохранения результатов.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Таблица массовой проверки должна быть интегрирована
- Автоматический расчет баллов должен работать при изменении чекбоксов
- Расчет баллов должен происходить автоматически
- Кнопка сохранения результатов должна быть доступна
- Добавь обработку ошибок и loading state
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Homework Check Page для понимания дизайна
2. Изучи USER_FLOW.md раздел Check Homework для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи структуру страницы и интеграцию компонентов
5. Продумай логику загрузки данных и сохранения результатов
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/lessons/[lessonId]/homework-check/page.tsx`
- [ ] Реализовать Server Component для загрузки данных урока и учеников через Server Actions
- [ ] Интегрировать таблицу массовой проверки (Task 14.02)
- [ ] Интегрировать автоматический расчет баллов (Task 14.03)
- [ ] Интегрировать расчет баллов (Task 14.04)
- [ ] Добавить кнопку сохранения результатов
- [ ] Добавить обработку ошибок и loading state
- [ ] Использовать компоненты Shadcn UI

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Homework Check Page</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Check Homework
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 4.1 Последовательная проверка ДЗ
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 7.2 Проверка ДЗ для любой группы
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Страница создана и работает
- Таблица отображается корректно
- Автоматический расчет баллов работает
- Расчет баллов работает
- Сохранение работает корректно
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана страница проверки ДЗ. Страница должна интегрировать все компоненты: таблицу массовой проверки, автоматический расчет баллов. Сохранение результатов должно работать корректно.
</output_format>

---

### Task 14.06: Реализация сохранения результатов

<context>
Сохранение результатов проверки ДЗ является критически важной функцией. Правильная реализация с массовым и частичным сохранением, валидацией данных и уведомлениями критически важна для надежности системы.
</context>

<task>
Реализуй сохранение результатов проверки ДЗ. Реализуй массовое сохранение для всех учеников и частичное сохранение (можно сохранить часть и продолжить позже). Добавь валидацию данных перед сохранением и покажи Toast уведомления об успехе/ошибке.
</task>

<constraints>
- Массовое сохранение должно работать для всех учеников одновременно
- Частичное сохранение должно позволять сохранить часть проверок и продолжить позже
- Валидация данных должна выполняться перед сохранением
- Toast уведомления должны показываться об успехе/ошибке
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.4.1 Сохранение результатов для понимания требований
2. Определи логику массового и частичного сохранения
3. Продумай валидацию данных перед сохранением
4. Определи структуру Toast уведомлений
5. Только после этого реализуй сохранение
</thinking>

**Действия:**
- [ ] Реализовать массовое сохранение для всех учеников через Server Action `bulkCreateHomeworkChecks`
- [ ] Реализовать частичное сохранение (можно сохранить часть и продолжить позже)
- [ ] Добавить валидацию данных перед сохранением через Zod схемы
- [ ] Показать Toast уведомления об успехе/ошибке через Shadcn UI Toast
- [ ] Добавить обработку ошибок с понятными сообщениями

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4.1 Сохранение результатов</CRITICAL>
- [DESIGN_SYSTEM.md](../../../ui_ux/DESIGN_SYSTEM.md) - раздел Toast
- Context7: Shadcn UI Toast документация

**Критерии приемки:**
- Сохранение работает корректно
- Частичное сохранение работает
- Валидация данных работает
- Уведомления показываются корректно
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция сохранения результатов проверки ДЗ. Массовое и частичное сохранение должны работать корректно, валидация должна выполняться перед сохранением, уведомления должны показываться.
</output_format>

---

### Task 14.07: Реализация редактирования проверки ДЗ

<context>
Редактирование проверки ДЗ позволяет изменять результаты проверки после сохранения. Правильная реализация с предзаполнением данных, автоматическим обновлением статуса домика и расчетом баллов критически важна для удобства работы пользователей.
</context>

<task>
Создай страницу редактирования проверки ДЗ. Загрузи существующие данные проверки, предзаполни форму данными и обнови проверку через Server Action. Обновляй статус домика и расчет баллов при изменении параметров.
</task>

<constraints>
- Страница редактирования должна использовать ту же таблицу массовой проверки
- Данные проверки должны загружаться при загрузке страницы
- Форма должна предзаполняться данными проверки
- Обновление должно выполняться через Server Action `updateHomeworkCheck`
- Расчет баллов должен обновляться автоматически при изменении параметров
- Расчет баллов должен обновляться автоматически
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.4.2 Редактирование проверки ДЗ для понимания требований
2. Определи структуру страницы редактирования
3. Продумай логику загрузки и предзаполнения данных
4. Продумай логику обновления статуса домика и расчета баллов
5. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать страницу редактирования проверки ДЗ
- [ ] Реализовать Server Component для загрузки данных проверки через Server Action
- [ ] Загрузить существующие данные проверки для всех учеников
- [ ] Предзаполнить форму данными проверки (чекбоксы, баллы, домик)
- [ ] Обновить проверку через Server Action `updateHomeworkCheck`
- [ ] Обновить статус домика автоматически при изменении параметров
- [ ] Обновить расчет баллов автоматически при изменении параметров
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4.2 Редактирование проверки ДЗ</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 4.1 Последовательная проверка ДЗ
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 7.2 Проверка ДЗ для любой группы
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Редактирование работает корректно
- Данные предзаполняются правильно
- Расчет баллов обновляется автоматически
- Расчет баллов обновляется автоматически
- Обновление работает через Server Action
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана страница редактирования проверки ДЗ. Данные должны предзаполняться корректно, расчет баллов должен обновляться автоматически при изменении параметров. Обновление должно работать через Server Action.
</output_format>

---

### Task 14.08: Тестирование функционала проверки ДЗ

<context>
Тестирование функционала проверки ДЗ является финальным этапом фазы. Комплексное тестирование всех функций, массовой проверки, расчета баллов, получения домика и сохранения результатов критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала проверки домашних заданий. Протестируй массовую проверку, расчет баллов, сохранение результатов и редактирование проверки для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции проверки ДЗ
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Массовая проверка должна быть протестирована
- Расчет баллов должен быть протестирован для всех настроек группы
- Расчет баллов должен быть протестирован для всех сценариев
- Сохранение результатов должно быть протестировано (массовое и частичное)
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Подготовь тестовые настройки группы с разными параметрами
5. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать массовую проверку (Admin и Teacher)
- [ ] Протестировать расчет баллов для всех настроек группы
- [ ] Протестировать расчет баллов для всех сценариев
- [ ] Протестировать сохранение результатов (массовое и частичное)
- [ ] Протестировать редактирование проверки
- [ ] Протестировать обработку ошибок
- [ ] Протестировать проверку прав доступа

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- Массовая проверка работает корректно
- Расчет баллов работает для всех настроек группы
- Расчет баллов работает для всех сценариев
- Сохранение результатов работает корректно
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала проверки ДЗ. Все функции должны работать корректно, расчет баллов должен работать для всех настроек группы. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Homework Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Homework Schemas
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Homework Pages
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

