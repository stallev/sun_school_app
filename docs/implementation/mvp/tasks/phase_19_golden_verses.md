# Phase 19: Библиотека золотых стихов

## Описание фазы
Реализация библиотеки золотых стихов: просмотр списка всех стихов, поиск по тексту, фильтрация по книге/главе, статистика использования в уроках.

## Зависимости
Phase 13: Управление уроками (Lessons)

## Оценка времени
4-5 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Поиск и фильтрация данных
- Статистика и аналитика
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, библиотека золотых стихов критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для библиотеки золотых стихов. Правильная реализация поиска, фильтрации и статистики критически важна для удобства работы с золотыми стихами.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Поиск по тексту стиха обязателен. Фильтрация по книге и главе должна работать корректно. Статистика использования должна отображаться для каждого стиха.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 19.01: Создание Server Actions для золотых стихов

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для золотых стихов являются основой библиотеки золотых стихов. Правильная реализация с поиском, фильтрацией и статистикой критически важна для удобства работы с золотыми стихами.
</context>

<task>
Создай Server Actions для работы с золотыми стихами в файле `actions/goldenVerses.ts`. Реализуй получение стиха, список стихов с фильтрацией, поиск по тексту и статистику использования.
</task>

<constraints>
- Поиск по тексту должен работать эффективно
- Фильтрация должна работать по книге и главе
- Статистика использования должна рассчитываться на основе использования в уроках
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Golden Verses для понимания требований к API
2. Изучи MVP_SCOPE.md раздел 2.9 Библиотека золотых стихов для понимания требований
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции и логику поиска/фильтрации
5. Продумай расчет статистики использования
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/goldenVerses.ts` с директивой `'use server'`
- [ ] Реализовать `getGoldenVerse(id)` - получение стиха с загрузкой связанного Book
- [ ] Реализовать `listGoldenVerses(filters)` - список стихов с фильтрацией по bookId и главе
- [ ] Реализовать `searchGoldenVerses(query)` - поиск по тексту стиха
- [ ] Реализовать `getGoldenVerseStats(verseId)` - статистика использования (количество использований в уроках)
- [ ] Использовать amplifyData для работы с базой данных
- [ ] Использовать bookId вместо book в схемах валидации

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Golden Verses и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (книга, уроки) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.9 Библиотека золотых стихов</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/goldenVerses.ts](../../../../src/lib/validation/goldenVerses.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getGoldenVerse, listGoldenVerses)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createGoldenVerse, updateGoldenVerse)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для золотых стихов
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Критерии приемки:**
- Все Server Actions созданы
- Фильтрация работает корректно
- Поиск работает корректно
- Статистика рассчитывается правильно

<output_format>
После выполнения задачи должны быть созданы все Server Actions для работы с золотыми стихами. Поиск, фильтрация и статистика должны работать корректно. Код должен быть готов к использованию в компонентах.
</output_format>

---

### Task 19.02: Создание Server Actions для Books

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для Books необходимы для работы с таблицей книг Библии. Эти действия используются в фильтрации и отображении золотых стихов.
</context>

<task>
Создай Server Actions для работы с книгами Библии в файле `actions/books.ts`. Реализуй получение книги, список книг с фильтрацией по завету, поиск по названию и функцию заполнения таблицы при инициализации.
</task>

<constraints>
- Фильтрация должна работать по завету (OLD/NEW)
- Поиск должен работать по fullName, shortName или abbreviation
- Функция seedBooks должна использовать данные из scripts/seed-books-data.ts
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Books для понимания требований к API
2. Изучи DYNAMODB_SCHEMA.md раздел 3.16 Таблица Books для понимания структуры
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции
5. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/books.ts` с директивой `'use server'`
- [ ] Реализовать `getBook(id)` - получение книги по ID
- [ ] Реализовать `listBooks(filters?)` - список книг с фильтрацией по завету
- [ ] Реализовать `searchBooks(query)` - поиск книги по названию
- [ ] Реализовать `seedBooks()` - заполнение таблицы Books (66 книг) - только для ADMIN/SUPERADMIN
- [ ] Использовать amplifyData для работы с базой данных
- [ ] Использовать данные из scripts/seed-books-data.ts для seedBooks

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Books</CRITICAL>
- <CRITICAL>[DYNAMODB_SCHEMA.md](../../../database/DYNAMODB_SCHEMA.md) - раздел 3.16 Таблица Books</CRITICAL>
- Context7: Next.js 15.5.9 Server Actions документация

**Критерии приемки:**
- Все Server Actions созданы
- Фильтрация работает корректно
- Поиск работает корректно
- seedBooks заполняет все 66 книг

<output_format>
После выполнения задачи должны быть созданы все Server Actions для работы с книгами Библии. Фильтрация и поиск должны работать корректно. Код должен быть готов к использованию в компонентах.
</output_format>

---

### Task 19.03: Создание UI для списка стихов

<context>
Страница списка золотых стихов является основной точкой входа для работы с библиотекой золотых стихов. Правильная реализация с отображением всех данных стиха и пагинацией критически важна для удобства работы пользователей.
</context>

<task>
Создай страницу списка золотых стихов. Реализуй Server Component для отображения списка стихов в виде таблицы или карточек. Отобрази текст стиха, книгу, главу, стих. Добавь пагинацию.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Отображай: текст стиха, книгу, главу, стих
- Используй таблицу или карточки для отображения (согласно дизайну)
- Пагинация должна быть реализована для больших списков
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Golden Verses List для понимания дизайна
2. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
3. Определи структуру данных для отображения списка стихов
4. Продумай формат отображения (таблица или карточки)
5. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/golden-verses/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Реализовать таблицу/карточки со списком стихов
- [ ] Отобразить: текст стиха, книгу (book.shortName), главу, стих
- [ ] Загружать связанный Book при отображении стиха
- [ ] Добавить пагинацию для больших списков
- [ ] Использовать компоненты Shadcn UI (Table, Card, Pagination)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Golden Verses List</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Golden Verses
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 8.1 Просмотр библиотеки золотых стихов
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Страница списка создана
- Стихи отображаются корректно
- Пагинация работает

<output_format>
После выполнения задачи должна быть создана страница списка золотых стихов. Список должен отображаться с полной информацией о стихах, пагинация должна работать.
</output_format>

---

### Task 19.04: Реализация поиска по тексту

<context>
Поиск по тексту стиха является критически важной функцией для работы с библиотекой золотых стихов. Правильная реализация с debounce для оптимизации критически важна для производительности системы.
</context>

<task>
Создай компонент поиска по тексту стиха. Реализуй поиск по тексту стиха с debounce для оптимизации. Отобрази результаты поиска в списке стихов.
</task>

<constraints>
- Поиск должен работать по тексту стиха
- Debounce должен быть реализован для оптимизации запросов
- Результаты поиска должны отображаться в списке стихов
- Поиск должен быть интегрирован с Server Action `searchGoldenVerses`
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.9.1 Просмотр стихов для понимания требований
2. Определи структуру компонента поиска и логику debounce
3. Продумай интеграцию с Server Action поиска
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент поиска `components/shared/golden-verse-search.tsx`
- [ ] Реализовать поиск по тексту стиха через Input компонент
- [ ] Добавить debounce для оптимизации (300-500ms)
- [ ] Интегрировать поиск с Server Action `searchGoldenVerses`
- [ ] Отобразить результаты поиска в списке стихов
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.9.1 Просмотр стихов
- Context7: React hooks для debounce документация

**Критерии приемки:**
- Поиск работает корректно
- Debounce работает для оптимизации
- Результаты отображаются корректно
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент поиска по тексту стиха. Поиск должен работать с debounce, результаты должны отображаться корректно.
</output_format>

---

### Task 19.05: Реализация фильтрации

<context>
Фильтрация по книге и главе необходима для удобной работы с библиотекой золотых стихов. Правильная реализация с применением фильтров к списку стихов критически важна для удобства работы пользователей.
</context>

<task>
Создай компонент фильтров для золотых стихов. Реализуй фильтрацию по книге и главе. Примени фильтры к списку стихов через Server Action.
</task>

<constraints>
- Фильтрация должна работать по книге
- Фильтрация должна работать по главе
- Фильтры должны применяться к списку стихов через Server Action `listGoldenVerses`
- Компонент фильтров должен быть интегрирован со страницей списка стихов
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.9.1 Фильтры для понимания требований
2. Определи структуру компонента фильтров и логику применения фильтров
3. Продумай интеграцию с Server Action списка стихов
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент фильтров `components/shared/golden-verse-filters.tsx`
- [ ] Реализовать фильтрацию по книге через Select или Combobox с загрузкой книг из `listBooks()` Server Action
- [ ] Реализовать фильтрацию по главе через Select или Combobox
- [ ] Применить фильтры к списку стихов через Server Action `listGoldenVerses(filters)` с bookId
- [ ] Интегрировать компонент фильтров со страницей списка стихов
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.9.1 Фильтры
- Context7: Shadcn UI Select документация

**Критерии приемки:**
- Фильтрация работает корректно
- Фильтры применяются к списку стихов
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент фильтров для золотых стихов. Фильтрация должна работать корректно, фильтры должны применяться к списку стихов.
</output_format>

---

### Task 19.06: Реализация статистики использования

<context>
Статистика использования золотых стихов необходима для понимания популярности стихов. Правильное отображение статистики критически важно для аналитики использования стихов в уроках.
</context>

<task>
Создай компонент статистики использования золотых стихов. Отобрази количество использований стиха в уроках. Покажи статистику для каждого стиха в списке. Интегрируй с выбором стихов в уроках.
</task>

<constraints>
- Статистика должна рассчитываться на основе использования стиха в уроках
- Количество использований должно отображаться для каждого стиха
- Статистика должна загружаться через Server Action `getGoldenVerseStats`
- Компонент статистики должен быть интегрирован со страницей списка стихов
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.9.2 Статистика для понимания требований
2. Определи структуру компонента статистики и логику расчета
3. Продумай интеграцию с Server Action статистики
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент статистики `components/shared/golden-verse-stats.tsx`
- [ ] Отобразить количество использований стиха в уроках через Server Action `getGoldenVerseStats`
- [ ] Показать статистику для каждого стиха в списке (Badge или текст)
- [ ] Интегрировать компонент статистики со страницей списка стихов
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.9.2 Статистика

**Критерии приемки:**
- Статистика отображается корректно
- Данные корректны (количество использований)
- Компонент интегрирован со страницей списка стихов
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент статистики использования золотых стихов. Статистика должна отображаться корректно для каждого стиха, данные должны быть корректны.
</output_format>

---

### Task 19.07: Интеграция с выбором стихов в уроках

<context>
Интеграция библиотеки золотых стихов с выбором стихов в уроках необходима для использования библиотеки при создании уроков. Правильная интеграция критически важна для удобства работы пользователей.
</context>

<task>
Обнови компонент выбора стихов в форме урока (Task 13.04). Используй библиотеку стихов для выбора через Server Actions. Отобрази выбранные стихи с информацией о стихе.
</task>

<constraints>
- Компонент выбора стихов должен использовать библиотеку стихов через Server Actions
- Выбор должен работать через поиск и фильтрацию из библиотеки
- Выбранные стихи должны отображаться с информацией о стихе (текст, книга, глава, стих)
- Интеграция должна работать с формой создания урока
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.3.1 Выбор золотых стихов для понимания требований
2. Изучи компонент выбора стихов из Task 13.04
3. Определи логику интеграции с библиотекой стихов
4. Продумай отображение выбранных стихов
5. Только после этого обновляй компонент
</thinking>

**Действия:**
- [ ] Обновить компонент выбора стихов в форме урока (Task 13.04)
- [ ] Использовать библиотеку стихов для выбора через Server Actions `listGoldenVerses` и `searchGoldenVerses`
- [ ] Интегрировать поиск и фильтрацию из библиотеки стихов
- [ ] Отобразить выбранные стихи с информацией о стихе (текст, книга, глава, стих)
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.3.1 Выбор золотых стихов</CRITICAL>

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте getLessonWithNestedData() для получения урока с золотыми стихами
- Lesson содержит вложенные данные goldenVerses с данными goldenVerse и book
- LessonGoldenVerse содержит вложенные данные lesson и goldenVerse благодаря @belongsTo
- GoldenVerse содержит вложенные данные book благодаря @belongsTo
- Не требуются отдельные запросы для получения связанных данных

**Критерии приемки:**
- Интеграция работает корректно
- Выбор стихов функционирует через библиотеку
- Выбранные стихи отображаются с полной информацией
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть обновлен компонент выбора стихов в форме урока. Интеграция с библиотекой стихов должна работать корректно, выбор стихов должен функционировать через библиотеку.
</output_format>

---

### Task 19.08: Тестирование функционала библиотеки стихов

<context>
Тестирование функционала библиотеки золотых стихов является финальным этапом фазы. Комплексное тестирование всех функций, просмотра списка, поиска, фильтрации и статистики критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала библиотеки золотых стихов. Протестируй просмотр списка, поиск, фильтрацию, статистику и интеграцию с выбором стихов в уроках для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции библиотеки золотых стихов
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Просмотр списка должен быть протестирован
- Поиск должен быть протестирован для разных запросов
- Фильтрация должна быть протестирована для всех фильтров
- Статистика должна быть протестирована
- Интеграция с выбором стихов должна быть протестирована
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовые аккаунты для разных ролей
4. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать просмотр списка стихов
- [ ] Протестировать поиск по тексту стиха (разные запросы)
- [ ] Протестировать фильтрацию по книге и главе
- [ ] Протестировать статистику использования
- [ ] Протестировать интеграцию с выбором стихов в уроках
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- Просмотр списка работает
- Поиск работает для всех запросов
- Фильтрация работает для всех фильтров
- Статистика работает корректно
- Интеграция с выбором стихов работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала библиотеки золотых стихов. Все функции должны работать корректно, поиск, фильтрация и статистика должны работать. Система должна быть готова к использованию.
</output_format>

---

### Task 19.09: Получение списка золотых стихов группы за учебный год (Post-MVP)

<context>
<CRITICAL>Это post-MVP функционал!</CRITICAL> Реализация получения списка всех золотых стихов, которые учили в конкретной группе в конкретном учебном году. Используется для аналитики и отчетов.

</context>

<task>
Реализуй Server Action для получения списка всех золотых стихов группы за учебный год. Используй существующие GSI (GSI-1 в Lessons и LessonGoldenVerses) и Batch Get для получения стихов.

</task>

<constraints>
- Используй GSI-1 в Lessons (academicYearId-lessonDate) для получения уроков года
- Используй GSI-1 в LessonGoldenVerses (lessonId-order) для получения стихов каждого урока
- Используй Batch Get для получения данных стихов
- Дедуплицируй стихи по goldenVerseId
- Возвращай список уникальных стихов с reference, text, bookId
- Используй amplifyData для работы с базой данных
- Функция должна возвращать discriminated union: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи DATA_MODELING.md раздел 2.4 Golden Verses, access pattern AP-25
2. Изучи ANALYTICS.md раздел 4.4, access pattern AP-ANALYTICS-6
3. Пойми алгоритм: Lessons → LessonGoldenVerses → Batch Get GoldenVerses
4. Продумай дедупликацию стихов
5. Только после этого реализуй Server Action
</thinking>

**Действия:**
- [ ] Добавить функцию `getGoldenVersesByAcademicYear(academicYearId)` в `actions/goldenVerses.ts`
- [ ] Реализовать получение уроков года через GSI-1 (academicYearId-lessonDate)
- [ ] Для каждого урока получить стихи через GSI-1 (lessonId-order)
- [ ] Дедуплицировать стихи по goldenVerseId
- [ ] Использовать Batch Get для получения данных стихов
- [ ] Вернуть список уникальных стихов с reference, text, bookId

**Документация:**
- <CRITICAL>[DATA_MODELING.md](../../../database/DATA_MODELING.md) - раздел 2.4 Golden Verses, AP-25</CRITICAL>
- <CRITICAL>[ANALYTICS.md](../../../database/ANALYTICS.md) - раздел 4.4, AP-ANALYTICS-6</CRITICAL>
- [DYNAMODB_SCHEMA.md](../../../database/DYNAMODB_SCHEMA.md) - раздел 3.7 LessonGoldenVerses

**Критерии приемки:**
- Функция возвращает список уникальных стихов группы за учебный год
- Дедупликация работает корректно
- Все стихи содержат reference, text, bookId
- Используются существующие GSI (дополнительные индексы не требуются)

<output_format>
После выполнения задачи должна быть создана функция для получения списка золотых стихов группы за учебный год. Функция должна использовать существующие GSI и возвращать дедуплицированный список стихов.
</output_format>

---

### Task 19.10: Аналитика сложности золотых стихов (Post-MVP)

<context>
<CRITICAL>Это post-MVP функционал!</CRITICAL> Реализация аналитики для определения, какие стихи легкие для детей (больше детей получило максимальное количество баллов), а какие сложные. Помогает учителям понять, какие стихи требуют дополнительного внимания.

</context>

<task>
Реализуй Server Action для аналитики сложности золотых стихов. Используй существующие GSI (GSI-3 в HomeworkChecks, GSI-1 в Lessons, GSI-1 и GSI-2 в LessonGoldenVerses) и агрегацию на клиенте.

</task>

<constraints>
- Используй GSI-3 в HomeworkChecks (gradeId-createdAt) для получения всех проверок группы за период
- Для каждой проверки получи Lesson и LessonGoldenVerses
- Сопоставь goldenVerse1Score/2Score/3Score с соответствующими стихами по order
- Агрегируй статистику по goldenVerseId: totalChecks, maxScoreCount, successRate, averageScore, difficultyLevel
- Используй amplifyData для работы с базой данных
- Функция должна возвращать discriminated union: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи DATA_MODELING.md раздел 2.4 Golden Verses, access pattern AP-26
2. Изучи ANALYTICS.md раздел 2.5.2 Аналитика сложности золотых стихов и раздел 4.4, access pattern AP-ANALYTICS-7
3. Пойми алгоритм сопоставления баллов со стихами по order
4. Продумай алгоритм агрегации статистики
5. Только после этого реализуй Server Action
</thinking>

**Действия:**
- [ ] Добавить функцию `getGoldenVerseDifficultyAnalysis(gradeId, startDate, endDate)` в `actions/goldenVerses.ts`
- [ ] Реализовать получение всех проверок группы за период через GSI-3 (gradeId-createdAt)
- [ ] Для каждой проверки получить Lesson и LessonGoldenVerses
- [ ] Сопоставить баллы со стихами:
  - goldenVerse1Score с LessonGoldenVerse где order=1
  - goldenVerse2Score с LessonGoldenVerse где order=2
  - goldenVerse3Score с LessonGoldenVerse где order=3
- [ ] Агрегировать статистику по goldenVerseId
- [ ] Рассчитать метрики: totalChecks, maxScoreCount, successRate, averageScore, difficultyLevel
- [ ] Вернуть список стихов с метриками сложности

**Документация:**
- <CRITICAL>[DATA_MODELING.md](../../../database/DATA_MODELING.md) - раздел 2.4 Golden Verses, AP-26</CRITICAL>
- <CRITICAL>[ANALYTICS.md](../../../database/ANALYTICS.md) - раздел 2.5.2 Аналитика сложности и раздел 4.4, AP-ANALYTICS-7</CRITICAL>
- [DYNAMODB_SCHEMA.md](../../../database/DYNAMODB_SCHEMA.md) - раздел 3.7 LessonGoldenVerses и раздел 3.9 HomeworkChecks

**Критерии приемки:**
- Функция возвращает список стихов с метриками сложности
- Сопоставление баллов со стихами работает корректно
- Агрегация статистики работает правильно
- Метрики рассчитываются корректно (totalChecks, maxScoreCount, successRate, averageScore, difficultyLevel)
- Используются существующие GSI (дополнительные индексы не требуются)

<output_format>
После выполнения задачи должна быть создана функция для аналитики сложности золотых стихов. Функция должна использовать существующие GSI, корректно сопоставлять баллы со стихами и возвращать метрики сложности для каждого стиха.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Golden Verses Actions и Books Actions
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.9
- [DYNAMODB_SCHEMA.md](../../../database/DYNAMODB_SCHEMA.md) - раздел 3.16 Таблица Books, раздел 3.7 LessonGoldenVerses
- [GRAPHQL_SCHEMA.md](../../../database/GRAPHQL_SCHEMA.md) - тип Book
- [DATA_MODELING.md](../../../database/DATA_MODELING.md) - раздел 2.4 Golden Verses, access patterns AP-25, AP-26
- [ANALYTICS.md](../../../database/ANALYTICS.md) - раздел 2.5 Золотые стихи, раздел 4.4 Access Patterns AP-ANALYTICS-6, AP-ANALYTICS-7

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

