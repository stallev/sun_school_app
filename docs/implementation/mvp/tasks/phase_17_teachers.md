# Phase 17: Управление преподавателями (Teachers)

## Описание фазы
Реализация CRUD операций для преподавателей: создание, редактирование, деактивация. Назначение преподавателей на группы, управление через Cognito.

## Зависимости
Phase 05: Настройка аутентификации (Cognito), Phase 11: Управление группами (Grades)

## Оценка времени
5-6 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- AWS Cognito User Management
- TypeScript с строгой типизацией
- CRUD операции и управление данными
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, управление преподавателями критически важно, интеграция с Cognito обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления преподавателями. Правильная интеграция с AWS Cognito и реализация всех функций критически важна для работы системы аутентификации.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Используй Context7 для получения актуальной документации AWS Cognito Admin API
3. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
4. Изучи все связанные документы из раздела "Документация" перед выполнением задач
5. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
6. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Все операции с преподавателями доступны только для Admin. Создание пользователя в Cognito обязательно при создании преподавателя. Назначение на группы должно работать корректно.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 17.01: Создание Server Actions для преподавателей

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для преподавателей являются основой всего функционала управления преподавателями. Правильная реализация с интеграцией Cognito, проверкой прав доступа и валидацией критически важна для работы системы аутентификации.
</context>

<task>
Создай Server Actions для управления преподавателями в файле `actions/teachers.ts`. Реализуй все CRUD операции, назначение на группу и создание пользователя в Cognito с проверкой прав доступа и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа (Admin only)
- Создание пользователя в Cognito обязательно при создании преподавателя
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Users/Teachers для понимания требований к API
2. Изучи SECURITY.md раздел Cognito User Management для понимания работы с Cognito
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions и AWS Cognito
4. Определи структуру каждой функции с проверкой прав доступа
5. Продумай интеграцию с Cognito при создании преподавателя
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/teachers.ts` с директивой `'use server'`
- [ ] Реализовать CRUD операции: create, update, delete, get, list
- [ ] Реализовать `assignTeacherToGrade(teacherId, gradeId)` - назначение на группу
- [ ] Реализовать `createTeacherInCognito(input)` - создание пользователя в Cognito
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito (Admin only)
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Users/Teachers и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (группы, уроки) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[SECURITY.md](../../../infrastructure/SECURITY.md) - раздел Cognito User Management</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.1 Управление преподавателями</CRITICAL>
- Context7: Next.js 15.5.9 Server Actions документация
- Context7: AWS Cognito Admin API документация

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно (Admin only)
- Интеграция с Cognito работает
- Валидация работает корректно

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления преподавателями. Все функции должны иметь проверку прав доступа (Admin only) и валидацию через Zod схемы. Интеграция с Cognito должна работать при создании преподавателя.
</output_format>

---

### Task 17.02: Реализация создания пользователя в Cognito

<context>
<CRITICAL>Это критически важная задача для интеграции с Cognito!</CRITICAL> Создание пользователя в Cognito является обязательным шагом при создании преподавателя. Правильная реализация с добавлением в группу TEACHER критически важна для работы системы аутентификации.
</context>

<task>
Создай утилиту для создания пользователя в Cognito. Реализуй функцию, которая создает пользователя в Cognito User Pool, добавляет его в группу TEACHER и возвращает userId. Интегрируй с Server Action создания преподавателя.
</task>

<constraints>
- Функция должна создавать пользователя в Cognito User Pool через Admin API
- Пользователь должен добавляться в группу TEACHER
- Функция должна возвращать userId
- Обработка ошибок должна быть реализована
- Интеграция с Server Action должна работать корректно
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SECURITY.md раздел Cognito User Management для понимания работы с Cognito
2. Используй Context7 для получения актуальной документации AWS Cognito Admin API
3. Определи структуру функции и логику создания пользователя
4. Продумай обработку ошибок при создании пользователя
5. Только после этого создавай утилиту
</thinking>

**Действия:**
- [ ] Создать утилиту `lib/utils/cognito.ts` (или обновить существующую)
- [ ] Реализовать функцию `createCognitoUser(email, password, name)`:
  - Создает пользователя в Cognito User Pool через Admin API
  - Добавляет в группу TEACHER
  - Возвращает userId
- [ ] Интегрировать с Server Action создания преподавателя
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[SECURITY.md](../../../infrastructure/SECURITY.md) - раздел Cognito User Management</CRITICAL>
- <CRITICAL>AWS Cognito Admin API документация (через Context7)</CRITICAL>

**Критерии приемки:**
- Создание пользователя в Cognito работает корректно
- Пользователь добавляется в группу TEACHER
- Интеграция с Server Action работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть создана утилита для создания пользователя в Cognito. Функция должна работать корректно, создавая пользователя в Cognito и добавляя его в группу TEACHER. Интеграция с Server Action должна работать.
</output_format>

---

### Task 17.03: Создание UI для управления преподавателями

<context>
Страница списка преподавателей является основной точкой входа для работы с преподавателями. Правильная реализация с фильтрацией, поиском и действиями критически важна для удобства работы с преподавателями.
</context>

<task>
Создай страницу списка преподавателей. Реализуй Server Component для отображения списка преподавателей с фильтрацией, поиском. Добавь кнопки создания нового преподавателя и деактивации для Admin.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Фильтрация должна работать по поиску (имя, email)
- Кнопка создания нового преподавателя должна быть видна только для Admin
- Кнопка деактивации должна быть доступна для Admin
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Teachers List для понимания дизайна
2. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
3. Определи структуру данных для отображения списка преподавателей
4. Продумай логику фильтрации и поиска
5. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/teachers/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Реализовать таблицу со списком преподавателей
- [ ] Добавить фильтрацию и поиск (по имени, email)
- [ ] Добавить кнопку создания нового преподавателя (Admin only)
- [ ] Добавить кнопку деактивации преподавателя (Admin only)
- [ ] Использовать компоненты Shadcn UI (Table, Input, Button)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Teachers List</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Admin flows
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 2.1 Создание нового преподавателя
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Страница списка создана
- Фильтрация работает корректно
- Кнопки работают для Admin

<output_format>
После выполнения задачи должна быть создана страница списка преподавателей. Список должен отображаться с фильтрацией и поиском. Все функции должны работать корректно.
</output_format>

---

### Task 17.04: Создание формы создания преподавателя

<context>
Форма создания преподавателя является ключевым компонентом для управления преподавателями. Правильная реализация с интеграцией Cognito, валидацией и выбором групп критически важна для обеспечения целостности данных.
</context>

<task>
Создай Client Component формы для создания преподавателя. Реализуй форму с полями: имя, email, пароль, группы. Интегрируй с React Hook Form и Zod валидацией. При создании создавай пользователя в Cognito.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Все поля должны быть валидированы через Zod схемы
- Пароль должен соответствовать требованиям Cognito
- Выбор групп должен быть множественным
- При создании должен создаваться пользователь в Cognito через Server Action
- Используй компоненты Shadcn UI (Form, Input, Select, Button)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Teacher Form для понимания дизайна
2. Изучи VALIDATION.md раздел User Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Определи структуру формы и логику создания пользователя в Cognito
5. Только после этого создавай компонент формы
</thinking>

**Действия:**
- [ ] Создать Client Component `components/admin/teachers/teacher-form.tsx`
- [ ] Реализовать форму с полями: имя, email, пароль, группы
- [ ] Интегрировать с React Hook Form
- [ ] Добавить Zod валидацию через @hookform/resolvers
- [ ] Добавить множественный выбор групп через MultiSelect или Checkbox
- [ ] При создании создавать пользователя в Cognito через Server Action
- [ ] Использовать компоненты Shadcn UI (Form, Input, Select, Button, Dialog)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Teacher Form</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел User Schemas</CRITICAL>
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 2.1 Создание нового преподавателя
- Context7: React Hook Form документация
- Context7: Zod документация

**Критерии приемки:**
- Форма создана и работает
- Валидация работает для всех полей
- Создание в Cognito работает
- Выбор групп работает

<output_format>
После выполнения задачи должна быть создана форма создания преподавателя. Форма должна быть полностью функциональной с валидацией, выбором групп и интеграцией с Cognito. Компонент должен быть готов к использованию в страницах создания преподавателя.
</output_format>

---

### Task 17.05: Реализация назначения на группы

<context>
Назначение преподавателя на группы является важной функцией для управления преподавателями. Правильная реализация с множественным выбором групп и отображением в профиле критически важна для работы системы.
</context>

<task>
Создай компонент для назначения преподавателя на группы. Реализуй множественный выбор групп, сохранение назначений через Server Action и отображение групп преподавателя в профиле.
</task>

<constraints>
- Компонент должен позволять выбирать несколько групп
- Назначения должны сохраняться через Server Action `assignTeacherToGrade`
- Группы должны отображаться в профиле преподавателя
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.1 Назначение на группы для понимания требований
2. Определи структуру компонента и логику назначения на группы
3. Продумай отображение групп в профиле преподавателя
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для назначения на группы (можно интегрировать в форму преподавателя)
- [ ] Реализовать множественный выбор групп через MultiSelect или Checkbox
- [ ] Сохранить назначения через Server Action `assignTeacherToGrade`
- [ ] Отобразить группы преподавателя в профиле
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.1 Назначение на группы

**Критерии приемки:**
- Назначение на группы работает корректно
- Группы отображаются в профиле преподавателя
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент для назначения преподавателя на группы. Назначение должно работать корректно, группы должны отображаться в профиле преподавателя.
</output_format>

---

### Task 17.06: Реализация деактивации преподавателя

<context>
Деактивация преподавателя является критически важной операцией, которая требует подтверждения. Правильная реализация с деактивацией в Cognito и обновлением статуса в базе данных критически важна для безопасности системы.
</context>

<task>
Реализуй Server Action деактивации преподавателя. Деактивируй пользователя в Cognito (если требуется), обнови статус в базе данных и добавь подтверждение деактивации через Dialog.
</task>

<constraints>
- Деактивация должна выполняться через Server Action
- Пользователь должен деактивироваться в Cognito (если требуется)
- Статус должен обновляться в базе данных
- Подтверждение деактивации должно быть реализовано через Dialog
- Обработка ошибок должна быть реализована
- Проверка прав доступа должна выполняться (Admin only)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.1 Деактивация преподавателя для понимания требований
2. Изучи SECURITY.md для понимания работы с Cognito
3. Определи логику деактивации в Cognito и базе данных
4. Продумай UI для подтверждения деактивации
5. Только после этого реализуй деактивацию
</thinking>

**Действия:**
- [ ] Реализовать Server Action `deactivateTeacher(teacherId)` (Admin only)
- [ ] Деактивировать пользователя в Cognito через Admin API (если требуется)
- [ ] Обновить статус в базе данных через amplifyData
- [ ] Добавить подтверждение деактивации через Dialog
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.1 Деактивация преподавателя</CRITICAL>
- [SECURITY.md](../../../infrastructure/SECURITY.md)
- Context7: AWS Cognito Admin API документация

**Критерии приемки:**
- Деактивация работает корректно
- Пользователь деактивируется в Cognito
- Статус обновляется в базе данных
- Подтверждение показывается через Dialog
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция деактивации преподавателя. Деактивация должна работать корректно, пользователь должен деактивироваться в Cognito, статус должен обновляться в базе данных. Подтверждение должно показываться через Dialog.
</output_format>

---

### Task 17.07: Тестирование функционала преподавателей

<context>
Тестирование функционала преподавателей является финальным этапом фазы. Комплексное тестирование всех функций, CRUD операций, интеграции с Cognito, назначения на группы и деактивации критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления преподавателями. Протестируй CRUD операции, создание в Cognito, назначение на группы и деактивацию для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции управления преподавателями
- Тестирование должно выполняться для роли Admin
- CRUD операции должны быть протестированы
- Создание в Cognito должно быть протестировано
- Назначение на группы должно быть протестировано
- Деактивация должна быть протестирована
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовый аккаунт Admin
4. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать CRUD операции (create, update, delete, get, list)
- [ ] Протестировать создание в Cognito
- [ ] Протестировать назначение на группы
- [ ] Протестировать деактивацию преподавателя
- [ ] Протестировать проверку прав доступа (Admin only)
- [ ] Протестировать валидацию форм
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для Admin
- CRUD операции работают корректно
- Создание в Cognito работает
- Назначение на группы работает
- Деактивация работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления преподавателями. Все функции должны работать корректно, CRUD операции должны работать, интеграция с Cognito должна работать, назначение на группы и деактивация должны работать. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Teachers Actions
- [SECURITY.md](../../../infrastructure/SECURITY.md) - Cognito Management
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.1

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

