# Phase 18: Управление семьями (Families)

## Описание фазы
Реализация CRUD операций для семей: создание, редактирование, удаление. Связывание учеников с семьями, управление контактами семьи.

## Зависимости
Phase 16: Управление учениками (Pupils)

## Оценка времени
4-5 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- CRUD операции и управление данными
- Связи между сущностями (семьи, ученики)
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, управление семьями критически важно, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления семьями. Правильная реализация CRUD операций, управления членами семьи и контактами критически важна для работы системы.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию
6. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**

<CONSTRAINT>Все операции с семьями доступны только для Admin. Управление членами семьи должно работать корректно. Контакты семьи должны валидироваться.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 18.01: Создание Server Actions для семей

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для семей являются основой всего функционала управления семьями. Правильная реализация с проверкой прав доступа, управлением членами семьи и валидацией критически важна для работы системы.
</context>

<task>
Создай Server Actions для управления семьями в файле `actions/families.ts`. Реализуй все CRUD операции, добавление и удаление учеников из семьи с проверкой прав доступа и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа (Admin only)
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
- Управление членами семьи должно работать корректно
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Families для понимания требований к API
2. Изучи VALIDATION.md раздел Family Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа
5. Продумай логику управления членами семьи
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/families.ts` с директивой `'use server'`
- [ ] Реализовать CRUD операции: create, update, delete, get, list
- [ ] Реализовать `addPupilToFamily(familyId, pupilId)` - добавление ученика в семью
- [ ] Реализовать `removePupilFromFamily(familyId, pupilId)` - удаление ученика из семьи
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito (Admin only)
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Families и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (члены семьи, ученики) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Family Schemas</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.3 Управление семьями</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/families.ts](../../../../src/lib/validation/families.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getFamily, listFamilies)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createFamily, updateFamily)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для семей
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте вложенные запросы для получения FamilyMember с данными family и pupil
- FamilyMember содержит вложенные данные family и pupil благодаря @belongsTo
- UserFamily содержит вложенные данные user и family благодаря @belongsTo
- Не требуются отдельные запросы для получения связанных данных

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно (Admin only)
- Валидация работает корректно
- Управление членами семьи работает

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления семьями. Все функции должны иметь проверку прав доступа (Admin only) и валидацию через Zod схемы. Управление членами семьи должно работать корректно.
</output_format>

---

### Task 18.02: Создание UI для списка семей

<context>
Страница списка семей является основной точкой входа для работы с семьями. Правильная реализация с отображением количества членов семьи, фильтрацией и поиском критически важна для удобства работы с семьями.
</context>

<task>
Создай страницу списка семей. Реализуй Server Component для отображения списка семей с количеством членов семьи, фильтрацией и поиском. Добавь кнопку создания новой семьи для Admin.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Отображай количество членов семьи для каждой семьи
- Фильтрация должна работать по поиску (название семьи)
- Кнопка создания новой семьи должна быть видна только для Admin
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Families List для понимания дизайна
2. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
3. Определи структуру данных для отображения списка семей с количеством членов
4. Продумай логику фильтрации и поиска
5. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/families/page.tsx`
- [ ] Реализовать Server Component для загрузки данных через Server Action
- [ ] Реализовать таблицу со списком семей
- [ ] Отобразить количество членов семьи для каждой семьи
- [ ] Добавить фильтрацию и поиск (по названию семьи)
- [ ] Добавить кнопку создания новой семьи (Admin only)
- [ ] Использовать компоненты Shadcn UI (Table, Input, Button)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Families List</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Admin flows
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 5.1 Создание новой семьи
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Next.js 15.5.9 App Router документация

**Критерии приемки:**
- Страница списка создана
- Количество членов семьи отображается
- Фильтрация работает корректно
- Кнопка создания работает для Admin

<output_format>
После выполнения задачи должна быть создана страница списка семей. Список должен отображаться с количеством членов семьи, фильтрацией и поиском. Все функции должны работать корректно.
</output_format>

---

### Task 18.03: Создание формы создания/редактирования семьи

<context>
Форма создания и редактирования семьи является ключевым компонентом для управления семьями. Правильная реализация с валидацией email и телефона критически важна для обеспечения целостности данных.
</context>

<task>
Создай Client Component формы для создания и редактирования семьи. Реализуй форму с полями: название семьи, телефон, email, адрес (опционально). Интегрируй с React Hook Form и Zod валидацией. Добавь валидацию email и телефона.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Все поля должны быть валидированы через Zod схемы
- Email должен валидироваться на корректный формат
- Телефон должен валидироваться на корректный формат
- Адрес должен быть опциональным
- Используй компоненты Shadcn UI (Form, Input, Button)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Family Form для понимания дизайна
2. Изучи VALIDATION.md раздел Family Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Определи структуру формы и логику валидации email и телефона
5. Только после этого создавай компонент формы
</thinking>

**Действия:**
- [ ] Создать Client Component `components/admin/families/family-form.tsx`
- [ ] Реализовать форму с полями: название семьи, телефон, email, адрес (опционально)
- [ ] Интегрировать с React Hook Form
- [ ] Добавить Zod валидацию через @hookform/resolvers
- [ ] Добавить валидацию email на корректный формат
- [ ] Добавить валидацию телефона на корректный формат
- [ ] Использовать компоненты Shadcn UI (Form, Input, Button, Dialog)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Family Form</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Family Schemas</CRITICAL>
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 5.1 Создание новой семьи
- Context7: React Hook Form документация
- Context7: Zod документация

**Критерии приемки:**
- Форма создана и работает
- Валидация работает для всех полей
- Валидация email и телефона работает корректно
- Форма интегрирована с Server Actions

<output_format>
После выполнения задачи должна быть создана форма создания и редактирования семьи. Форма должна быть полностью функциональной с валидацией email и телефона. Компонент должен быть готов к использованию в страницах создания и редактирования семьи.
</output_format>

---

### Task 18.04: Реализация управления членами семьи

<context>
Управление членами семьи является важной функцией для работы с семьями. Правильная реализация с добавлением и удалением учеников из семьи критически важна для корректности данных о семьях.
</context>

<task>
Создай компонент для управления членами семьи. Реализуй добавление учеников в семью, удаление учеников из семьи и отображение списка всех членов семьи.
</task>

<constraints>
- Компонент должен позволять добавлять учеников в семью
- Компонент должен позволять удалять учеников из семьи
- Список всех членов семьи должен отображаться
- Используй Server Actions для добавления и удаления
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.3 Управление членами семьи для понимания требований
2. Определи структуру компонента и логику управления членами
3. Продумай отображение списка членов семьи
4. Только после этого создавай компонент
</thinking>

**Действия:**
- [ ] Создать компонент для управления членами семьи `components/admin/families/family-members.tsx`
- [ ] Реализовать добавление учеников в семью через Server Action `addPupilToFamily`
- [ ] Реализовать удаление учеников из семьи через Server Action `removePupilFromFamily`
- [ ] Отобразить список всех членов семьи
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.3 Управление членами семьи

**Критерии приемки:**
- Управление членами работает корректно
- Добавление учеников в семью работает
- Удаление учеников из семьи работает
- Список членов отображается корректно
- Обработка ошибок работает

<output_format>
После выполнения задачи должен быть создан компонент для управления членами семьи. Добавление и удаление учеников должно работать корректно, список членов семьи должен отображаться.
</output_format>

---

### Task 18.05: Реализация управления контактами

<context>
Управление контактами семьи необходимо для связи с семьями. Правильное отображение и редактирование контактов критически важно для работы с семьями.
</context>

<task>
Реализуй отображение контактов семьи в профиле семьи. Реализуй редактирование контактов с валидацией. Контакты должны включать телефон, email и адрес.
</task>

<constraints>
- Контакты должны отображаться в профиле семьи
- Редактирование контактов должно работать через форму
- Валидация контактов должна выполняться (email, телефон)
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.10.3 Контакты семьи для понимания требований
2. Определи структуру отображения контактов в профиле
3. Продумай логику редактирования контактов
4. Только после этого реализуй управление контактами
</thinking>

**Действия:**
- [ ] Отобразить контакты семьи в профиле семьи (телефон, email, адрес)
- [ ] Реализовать редактирование контактов через форму
- [ ] Добавить валидацию контактов (email, телефон) через Zod схемы
- [ ] Обновить контакты через Server Action `updateFamily`
- [ ] Добавить обработку ошибок

**Документация:**
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.3 Контакты семьи

**Критерии приемки:**
- Контакты отображаются корректно в профиле семьи
- Редактирование контактов работает
- Валидация контактов работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должно быть реализовано управление контактами семьи. Контакты должны отображаться в профиле семьи, редактирование должно работать с валидацией.
</output_format>

---

### Task 18.06: Тестирование функционала семей

<context>
Тестирование функционала семей является финальным этапом фазы. Комплексное тестирование всех функций, CRUD операций, управления членами семьи и контактами критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления семьями. Протестируй CRUD операции, управление членами семьи и управление контактами для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции управления семьями
- Тестирование должно выполняться для роли Admin
- CRUD операции должны быть протестированы
- Управление членами семьи должно быть протестировано
- Управление контактами должно быть протестировано
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовый аккаунт Admin
4. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать CRUD операции (create, update, delete, get, list)
- [ ] Протестировать управление членами семьи (добавление, удаление)
- [ ] Протестировать управление контактами (отображение, редактирование)
- [ ] Протестировать проверку прав доступа (Admin only)
- [ ] Протестировать валидацию форм
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для Admin
- CRUD операции работают корректно
- Управление членами семьи работает
- Управление контактами работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления семьями. Все функции должны работать корректно, CRUD операции должны работать, управление членами семьи и контактами должны работать. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Families Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Family Schemas
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.10.3

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

