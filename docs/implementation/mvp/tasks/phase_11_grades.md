# Phase 11: Управление группами (Grades)

## Описание фазы
Реализация CRUD операций для групп (Grades): создание, редактирование, просмотр, удаление. Server Actions, UI компоненты, проверка прав доступа.

## Зависимости
Phase 10: Создание системы валидации

## Оценка времени
5-6 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Системы управления доступом (RBAC)
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, проверка прав доступа критически важна, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для управления группами. Правильная реализация с проверкой прав доступа определит безопасность всей системы.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию

<CONSTRAINT>Проверка прав доступа обязательна для всех операций с группами. Admin может выполнять все операции, Teacher может только просматривать свои группы.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 11.01: Создание Server Actions для групп

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для групп являются основой всего функционала управления группами. Правильная реализация с проверкой прав доступа определит безопасность системы. Все операции должны быть защищены и валидированы.
</context>

<task>
Создай Server Actions для управления группами в файле `src/actions/grades.ts`. Реализуй все CRUD операции с проверкой прав доступа и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа
- Admin может выполнять все операции (create, update, delete, get, list)
- Teacher может только просматривать свои группы (get, list с фильтрацией)
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Grades для понимания требований к API
2. Изучи VALIDATION.md раздел Grade Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Изучи примеры Server Actions из других фаз для понимания паттернов
5. Определи структуру каждой функции с проверкой прав доступа через Cognito
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [x] Создать `src/actions/grades.ts` с директивой `'use server'`
- [x] Реализовать `createGrade(input)` - создание группы (Admin only)
- [x] Реализовать `updateGrade(input)` - обновление группы (Admin only)
- [x] Реализовать `deleteGrade(id)` - удаление группы (Admin only)
- [x] Реализовать `getGrade(id)` - получение группы с проверкой доступа
- [x] Реализовать `listGrades()` - список групп (Teacher видит только свои, Admin - все)
- [x] Добавить проверку прав доступа в каждую функцию через Cognito
- [x] Использовать валидацию через Zod схемы для всех входных данных

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Grades</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Grade Schemas</CRITICAL>
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.1 Группы
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/grades.ts](../../../../src/lib/validation/grades.ts) - схемы валидации для групп
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getGrade, listGrades)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createGrade, updateGrade, deleteGrade)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для групп
  - [src/graphql/mutations.ts](../../../../src/graphql/mutations.ts) - GraphQL мутации для групп
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Важно:** После реализации оптимизации GraphQL схемы используйте вложенные запросы вместо множественных:
- getGradeWithNestedData() - один запрос вместо ~110
- Данные содержат все связанные сущности включая files для уроков

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно
- Валидация работает корректно
- Все функции возвращают правильные discriminated unions

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления группами. Все функции должны иметь проверку прав доступа через Cognito и валидацию через Zod схемы. Код должен быть готов к использованию в компонентах и соответствовать паттернам проекта.
</output_format>

---

### Task 11.02: Создание страницы списка групп

<context>
Страница списка групп является основной точкой входа для работы с группами. Для Admin это возможность управлять всеми группами, для Teacher - просмотр своей группы. Правильная реализация с учетом прав доступа критически важна.
</context>

<task>
Создай страницы списка групп для Admin и Teacher. Реализуй Server Components для отображения списка групп с учетом прав доступа. Для Teacher создай редирект на свою группу.
</task>

<constraints>
- Используй Server Components по умолчанию
- Admin видит все группы через `app/(private)/grades/page.tsx`
- Teacher перенаправляется на свою группу через `app/(private)/grades/my/page.tsx`
- Используй Data Access Layer (amplifyData) для получения данных
- Проверка прав доступа должна выполняться на сервере
- Используй компоненты Shadcn UI для отображения
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Grades List для понимания дизайна
2. Изучи USER_FLOW.md раздел Teacher/Admin flows для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Определи структуру данных для отображения списка групп
5. Продумай логику редиректа для Teacher
6. Только после этого создавай страницы
</thinking>

**Действия:**
- [x] Создать `app/(private)/grades/page.tsx` (для Admin)
- [x] Создать `app/(private)/grades/my/page.tsx` (для Teacher - редирект на свою группу)
- [x] Реализовать Server Component для отображения списка групп
- [x] Использовать Data Access Layer для получения данных через Server Actions
- [x] Добавить проверку прав доступа на сервере
- [ ] Добавить фильтрацию и поиск (если требуется)
- [ ] Добавить пагинацию (если требуется)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Grades List</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Teacher/Admin flows
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 2.1 Вход в систему и навигация
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 3.1 Создание новой группы
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.1
- [ISR Optimization Guidelines](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md) - оптимизация производительности страниц через ISR
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных групп
  - [src/lib/validation/grades.ts](../../../../src/lib/validation/grades.ts) - для валидации форм

**Критерии приемки:**
- Страница списка групп создана
- Teacher видит только свои группы (через редирект)
- Admin видит все группы
- Данные загружаются корректно
- Проверка прав доступа работает
- Страница использует ISR с `revalidate = 60` для оптимизации производительности

<output_format>
После выполнения задачи должны быть созданы страницы списка групп для Admin и Teacher. Teacher должен автоматически перенаправляться на свою группу. Все данные должны загружаться через Server Components с проверкой прав доступа.
</output_format>

---

### Task 11.03: Создание страницы просмотра группы

<context>
Страница просмотра группы является центральной точкой для работы с группой. Здесь отображается вся информация о группе, преподавателях, учениках и статистика. Правильное отображение информации и доступность действий критически важны для пользовательского опыта.
</context>

<task>
Создай страницу просмотра группы с динамическим маршрутом. Реализуй Server Component для отображения полной информации о группе, включая преподавателей, учеников и статистику. Добавь кнопки действий с учетом прав доступа.
</task>

<constraints>
- Используй Server Component для загрузки данных
- Отображай: название, описание, преподавателей, учеников, статистику
- Кнопка "Настройки" должна быть видна только для Admin
- Все кнопки должны вести на соответствующие страницы
- Используй компоненты Shadcn UI (Card, Badge, Button)
- Проверка прав доступа должна выполняться на сервере
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Grade Detail для понимания дизайна
2. Изучи USER_FLOW.md раздел Grade View для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 динамических маршрутов
4. Определи структуру данных для отображения информации о группе
5. Продумай логику отображения кнопок в зависимости от роли пользователя
6. Только после этого создавай страницу
</thinking>

**Действия:**
- [x] Создать `app/(private)/grades/[gradeId]/page.tsx`
- [x] Реализовать Server Component для отображения информации о группе
- [x] Загрузить данные группы через Server Action `getGrade(gradeId)`
- [ ] Отобразить: название, описание, преподавателей, учеников, статистику
- [x] Добавить кнопки действий: "Создать урок", "Настройки" (Admin only), "Расписание"
- [x] Использовать компоненты Shadcn UI (Card, Badge, Button)
- [x] Добавить проверку прав доступа перед отображением страницы

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Grade Detail</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Grade View
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md) - раздел 2.1 Вход в систему и навигация
- [ISR Optimization Guidelines](../../../guidelines/nextjs/ai_isr_optimization_guidelines.md) - оптимизация производительности страниц через ISR
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Next.js 15.5.9 динамические маршруты документация
- **Код реализации:**
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - для получения данных группы

**Критерии приемки:**
- Страница просмотра группы создана
- Вся информация отображается корректно
- Кнопки действий работают и отображаются согласно правам доступа
- Проверка прав доступа работает
- Страница использует ISR с `revalidate = 60` и `generateStaticParams` для оптимизации производительности

<output_format>
После выполнения задачи должна быть создана страница просмотра группы с полной информацией. Все данные должны загружаться через Server Component, кнопки должны работать и отображаться согласно правам доступа пользователя.
</output_format>

---

### Task 11.04: Создание формы создания/редактирования группы

<context>
Форма создания и редактирования группы является ключевым компонентом для управления группами. Правильная реализация с валидацией и обработкой ошибок критически важна для обеспечения целостности данных и хорошего пользовательского опыта.
</context>

<task>
Создай Client Component формы для создания и редактирования группы. Реализуй форму с полями: название, описание, minAge, maxAge. Интегрируй с React Hook Form и Zod валидацией. Добавь обработку ошибок и loading state.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Форма должна работать как для создания, так и для редактирования
- Все поля должны быть валидированы через Zod схемы
- Используй React Hook Form для управления формой
- Добавь обработку ошибок с понятными сообщениями
- Добавь loading state во время отправки формы
- Используй компоненты Shadcn UI (Form, Input, Button, Dialog)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Grade Form для понимания дизайна
2. Изучи VALIDATION.md раздел Grade Schemas для понимания схем валидации
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Изучи примеры форм из других фаз для понимания паттернов
5. Определи структуру формы и логику работы в режиме создания/редактирования
6. Только после этого создавай компонент формы
</thinking>

**Действия:**
- [x] Создать Client Component `components/teacher/grades/grade-form.tsx` (или `components/admin/grades/grade-form.tsx`)
- [x] Реализовать форму с полями: название, описание, minAge, maxAge
- [x] Интегрировать с React Hook Form
- [x] Добавить Zod валидацию через @hookform/resolvers
- [x] Добавить обработку ошибок с отображением сообщений
- [x] Добавить loading state во время отправки формы
- [x] Использовать компоненты Shadcn UI (Form, Input, Button, Dialog)
- [x] Интегрировать форму с Server Actions (createGrade, updateGrade)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Grade Form</CRITICAL>
- <CRITICAL>[VALIDATION.md](../../../api/VALIDATION.md) - раздел Grade Schemas</CRITICAL>
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 3.1 Создание новой группы
- [COMPONENT_LIBRARY.md](../../../components/COMPONENT_LIBRARY.md)
- Context7: React Hook Form документация
- Context7: Zod документация
- **Код реализации:**
  - [src/lib/validation/grades.ts](../../../../src/lib/validation/grades.ts) - схемы валидации для форм
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Критерии приемки:**
- Форма создана и работает
- Валидация работает корректно для всех полей
- Форма интегрирована с Server Actions
- Обработка ошибок работает
- Loading state отображается корректно

<output_format>
После выполнения задачи должна быть создана форма создания и редактирования группы. Форма должна быть полностью функциональной с валидацией, обработкой ошибок и интеграцией с Server Actions. Компонент должен быть готов к использованию в страницах создания и редактирования группы.
</output_format>

---

### Task 11.05: Создание страницы создания новой группы

<context>
Страница создания новой группы является точкой входа для администраторов для добавления новых групп в систему. Правильная реализация с проверкой прав доступа и интеграцией формы критически важна для обеспечения безопасности и удобства использования.
</context>

<task>
Создай Server Component страницу для создания новой группы. Реализуй страницу с проверкой прав доступа (только Admin) и интеграцией формы создания из Task 11.04. Добавь обработку успешного создания с редиректом на страницу созданной группы.
</task>

<constraints>
- Используй Server Component для проверки прав доступа
- Страница должна быть доступна только для Admin
- Используй форму из Task 11.04 в режиме создания
- После успешного создания выполни редирект на страницу созданной группы
- Обработка ошибок должна быть реализована на уровне формы
- Используй маршрут `/grades/new` (уже определен в RoutePath.ts)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Grade Form для понимания дизайна страницы создания
2. Изучи USER_FLOW.md раздел Admin flows для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 App Router
4. Изучи примеры страниц создания из других фаз для понимания паттернов
5. Определи структуру страницы и логику проверки прав доступа
6. Продумай интеграцию с формой из Task 11.04
7. Только после этого создавай страницу
</thinking>

**Действия:**
- [x] Создать `app/(private)/grades/new/page.tsx`
- [x] Реализовать Server Component для проверки прав доступа (только Admin)
- [x] Добавить проверку аутентификации и роли через Cognito
- [x] Реализовать редирект для неавторизованных пользователей или не-Admin
- [x] Интегрировать форму создания из Task 11.04
- [x] Реализовать обработку успешного создания с редиректом на страницу группы
- [x] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Grade Form</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Admin flows
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 3.1 Создание новой группы
- [Loading Patterns Guidelines](../../../guidelines/nextjs/ai_loading_patterns.md) - guidelines for loading states and skeleton components
- Context7: Next.js 15.5.9 App Router документация
- **Код реализации:**
  - [src/lib/routes/RoutePath.ts](../../../../src/lib/routes/RoutePath.ts) - маршруты приложения
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/actions/grades.ts](../../../../src/actions/grades.ts) - Server Actions для групп
  - [components/teacher/grades/grade-form.tsx](../../../../components/teacher/grades/grade-form.tsx) или [components/admin/grades/grade-form.tsx](../../../../components/admin/grades/grade-form.tsx) - форма из Task 11.04

**Критерии приемки:**
- Страница создания группы создана
- Проверка прав доступа работает корректно (только Admin)
- Форма интегрирована и работает
- Редирект после успешного создания работает
- Обработка ошибок работает корректно

<output_format>
После выполнения задачи должна быть создана страница создания новой группы. Страница должна быть доступна только для Admin, использовать форму из Task 11.04 и выполнять редирект на страницу созданной группы после успешного создания.
</output_format>

---

### Task 11.06: Создание страницы редактирования группы

<context>
Страница редактирования группы позволяет администраторам изменять данные существующих групп. Правильная реализация с загрузкой данных, проверкой прав доступа и интеграцией формы критически важна для обеспечения целостности данных и удобства использования.
</context>

<task>
Создай Server Component страницу для редактирования группы. Реализуй страницу с проверкой прав доступа (только Admin), загрузкой данных группы через Server Action и интеграцией формы редактирования из Task 11.04. Добавь обработку успешного обновления с редиректом на страницу группы.
</task>

<constraints>
- Используй Server Component для проверки прав доступа и загрузки данных
- Страница должна быть доступна только для Admin
- Загрузи данные группы через Server Action `getGrade(gradeId)`
- Обработай случай несуществующей группы (404)
- Используй форму из Task 11.04 в режиме редактирования с предзаполненными данными
- После успешного обновления выполни редирект на страницу группы
- Обработка ошибок должна быть реализована на уровне формы
- Используй маршрут `/grades/[gradeId]/edit` (уже определен в RoutePath.ts)
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Grade Form для понимания дизайна страницы редактирования
2. Изучи USER_FLOW.md раздел Admin flows для понимания пользовательских сценариев
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 динамических маршрутов
4. Изучи примеры страниц редактирования из других фаз для понимания паттернов
5. Определи структуру страницы и логику загрузки данных
6. Продумай интеграцию с формой из Task 11.04 с предзаполненными данными
7. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/grades/[gradeId]/edit/page.tsx`
- [ ] Реализовать Server Component для проверки прав доступа (только Admin)
- [ ] Добавить проверку аутентификации и роли через Cognito
- [ ] Реализовать редирект для неавторизованных пользователей или не-Admin
- [ ] Загрузить данные группы через Server Action `getGrade(gradeId)`
- [ ] Обработать случай несуществующей группы (notFound)
- [ ] Интегрировать форму редактирования из Task 11.04 с предзаполненными данными
- [ ] Реализовать обработку успешного обновления с редиректом на страницу группы
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Grade Form</CRITICAL>
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Admin flows
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 3.1 Создание новой группы
- Context7: Next.js 15.5.9 динамические маршруты документация
- **Код реализации:**
  - [src/lib/routes/RoutePath.ts](../../../../src/lib/routes/RoutePath.ts) - маршруты приложения
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/actions/grades.ts](../../../../src/actions/grades.ts) - Server Actions для групп (getGrade, updateGrade)
  - [components/teacher/grades/grade-form.tsx](../../../../components/teacher/grades/grade-form.tsx) или [components/admin/grades/grade-form.tsx](../../../../components/admin/grades/grade-form.tsx) - форма из Task 11.04
  - [src/app/(private)/grades/[gradeId]/page.tsx](../../../../src/app/(private)/grades/[gradeId]/page.tsx) - пример Server Component страницы

**Критерии приемки:**
- Страница редактирования группы создана
- Проверка прав доступа работает корректно (только Admin)
- Данные группы загружаются корректно
- Обработка 404 для несуществующих групп работает
- Форма интегрирована с предзаполненными данными и работает
- Редирект после успешного обновления работает
- Обработка ошибок работает корректно

<output_format>
После выполнения задачи должна быть создана страница редактирования группы. Страница должна быть доступна только для Admin, загружать данные группы через Server Action, использовать форму из Task 11.04 с предзаполненными данными и выполнять редирект на страницу группы после успешного обновления.
</output_format>

---

### Task 11.07: Реализация проверки прав доступа

<context>
<CRITICAL>Это критически важная задача для безопасности системы!</CRITICAL> Проверка прав доступа к группам должна быть реализована на всех уровнях: в Server Actions, утилитах и компонентах. Правильная реализация защитит систему от несанкционированного доступа.
</context>

<task>
Создай утилиту для проверки доступа к группе. Реализуй функцию проверки прав доступа, которая определяет, может ли пользователь работать с конкретной группой. Используй утилиту в Server Actions и компонентах.
</task>

<constraints>
- Утилита должна проверять роль пользователя через Cognito
- Teacher может видеть и работать только со своими группами
- Admin может видеть и работать со всеми группами
- Проверка должна выполняться на сервере
- Функция должна возвращать boolean или выбрасывать ошибку
- Утилита должна использоваться во всех Server Actions и компонентах, работающих с группами
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SECURITY.md раздел RBAC для понимания системы прав доступа
2. Изучи MVP_SCOPE.md раздел 2.1.2 Роли пользователей для понимания ролей
3. Используй Context7 для получения актуальной документации AWS Cognito
4. Изучи примеры проверки прав доступа из других фаз
5. Определи структуру функции проверки доступа
6. Продумай логику определения принадлежности группы Teacher
7. Только после этого создавай утилиту
</thinking>

**Действия:**
- [x] Создать утилиту `lib/utils/grades.ts` для проверки доступа к группе
  - ⚠️ **Частично выполнено**: Файл существует, но содержит только утилиты сериализации
- [ ] Реализовать функцию `checkGradeAccess(userId, gradeId, userRole)`:
  - ⚠️ **Частично выполнено**: Функция `checkTeacherGradeAccess(userId, gradeId)` реализована в `src/actions/grades.ts`, но:
    - Не принимает `userRole` как параметр
    - Не проверяет роль через Cognito внутри функции (проверка выполняется в Server Actions)
    - Не возвращает `true` для Admin автоматически
  - Проверяет роль пользователя через Cognito
  - Для Teacher проверяет принадлежность группы
  - Для Admin всегда возвращает true
  - Возвращает boolean или выбрасывает ошибку
- [ ] Реализовать функцию `getUserGrades(userId)` для получения групп Teacher
  - ⚠️ **Частично выполнено**: Функция `getTeacherGradeIds(userId)` реализована в `src/actions/grades.ts`, но:
    - Возвращает только ID групп, а не полные объекты
    - Находится в `src/actions/grades.ts`, а не в утилите
- [x] Использовать утилиту в Server Actions (createGrade, updateGrade, deleteGrade, getGrade, listGrades)
  - ✅ **Выполнено**: Функции используются в `getGradeAction`, `listGradesAction`, `getGradeWithFullDataAction`
  - ⚠️ **Проблема**: Функции определены внутри `src/actions/grades.ts`, а не импортируются из утилиты
- [ ] Использовать утилиту в компонентах при необходимости
  - ⚠️ **Не выполнено**: Компоненты не используют утилиту (возможно, не требуется)

**Документация:**
- <CRITICAL>[SECURITY.md](../../../infrastructure/SECURITY.md) - раздел RBAC</CRITICAL>
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 3.1 Создание новой группы
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.1.2 Роли пользователей</CRITICAL>
- Context7: AWS Cognito документация
- **Код реализации:**
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа через Cognito

**Критерии приемки:**
- ✅ Проверка прав доступа работает корректно
- ✅ Teacher ограничен своими группами
- ✅ Admin имеет доступ ко всем группам
- ⚠️ Утилита используется во всех Server Actions (функции реализованы, но не в утилите)
- ✅ Ошибки доступа обрабатываются правильно

**Статус выполнения:**
- **Частично выполнено** (60%): Функциональность реализована и работает корректно, но не соответствует архитектурным требованиям
- **Критичность для MVP: СРЕДНЯЯ** (не блокирует запуск, но требует рефакторинга)

**Оценка критичности нереализованного функционала:**

**Низкая критичность для MVP:**
- ✅ **Безопасность работает корректно**: Проверка доступа реализована и функционирует правильно
- ✅ **Teacher ограничен своими группами**: Функция `checkTeacherGradeAccess` корректно проверяет доступ
- ✅ **Admin имеет полный доступ**: Логика проверки роли работает через `checkRole(user, ['ADMIN', 'SUPERADMIN'])`
- ✅ **Ошибки обрабатываются**: Все Server Actions корректно обрабатывают ошибки доступа

**Проблемы (не критично для MVP, но требует рефакторинга):**
- ⚠️ **Дублирование кода**: Функции определены внутри `src/actions/grades.ts` вместо централизованной утилиты
- ⚠️ **Несоответствие требованиям**: Сигнатуры функций не соответствуют требованиям задачи
- ⚠️ **Сложность поддержки**: Изменения в логике проверки доступа требуют правок в нескольких местах
- ⚠️ **Отсутствие переиспользования**: Функции нельзя использовать в других модулях без дублирования

**Рекомендации:**
- Для MVP: **Можно оставить как есть** - функционал работает, безопасность обеспечена
- Для production: **Требуется рефакторинг** - вынести функции в утилиту `lib/utils/grades.ts` для улучшения архитектуры и поддержки кода

<output_format>
После выполнения задачи должна быть создана утилита для проверки прав доступа к группам. Утилита должна быть интегрирована во все Server Actions и компоненты, работающие с группами. Проверка прав доступа должна работать корректно для всех ролей пользователей.
</output_format>

---

### Task 11.08: Тестирование функционала групп

<context>
Тестирование функционала групп является финальным этапом фазы. Комплексное тестирование всех функций, проверки прав доступа и валидации критически важно для обеспечения качества и безопасности системы.
</context>

<task>
Проведи комплексное тестирование всего функционала управления группами. Протестируй создание, редактирование, просмотр групп, проверку прав доступа и валидацию форм для всех ролей пользователей.
</task>

<constraints>
- Тестирование должно покрывать все функции управления группами
- Тестирование должно выполняться для всех ролей (Admin, Teacher)
- Проверка прав доступа должна быть протестирована для всех сценариев
- Валидация форм должна быть протестирована для всех полей
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Изучи USER_FLOW.md раздел Grade Management для понимания пользовательских сценариев
2. Подготовь тестовые данные для всех сценариев
3. Определи все тестовые случаи для каждой функции
4. Подготовь тестовые аккаунты для разных ролей
5. Только после этого начинай тестирование
</thinking>

**Действия:**
- [x] Протестировать создание группы (Admin)
- [x] Протестировать редактирование группы (Admin)
- [x] Протестировать удаление группы (Admin)
- [x] Протестировать просмотр группы (Teacher и Admin)
- [x] Протестировать список групп (Teacher видит только свои, Admin - все)
- [x] Протестировать проверку прав доступа для всех операций
- [x] Протестировать валидацию форм (все поля, все ошибки)
- [x] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md) - раздел Grade Management
- [TEACHER_FLOWS.md](../../../user_flows/TEACHER_FLOWS.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для всех ролей
- Права доступа проверяются правильно во всех сценариях
- Валидация работает для всех полей
- Ошибки обрабатываются корректно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала управления группами. Все функции должны работать корректно, права доступа должны проверяться правильно, валидация должна работать для всех полей. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Grades Actions
- [VALIDATION.md](../../../api/VALIDATION.md) - Grade Schemas
- [WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - Grade Pages
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.2.1

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

