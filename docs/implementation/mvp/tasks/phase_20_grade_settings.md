# Phase 20: Настройки оценивания групп

## Описание фазы
Реализация настроек оценивания для групп: включение/выключение параметров оценивания, настройка кастомных меток, настройка баллов за каждый параметр.

## Зависимости
Phase 11: Управление группами (Grades)

## Оценка времени
5-6 часов

## Требования к AI Agent

<requirements>
<role>
Ты — Senior Full-Stack Developer с 5+ летним опытом разработки, специализирующийся на:
- Next.js 15.5.9 Server Actions и App Router
- AWS Amplify Gen 1 и AppSync GraphQL
- TypeScript с строгой типизацией
- Настройки и конфигурация
- Интеграция настроек с функционалом
- Валидация данных через Zod
</role>

<context>
Проект: Sunday School Management System (MVP)
Технологии: Next.js 15.5.9, AWS Amplify Gen 1, DynamoDB, Cognito, Shadcn UI
Ограничения: MVP подход, настройки оценивания критически важны, совместимость с AWS Amplify Hosting обязательна
Версии: Next.js 15.5.9 (строго), React 19, TypeScript 5.x
</context>

<critical_instructions>
Вдохни глубоко, расправь плечи и приступай к решению задачи шаг за шагом. Это критически важная фаза для настроек оценивания групп. Правильная реализация настроек параметров оценивания, кастомных меток и баллов критически важна для работы системы оценивания.

<CRITICAL>Перед началом работы:</CRITICAL>
1. Используй Context7 для получения актуальной документации Next.js 15.5.9
2. Проверь совместимость каждого функционала Next.js с AWS Amplify Hosting - это высокоприоритетное требование
3. Изучи все связанные документы из раздела "Документация" перед выполнением задач
4. Следуй принципам из `docs/guidelines/prompts/general_prompt_guidelines.md`
5. Используй строго Next.js 15.5.9, не более новую версию
6. **При написании программного кода руководствуйся требованиями из документов каталогов `docs/guidelines/nextjs/` и `docs/guidelines/react/`**

<CONSTRAINT>Все операции с настройками доступны только для Admin. Настройки должны применяться к проверке ДЗ. Кастомные метки и баллы должны валидироваться.</CONSTRAINT>
</critical_instructions>
</requirements>

## Задачи

### Task 20.01: Создание Server Actions для настроек групп

<context>
<CRITICAL>Это критически важная задача!</CRITICAL> Server Actions для настроек групп являются основой системы настроек оценивания. Правильная реализация с проверкой прав доступа и валидацией критически важна для работы системы оценивания.
</context>

<task>
Создай Server Actions для управления настройками групп в файле `actions/gradeSettings.ts`. Реализуй получение и обновление настроек с проверкой прав доступа и валидацией через Zod схемы.
</task>

<constraints>
- Все операции должны иметь проверку прав доступа (Admin only)
- Используй Zod схемы для валидации всех входных данных
- Используй amplifyData для работы с базой данных
- Все функции должны возвращать discriminated unions: `{ success: true, data?: T } | { success: false, error: string }`
- Настройки должны включать параметры оценивания, кастомные метки и баллы
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи SERVER_ACTIONS.md раздел Grade Settings для понимания требований к API
2. Изучи MVP_SCOPE.md раздел 2.11 Настройки оценивания для понимания требований
3. Используй Context7 для получения актуальной документации Next.js 15.5.9 Server Actions
4. Определи структуру каждой функции с проверкой прав доступа
5. Продумай структуру данных настроек (параметры, метки, баллы)
6. Только после этого создавай Server Actions
</thinking>

**Действия:**
- [ ] Создать `actions/gradeSettings.ts` с директивой `'use server'`
- [ ] Реализовать `getGradeSettings(gradeId)` - получение настроек группы
- [ ] Реализовать `updateGradeSettings(gradeId, settings)` - обновление настроек
- [ ] Добавить проверку прав доступа в каждую функцию через Cognito (Admin only)
- [ ] Использовать валидацию через Zod схемы

**Документация:**
- <CRITICAL>[SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - раздел Grade Settings и раздел 6 "Working with Related Data via Indexes"</CRITICAL>
- ⚠️ **Важно:** Для получения связанных данных (группа) используй queries через индексы, а не прямые связи `@belongsTo` и `@hasMany`. См. [SCHEMA_DIFFERENCES.md](../../../database/SCHEMA_DIFFERENCES.md)
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11 Настройки оценивания</CRITICAL>
- [GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md](../../GRAPHQL_SCHEMA_OPTIMIZATION_ROADMAP.md) - оптимизация запросов
- Context7: Next.js 15.5.9 Server Actions документация
- **Код реализации:**
  - [src/lib/validation/gradeSettings.ts](../../../../src/lib/validation/gradeSettings.ts) - схемы валидации
  - [src/lib/db/queries.ts](../../../../src/lib/db/queries.ts) - функции запросов (getGradeSettings, listGradeSettings)
  - [src/lib/db/mutations.ts](../../../../src/lib/db/mutations.ts) - функции мутаций (createGradeSettings, updateGradeSettings)
  - [src/lib/db/amplify.ts](../../../../src/lib/db/amplify.ts) - Data Access Layer (amplifyData)
  - [src/lib/db/errors.ts](../../../../src/lib/db/errors.ts) - обработка ошибок Data Access Layer
  - [src/lib/auth/cognito.ts](../../../../src/lib/auth/cognito.ts) - проверка прав доступа
  - [src/graphql/queries.ts](../../../../src/graphql/queries.ts) - GraphQL запросы для настроек групп
  - [src/graphql/generated/types.ts](../../../../src/graphql/generated/types.ts) - TypeScript типы из GraphQL схемы
  - [src/lib/validation/common.ts](../../../../src/lib/validation/common.ts) - общие схемы валидации
  - [src/lib/validation/utils.ts](../../../../src/lib/validation/utils.ts) - утилиты для работы с валидацией

**Важно:** После реализации оптимизации GraphQL схемы:
- Используйте getGradeWithNestedData() для получения группы с настройками
- Grade содержит вложенные данные settings через @hasOne
- Не требуются отдельные запросы для получения настроек группы

**Критерии приемки:**
- Все Server Actions созданы
- Проверка прав доступа работает корректно (Admin only)
- Валидация работает корректно

<output_format>
После выполнения задачи должны быть созданы все Server Actions для управления настройками групп. Все функции должны иметь проверку прав доступа (Admin only) и валидацию через Zod схемы. Код должен быть готов к использованию в компонентах.
</output_format>

---

### Task 20.02: Создание UI для редактирования настроек

<context>
Форма редактирования настроек группы является ключевым компонентом для настройки параметров оценивания. Правильная реализация с чекбоксами для каждого параметра критически важна для работы системы оценивания.
</context>

<task>
Создай страницу редактирования настроек группы. Реализуй форму настроек с чекбоксами для каждого параметра оценивания. Интегрируй с React Hook Form и Zod валидацией.
</task>

<constraints>
- Используй Client Component (`'use client'`) для интерактивности
- Форма должна иметь чекбоксы для каждого параметра: Золотые стихи, Оценка за тест, Оценка за тетрадь, Посещение спевки
- Все поля должны быть валидированы через Zod схемы
- Используй компоненты Shadcn UI (Form, Checkbox, Input, Button)
- Проверка прав доступа должна выполняться на сервере
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи WIREFRAMES.md раздел Grade Settings для понимания дизайна
2. Изучи MVP_SCOPE.md раздел 2.11.1 Параметры оценивания для понимания требований
3. Используй Context7 для получения актуальной документации React Hook Form и Zod
4. Определи структуру формы и логику работы с настройками
5. Только после этого создавай страницу
</thinking>

**Действия:**
- [ ] Создать `app/(private)/grades/[gradeId]/settings/page.tsx`
- [ ] Реализовать Server Component для загрузки данных настроек
- [ ] Создать Client Component формы настроек
- [ ] Реализовать форму с чекбоксами для каждого параметра:
  - Золотые стихи (включено/выключено)
  - Оценка за тест (включено/выключено)
  - Оценка за тетрадь (включено/выключено)
  - Посещение спевки (включено/выключено)
- [ ] Интегрировать с React Hook Form и Zod валидацией
- [ ] Использовать компоненты Shadcn UI (Form, Checkbox, Input, Button)

**Документация:**
- <CRITICAL>[WIREFRAMES.md](../../../ui_ux/WIREFRAMES.md) - раздел Grade Settings</CRITICAL>
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11.1 Параметры оценивания</CRITICAL>
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md) - раздел 3.2 Настройка параметров оценивания группы
- Context7: React Hook Form документация
- Context7: Zod документация

**Критерии приемки:**
- Форма настроек создана и работает
- Чекбоксы работают корректно
- Валидация работает
- Форма интегрирована с Server Actions

<output_format>
После выполнения задачи должна быть создана страница редактирования настроек группы. Форма должна быть полностью функциональной с чекбоксами для каждого параметра и валидацией. Компонент должен быть готов к использованию.
</output_format>

---

### Task 20.03: Реализация кастомных меток

<context>
Кастомные метки необходимы для настройки отображения параметров оценивания в проверке ДЗ. Правильная реализация с сохранением меток и отображением в форме проверки ДЗ критически важна для кастомизации системы оценивания.
</context>

<task>
Добавь поля для кастомных меток каждого параметра оценивания в форму настроек. Реализуй сохранение меток через Server Action. Отобрази метки в форме проверки ДЗ вместо стандартных названий параметров.
</task>

<constraints>
- Кастомные метки должны быть доступны для каждого параметра оценивания
- Метки должны сохраняться через Server Action `updateGradeSettings`
- Метки должны отображаться в форме проверки ДЗ вместо стандартных названий
- Валидация меток должна быть реализована (максимальная длина, допустимые символы)
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.11.2 Кастомные метки для понимания требований
2. Определи структуру данных для кастомных меток
3. Продумай логику сохранения и отображения меток
4. Только после этого реализуй кастомные метки
</thinking>

**Действия:**
- [ ] Добавить поля для кастомных меток каждого параметра в форму настроек
- [ ] Реализовать сохранение меток через Server Action `updateGradeSettings`
- [ ] Обновить форму проверки ДЗ для отображения кастомных меток вместо стандартных названий
- [ ] Добавить валидацию меток (максимальная длина, допустимые символы)
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11.2 Кастомные метки</CRITICAL>

**Критерии приемки:**
- Кастомные метки работают корректно
- Метки сохраняются через Server Action
- Метки отображаются в проверке ДЗ
- Валидация меток работает
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция кастомных меток. Метки должны сохраняться и отображаться в форме проверки ДЗ вместо стандартных названий параметров.
</output_format>

---

### Task 20.04: Реализация настройки баллов

<context>
Настройка баллов за каждый параметр необходима для кастомизации системы оценивания. Правильная реализация с валидацией баллов и использованием в расчете критически важна для корректности системы оценивания.
</context>

<task>
Добавь поля для настройки баллов за каждый параметр оценивания в форму настроек. Реализуй валидацию баллов (положительные числа). Сохрани настройки баллов и используй их в расчете баллов при проверке ДЗ.
</task>

<constraints>
- Баллы должны настраиваться для каждого параметра оценивания
- Валидация баллов должна требовать положительные числа
- Настройки баллов должны сохраняться через Server Action `updateGradeSettings`
- Настройки баллов должны использоваться в расчете баллов при проверке ДЗ (Task 14.03, Task 15.01)
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.11.3 Настройка баллов для понимания требований
2. Определи структуру данных для настройки баллов
3. Продумай логику валидации и сохранения баллов
4. Продумай интеграцию с расчетом баллов в проверке ДЗ
5. Только после этого реализуй настройку баллов
</thinking>

**Действия:**
- [ ] Добавить поля для настройки баллов за каждый параметр в форму настроек
- [ ] Реализовать валидацию баллов (положительные числа) через Zod схемы
- [ ] Сохранить настройки баллов через Server Action `updateGradeSettings`
- [ ] Обновить расчет баллов в проверке ДЗ (Task 14.03, Task 15.01) для использования настроек баллов
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11.3 Настройка баллов</CRITICAL>

**Критерии приемки:**
- Настройка баллов работает корректно
- Валидация баллов работает (положительные числа)
- Баллы сохраняются через Server Action
- Баллы используются в расчете при проверке ДЗ
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована функция настройки баллов. Баллы должны настраиваться для каждого параметра, валидироваться и использоваться в расчете баллов при проверке ДЗ.
</output_format>

---

### Task 20.05: Интеграция с проверкой ДЗ

<context>
<CRITICAL>Это критически важная задача для интеграции настроек!</CRITICAL> Интеграция настроек оценивания с проверкой ДЗ является обязательной для работы системы оценивания. Правильная реализация с применением всех настроек критически важна для корректности системы.
</context>

<task>
Обнови форму проверки ДЗ для интеграции с настройками группы. Реализуй отображение только включенных параметров, использование кастомных меток и использование настроек баллов для расчета.
</task>

<constraints>
- Форма проверки ДЗ должна показывать только включенные параметры из настроек группы
- Кастомные метки должны использоваться вместо стандартных названий параметров
- Настройки баллов должны использоваться в расчете баллов
- Интеграция должна работать без перезагрузки страницы
- Обработка ошибок должна быть реализована
</constraints>

<thinking>
Прежде чем приступить к реализации:
1. Изучи MVP_SCOPE.md раздел 2.4 Проверка домашних заданий для понимания требований
2. Изучи форму проверки ДЗ из Task 14.02
3. Определи логику применения настроек к форме проверки ДЗ
4. Продумай интеграцию с расчетом баллов
5. Только после этого обновляй форму проверки ДЗ
</thinking>

**Действия:**
- [ ] Обновить форму проверки ДЗ (Task 14.02):
  - Загружать настройки группы при загрузке формы
  - Показывать только включенные параметры из настроек группы
  - Использовать кастомные метки вместо стандартных названий параметров
  - Использовать настройки баллов для расчета (обновить Task 14.03, Task 15.01)
- [ ] Протестировать интеграцию
- [ ] Добавить обработку ошибок

**Документация:**
- <CRITICAL>[MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.4 Проверка домашних заданий</CRITICAL>
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11 Настройки оценивания

**Критерии приемки:**
- Интеграция работает корректно
- Только включенные параметры отображаются
- Кастомные метки используются
- Настройки баллов применяются в расчете
- Обработка ошибок работает

<output_format>
После выполнения задачи должна быть реализована интеграция настроек оценивания с проверкой ДЗ. Все настройки должны применяться корректно: только включенные параметры отображаются, кастомные метки используются, настройки баллов применяются в расчете.
</output_format>

---

### Task 20.06: Тестирование функционала настроек

<context>
Тестирование функционала настроек является финальным этапом фазы. Комплексное тестирование всех функций, включения/выключения параметров, кастомных меток, настройки баллов и интеграции с проверкой ДЗ критически важно для обеспечения качества системы.
</context>

<task>
Проведи комплексное тестирование всего функционала настроек оценивания. Протестируй включение/выключение параметров, кастомные метки, настройку баллов и интеграцию с проверкой ДЗ для всех сценариев.
</task>

<constraints>
- Тестирование должно покрывать все функции настроек оценивания
- Тестирование должно выполняться для роли Admin
- Включение/выключение параметров должно быть протестировано
- Кастомные метки должны быть протестированы
- Настройка баллов должна быть протестирована
- Интеграция с проверкой ДЗ должна быть протестирована
- Все ошибки должны обрабатываться корректно
</constraints>

<thinking>
Прежде чем приступить к тестированию:
1. Подготовь тестовые данные для всех сценариев
2. Определи все тестовые случаи для каждой функции
3. Подготовь тестовый аккаунт Admin
4. Только после этого начинай тестирование
</thinking>

**Действия:**
- [ ] Протестировать включение/выключение параметров оценивания
- [ ] Протестировать кастомные метки (создание, редактирование, отображение)
- [ ] Протестировать настройку баллов (валидация, сохранение, использование)
- [ ] Протестировать интеграцию с проверкой ДЗ (отображение параметров, метки, расчет баллов)
- [ ] Протестировать проверку прав доступа (Admin only)
- [ ] Протестировать валидацию форм
- [ ] Протестировать обработку ошибок

**Документация:**
- [USER_FLOW.md](../../../user_flows/USER_FLOW.md)
- [ADMIN_FLOWS.md](../../../user_flows/ADMIN_FLOWS.md)

**Критерии приемки:**
- Все тесты пройдены успешно
- Функционал работает корректно для Admin
- Включение/выключение параметров работает
- Кастомные метки работают
- Настройка баллов работает
- Интеграция с проверкой ДЗ работает
- Ошибки обрабатываются правильно

<output_format>
После выполнения задачи должно быть проведено комплексное тестирование всего функционала настроек оценивания. Все функции должны работать корректно, включение/выключение параметров, кастомные метки и настройка баллов должны работать. Интеграция с проверкой ДЗ должна работать. Система должна быть готова к использованию.
</output_format>

---

## Ссылки на документацию проекта

- [SERVER_ACTIONS.md](../../../api/SERVER_ACTIONS.md) - Grade Settings Actions
- [MVP_SCOPE.md](../../../MVP_SCOPE.md) - раздел 2.11

---

## ⚠️ Важно: Проверка дублирующих ресурсов

**После завершения фазы обязательно выполните проверку на наличие дублирующих AWS ресурсов:**

```bash
# Linux/Mac
./scripts/check-duplicate-resources.sh eu-west-1

# Windows
.\scripts\check-duplicate-resources.ps1 eu-west-1
```

**Почему это важно:**
- Предотвращает создание дублирующих ресурсов (AppSync API, Cognito User Pools, DynamoDB таблицы, CloudFormation стеки)
- Помогает обнаружить проблемы на раннем этапе
- Снижает неожиданные затраты на AWS

**Если обнаружены дублирующие ресурсы:**
- См. [DUPLICATE_RESOURCES_INCIDENT.md](../../../infrastructure/DUPLICATE_RESOURCES_INCIDENT.md) для инструкций по устранению
- Следуйте [BRANCH_SETUP_CHECKLIST.md](../../../infrastructure/BRANCH_SETUP_CHECKLIST.md) при подключении новых веток

---

**Версия:** 1.0  
**Последнее обновление:** 23 декабря 2025

